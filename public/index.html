<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WA Engenharia – Analisador</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
  <style>
   /* Reset básico e fontes */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Roboto', sans-serif;
}

/* Corpo e layout */
body {
  display: flex;
  min-height: 100vh;
  background: #ffffff;
  color: #333;
  font-size:15px; ;
}

/* Menu lateral */
.sidebar {
  width: 240px;
  min-height: 100vh;
  background: linear-gradient(to bottom, #1a1a1a, #333);
  color: #fff;
  padding: 30px 20px;
}

.sidebar h2 {
  margin-bottom: 30px;
  font-size: 22px;
  
}

.sidebar ul {
  list-style: none;
}

.sidebar ul li {
  margin-bottom: 15px;
}

.sidebar ul li a {
  color: #ccc;
  text-decoration: none;
  font-size: 16px;
  display: block;
  padding: 10px;
  border-radius: 6px;
  transition: 0.3s;
}

.sidebar ul li a:hover {
  background: #444;
  color: #fff;
}

/* Conteúdo principal */
.main-content {
  flex: 1;
  padding: 40px;
  background-color: #fff;
  overflow-y: auto;
}

/* Cartão de formulário */
.form-card {
  background: #1f1f1f;
  color: #f0f0f0;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  max-width: 1000px;
  margin: 0 auto;
}

.form-card h1 {
  text-align: center;
  margin-bottom: 30px;
  color: #3d4952;
}

/* Formulários */
label {
  display: block;
  margin-bottom: 1%;
  font-weight: bold;
  color: #ccc;
}

input[type="text"],
input[type="email"],
input[type="tel"],
select,
textarea {
  width: 100%;
 
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #444;
  background-color: #2a2a2a;
  color: #fff;
  font-size: 14px;
}

.form-group {
  margin-bottom: 10px;
}

.row {
   display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 10px
}
.container-principal {
  max-width: 960px;
  margin: 40px auto;
  padding: 30px;
  background-color: #1c1c1c;
  border-radius: 12px;

}
/* Colunas flexíveis */
.col-100 {
  flex: 0 0 100%;
}
.col-66 {
  flex: 0 0 65.9%;
}
.col-50 {
  flex: 0 0 48.8%;
}
.col-33 {
  flex: 0 0 31.7%;
}
.col-25 {
  flex: 0 0 23.2%;
  min-width: 150px;
}

/* Botões */
button {
   background-color: #3d4952;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.3s;
  margin-left: 10px;
}

button:hover {
  background-color: #58636b;
}

/* Passos do formulário */
.step {
  display: none;
}

.step.active {
  display: block;
}

/* Modal Produto */
.modal-escuro {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(10, 10, 10, 0.8);
  z-index: 1000;
}

.modal-conteudo {
  background: #222;
  color: #fff;
  padding: 30px;
  width: 90%;
  max-width: 500px;
  margin: 100px auto;
  border-radius: 12px;
  position: relative;
}

.fechar-modal {
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 22px;
  cursor: pointer;
}

/* Tabela */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  margin-bottom: 15px;
  text-align: center;
  font-size: 13px;
}

th, td {
  padding: 10px;
  border: 1px solid #444;
  text-align: left;
}

th {
  background-color: #2c2c2c;
  color: #fff;
  text-align: center;
}

td {
  background-color: #1f1f1f;
  color: #fff;
}

/* Títulos de seção */
h1 {
  color: #c5c8cd;
  margin: 5px 0 10px;
  font-size: 24px;
}

h2 {
    font-size: 22px;
  font-weight: bold;
  color: #cfd8dc;
  margin-bottom: 10px;
}

h3 {
    font-size: 16px;
  font-weight: bold;
  color: #cfd8dc;
  margin-bottom: 10px;
}

h4 {
  color: #c5c8cd;
  margin: 5px 0 10px;
  font-size: 14px;
}

label {
  font-size: 14px;
  font-weight: 500;
  color: #ccc;
  display: block;
  margin-bottom: 4px;
}

/* Campo somente leitura */
input.readonly-clone[readonly] {
  background-color: #111 !important;
  color: #bbb !important;
  border: 1px solid #333 !important;
}

select {
  appearance: none; /* remove a seta padrão */
  -webkit-appearance: none;
  -moz-appearance: none;

  background-color: #1e1e1e;
  color: white;

  padding: 10px 36px 10px 12px;
  border: 1px solid #444;
  border-radius: 6px;

  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 16px;
  font-size: 13px;
}

/* Tooltip */
.tooltip-info {
  cursor: help;
  margin-left: 5px;
}

/* Responsivo */
@media (max-width: 768px) {
  .col-50, .col-33, .col-66, .col-25, .col-100 {
    flex: 0 0 100%;
  }

  .main-content {
    padding: 20px;
  }

  .sidebar {
    width: 100%;
    min-height: auto;
  }

  .form-card {
    padding: 2%
  }
}
.titulo-superior {
  position: absolute;
  top: 6px;
  right: 40px;
  z-index: 10;
}

.titulo-superior h1 {
  font-size: 20px;
  color: #000000; /* Cor da paleta que você escolheu */
  font-weight: 700;
  margin: 0;
}
/* Estiliza cabeçalho da tabela */
#tabelaProdutos thead th {
  background-color: #111;
  color: #ffffff;
  font-weight: bold;
  text-align: center;
  padding: 10px;
  border-bottom: 1px solid #333;
}

/* Estiliza células do corpo da tabela */
#tabelaProdutos tbody td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #333;
}

/* Bordas arredondadas no cabeçalho */
#tabelaProdutos thead th:first-child {
  border-top-left-radius: 6px;
}
#tabelaProdutos thead th:last-child {
  border-top-right-radius: 6px;
}

/* Efeito hover na linha */
#tabelaProdutos tbody tr:hover {
  background-color: #2a2a2a;
}
.matriz-bloco th {
  background-color: #111;
  color: #ffffff;
  font-weight: bold;
  text-align: center;
  padding: 10px;
  border-bottom: 1px solid #333;
}
.resumo-produto {
  width: 100%;
  margin-top: 10px;
  border-collapse: collapse;
}

.resumo-produto th, .resumo-produto td {
  border: 1px solid #444;
  padding: 8px;
  text-align: left;
}

.resumo-produto th {
  background-color: #111;
  color: #fff;
}

.resumo-produto td {
  background-color: #1a1a1a;
  color: #eee;
}
/* Estilo padrão para todas as tabelas */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

table th, table td {
  border: 1px solid #333;
  padding: 8px;
  text-align: center;
}

table th {
  background-color: #111;
  color: #ffffff; /* mesmo tom azulado usado na segunda imagem */
  font-weight: 600;
}

table td {
  background-color: #1c1c1c;
  color: #fff;
}

/* Para o título da seção */
h4 {
  margin-top: 30px;
  color: #ffffff;
}
.form-input {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #444;
  background-color: #1e1e1e;
  color: #fff;
}
#step2,#step3,#step4,#step5 {
  max-width: 900px; /* ou 800px se quiser mais compacto */
  margin: 0 auto;   /* centraliza horizontalmente */
  padding: 20px;
}
#step1 {
  max-width: 900px;
  margin: 0 auto; /* centraliza sem espaço lateral */
  padding: 10px 20px; /* padding mais compacto */
}
#step1.form-card {
  width: 100%;
  max-width: 700px;
  margin: 0 auto;
  padding: 20px 20px;
}
#step1 .col-33 {
  flex: 0 0 31%;
  min-width: 180px;
}

#step1 .col-50 {
  flex: 0 0 48%;
  min-width: 180px;
}

#step1 .row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>WA Engenharia</h2>
    <ul>
      <li><a href="#" id="projetos">Projetos</a></li>
      <div id="listaProjetos"></div>
      <li><a href="#">Dashboard</a></li>
      <li><a href="#">Produtos</a></li>
      <li><a href="#">Investimentos</a></li>
      <li><a href="#">Projeções</a></li>
      <li><a href="#">Análise</a></li>
    </ul>
  </div>
  <div class="titulo-superior">
  <h1>Analisador de Viabilidade Econômica</h1>
</div>
  <div class="main-content">
    <div class="form-card">
     
      <!-- ETAPA 01 - DADOS GERAIS DO PROJETO -->
      <div class="step active" id="step1">
  <h2>Dados Gerais do Projeto</h2>
 <div class="row">
  <div class="form-group col-50">
    <label for="nome">Nome do Projeto/Empresa:</label>
    <input type="text" id="nome" name="nome" required>
  </div>
  <div class="form-group col-50">
    <label for="responsavel">Responsável:</label>
    <input type="text" id="responsavel" name="responsavel" required>
  </div>
   </div>
  <div class="row">
    <div class="form-group col-33">
      <label for="tipo">Tipo de Atividade:</label>
      <select id="tipo" name="tipo" required>
        <option value="">Selecione...</option>
        <option value="Construção Civil">Construção Civil</option>
        <option value="Serviços Técnicos Profissionais">Serviços Técnicos Profissionais</option>
        <option value="Comércio e Varejo">Comércio e Varejo</option>
        <option value="Indústria e Produção">Indústria e Produção</option>
        <option value="Estética, Saúde e Bem-Estar">Estética, Saúde e Bem-Estar</option>
        <option value="Eventos, Campeonatos e Produções">Eventos, Campeonatos e Produções</option>
        <option value="Negócios Digitais e Tecnologia">Negócios Digitais e Tecnologia</option>
        <option value="Alimentação, Bares e Delivery">Alimentação, Bares e Delivery</option>
        <option value="Franquias e Modelos Licenciados">Franquias e Modelos Licenciados</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="estado">Estado:</label>
      <select id="estado" name="estado" required></select>
    </div>

    <div class="form-group col-33">
      <label for="cidade">Cidade:</label>
      <select id="cidade" name="cidade" required></select>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-33">
      <label for="estrutura">
  Estrutura:
  <span class="tooltip-info" title="Tipo de estrutura do seu negócio: Física (presencial), Virtual (online), ou Híbrida (ambos)">ℹ️</span>
</label>
<select id="estrutura" name="estrutura" required>
  <option value="">Selecione...</option>
  <option value="Física">Física</option>
  <option value="Virtual">Virtual</option>
  <option value="Híbrida">Híbrida</option>
</select>
</div>

<div class="form-group col-33">
  <label for="regime">
    Regime Tributário:
    <span class="tooltip-info" title="Selecione o regime tributário da empresa, se já tiver CNPJ. Se ainda estiver no planejamento, selecione 'Não definido'.">ℹ️</span>
  </label>
  <select id="regime" name="regime">
    <option value="">Não se aplica / Não definido</option>
    <option value="MEI">MEI</option>
    <option value="Simples Nacional">Simples Nacional</option>
    <option value="Lucro Presumido">Lucro Presumido</option>
    <option value="Lucro Real">Lucro Real</option>
  </select>
</div>

    <div class="form-group col-33">
      <label for="situacao">Situação Atual:</label>
      <select id="situacao" name="situacao" required>
        <option value="">Selecione...</option>
        <option value="Planejamento">Planejamento</option>
        <option value="Em operação">Em operação</option>
        <option value="Em expansão">Em expansão</option>
      </select>
    </div>
  </div>



 <div class="row">
  <div class="form-group col-66">
    <label for="email">E-mail:</label>
    <input type="email" id="email" name="email" required>
  </div>

  <div class="form-group col-33">
    <label for="telefone">Telefone:</label>
    <input type="tel" id="telefone" name="telefone" placeholder="(00) 00000-0000" required>
  </div>
</div>
</div>


<script>
    // Lista de estados e cidades (exemplo parcial)
  const estadosECidades = {
  "AC": ["Rio Branco", "Cruzeiro do Sul", "Sena Madureira"],
  "AL": ["Maceió", "Arapiraca", "Palmeira dos Índios"],
  "AP": ["Macapá", "Santana", "Laranjal do Jari"],
  "AM": ["Manaus", "Parintins", "Itacoatiara"],
  "BA": ["Salvador", "Feira de Santana", "Vitória da Conquista"],
  "CE": ["Fortaleza", "Caucaia", "Juazeiro do Norte"],
  "DF": ["Brasília"],
  "ES": ["Vitória", "Vila Velha", "Serra"],
  "GO": ["Goiânia", "Aparecida de Goiânia", "Anápolis"],
  "MA": ["São Luís", "Imperatriz", "Caxias"],
  "MT": ["Cuiabá", "Várzea Grande", "Rondonópolis"],
  "MS": ["Campo Grande", "Dourados", "Três Lagoas"],
  "MG": ["Belo Horizonte", "Uberlândia", "Contagem"],
  "PA": ["Belém", "Santarém", "Ananindeua"],
  "PB": ["João Pessoa", "Campina Grande", "Patos"],
  "PR": ["Curitiba", "Londrina", "Maringá"],
  "PE": ["Recife", "Jaboatão dos Guararapes", "Olinda"],
  "PI": ["Teresina", "Parnaíba", "Picos"],
  "RJ": ["Rio de Janeiro", "Niterói", "Duque de Caxias"],
  "RN": ["Natal", "Mossoró", "Parnamirim"],
  "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas"],
  "RO": ["Porto Velho", "Ji-Paraná", "Ariquemes"],
  "RR": ["Boa Vista"],
  "SC": ["Florianópolis", "Joinville", "Blumenau"],
  "SP": ["São Paulo", "Campinas", "Santos"],
  "SE": ["Aracaju", "Nossa Senhora do Socorro", "Lagarto"],
  "TO": ["Palmas", "Araguaína", "Gurupi"]
};

  const estadoSelect = document.getElementById('estado');
  const cidadeSelect = document.getElementById('cidade');

  for (const estado in estadosECidades) {
    const option = document.createElement('option');
    option.value = estado;
    option.textContent = estado;
    estadoSelect.appendChild(option);
  }

  estadoSelect.addEventListener('change', () => {
    const cidades = estadosECidades[estadoSelect.value] || [];
    cidadeSelect.innerHTML = '';
    cidades.forEach(cidade => {
      const opt = document.createElement('option');
      opt.value = cidade;
      opt.textContent = cidade;
      cidadeSelect.appendChild(opt);
    });
  });

  // Máscara para telefone
  document.getElementById('telefone').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '').slice(0, 11);
    v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    e.target.value = v;
  });
  
</script>
 

<!-- ETAPA 02 COMPLETA (HTML + JS) -->
<div class="step" id="step2">
  <h2>Custos e Investimentos</h2>

  <!-- PRODUTOS -->
  <h3>1.1 Produto – Descrição do Produto</h3>
  <button type="button" onclick="abrirModalProduto()">+ Cadastrar Novo Produto</button>
  <table id="tabelaProdutos" style="margin-top:10px;width:100%;color:#fff;text-align:center;">
    <thead>
  <tr>
    <th style="text-align:center;">Produto</th>
    <th style="text-align:center;">Custo Direto (R$)</th>
    <th style="text-align:center;">Preço de Venda (R$)</th>
    <th style="text-align:center;">Custo Produção (%)</th>
    <th style="text-align:center;">Ações</th>
  </tr>
</thead>
    <tbody></tbody>
  </table>

  <!-- MODAL PRODUTO (ATUALIZADO) -->
<div id="modalProduto" class="modal-escuro">
  <div class="modal-conteudo">
    <span class="fechar-modal" onclick="fecharModalProduto()">×</span>
    <h3>Novo Produto</h3>

    <label style="margin-bottom: 6px;">Nome do Produto:</label>
    <input type="text" id="novoProdutoNome" style="margin-bottom: 16px;">

    <label style="margin-bottom: 6px;">Custo Direto (R$):</label>
    <input type="text" id="novoCustoMonetario" class="currency" placeholder="R$" style="margin-bottom: 16px;">

    <label style="margin-bottom: 6px;">Preço de Venda Pretendido (R$):</label>
    <input type="text" id="novoPrecoVenda" class="currency" placeholder="R$" style="margin-bottom: 16px;">

    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px;">
      <button type="button" onclick="abrirModalPreco()">Calcular Preço de Venda</button>
      <button type="button" onclick="salvarProduto()">Salvar</button>
      <button type="button" onclick="fecharModalProduto()">Cancelar</button>
    </div>
  </div>
</div>
  <!-- MODAL PREÇO VENDA (MAIOR JANELA) -->
  <div id="modalPreco" style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#222;padding:30px;border-radius:12px;z-index:2000;width:95%;max-width:700px;">
    <h3>Cálculo do Preço de Venda</h3>
    <label>Custos Totais (R$):</label>
    <input type="text" id="preco_custo_calc" class="currency"  placeholder="R$">
    <label>Margem de Lucro Desejada (%):</label>
    <input type="text" id="margem_lucro_calc" class="percent" placeholder="%">
    <label>Preço da Concorrência (R$):</label>
    <input type="text" id="concorrencia_calc" class="currency" placeholder="R$">
    <div style="text-align:right;margin-top:10px;">
      <button type="button" onclick="calcularPrecoVenda()">Calcular</button>
      <button type="button" onclick="fecharModalPreco()">Cancelar</button>
    </div>
  </div>
  

  <!-- INVESTIMENTO INICIAL -->
  <h3>2. Investimento Inicial</h3>
  <div class="row">
    <div class="form-group col-33"><label>Criação de Marca e Registro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Abertura de Empresa e Licenças (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Consultorias (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Estoque Inicial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Equipamentos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Imobilizados (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Capital de Giro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros Investimentos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>

  <!-- CUSTOS VARIÁVEIS -->
  <h3>3. Custos Variáveis</h3>
  <div class="row">
    <div id="area_custos_variaveis_produtos" class="col-100">
  <label style="color: #c5c8cd; font-weight: bold;">Custos Variáveis por Produto (%)</label>
  <div id="blocos_custos_variaveis_individuais" class="row" style="flex-direction: column; gap: 20px;"></div>
</div>

    <!-- Custos de Produção por Produto -->

  </div>

  <!-- CUSTOS FIXOS -->
  <h3>4. Custos Mensais Fixos</h3>
  <h4>Despesas Administrativas</h4>
  <div class="row">
    <div class="form-group col-50"><label>Aluguel (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Energia (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Salários (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Internet (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros Custos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Comerciais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Combustível (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Salários Equipe Comercial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Operacionais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Despesa 1 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Despesa 2 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
<!-- TAXA DESCONTO -->
  <h3>Taxas de Avaliação Financeira</h3>
<div class="row">
  <div class="form-group col-25">
    <label>Inflação Esperada (%):</label>
    <input type="text" id="taxa_inflacao" class="percent" placeholder="%">
  </div>
  <div class="form-group col-25">
    <label>Custo de Oportunidade (%):</label>
    <input type="text" id="taxa_oportunidade" class="percent" placeholder="%">
  </div>
  <div class="form-group col-25">
    <label>Retorno Esperado (%):</label>
    <input type="text" id="taxa_esperada" class="percent" placeholder="%">
  </div>
  <div class="form-group col-25">
    <label>TMA:</label>
    <input type="text" id="taxa_tma" class="percent" placeholder="%">
  </div>
</div>


  
  <!-- PLANO COMERCIAL -->
  <h3>5. Plano Comercial</h3>
  <label>Público-Alvo:</label><textarea rows="1" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Diferenciais do Produto:</label><textarea rows="1" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Possíveis Concorrentes:</label><textarea rows="1" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <div class="row">
  <div class="form-group col-33">
    <label>Taxa de Crescimento Mensal (%):</label>
    <input type="text" class="percent" placeholder="%">
  </div>
  </div>
</div>
<script>
let produtos = [];
let anosAdicionados = [];
</script>
<script>

function abrirModalProduto() {
  document.getElementById("modalProduto").style.display = 'block';
}
function fecharModalProduto() {
  document.getElementById("modalProduto").style.display = 'none';
  document.getElementById("novoProdutoNome").value = '';
  document.getElementById("novoCustoMonetario").value = '';
  // document.getElementById("novoCustoPercentual").value = ''; // Removido pois não existe esse campo
  document.getElementById("novoPrecoVenda").value = '';
}
function salvarProduto() {
  const nome = document.getElementById("novoProdutoNome").value;
  const custoR = document.getElementById("novoCustoMonetario").value;
  const precoVenda = document.getElementById("novoPrecoVenda").value;

  if (!nome || !precoVenda) {
    alert("Preencha pelo menos o nome do produto e o preço de venda.");
    return;
  }

  const novoProduto = { nome, custoR, precoVenda };

  if (indexProdutoEditando !== null) {
    produtos[indexProdutoEditando] = novoProduto;
    indexProdutoEditando = null;
  } else {
    produtos.push(novoProduto);
  }

  atualizarTabelaProdutos();
  fecharModalProduto();
  salvarNoStorage();
  reconstruirTodasMatrizes();
  salvarNoStorage();
  atualizarMargemMensalPorProduto();
  atualizarResumoPorProduto();
  atualizarPontoEquilibrio();
  atualizarCamposCustosVariaveisPorProduto();
  calcularCustosVariaveisEmReais();
  
}


function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  const volumeDiv = document.getElementById("volumeProdutos"); // Caso use essa parte
  const custoProdField = document.getElementById("auto_custo_prod"); // Campo automático de custos com produção

  tbody.innerHTML = "";
  if (volumeDiv) volumeDiv.innerHTML = "";

  let somaCustosDiretos = 0;
  let somaPrecosVenda = 0;

  // Função robusta para converter moeda para número
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }

  produtos.forEach((p, index) => {
    const custo = moedaParaNumero(p.custoR);
    const preco = moedaParaNumero(p.precoVenda);
    const percentual = preco > 0 ? (custo / preco) * 100 : 0;

    somaCustosDiretos += custo;
    somaPrecosVenda += preco;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td style="text-align:center;">${p.nome}</td>
      <td style="text-align:center;">${p.custoR}</td>
      <td style="text-align:center;">${p.precoVenda}</td>
      <td style="text-align:center;">${percentual.toFixed(1).replace('.', ',')}%</td>
      <td style="text-align:center;">
        <button type="button" onclick="editarProduto(${index})">Editar</button>
        <button type="button" onclick="removerProduto(${index})">Excluir</button>
      </td>
    `;
    tbody.appendChild(row);

    // Campo de volume por produto (caso deseje exibir)
    if (volumeDiv) {
      volumeDiv.innerHTML += `
        <div class="row" style="margin-bottom: 10px; align-items: center;">
          <div class="col-50"><label>${p.nome}</label></div>
          <div class="col-50">
            <input type="number" class="volumeProdutoInput" data-index="${index}" min="0" style="width: 100%; padding: 6px;" />
          </div>
        </div>
      `;
    }
  });

  // Cálculo final do campo automático de custo de produção (%)
  if (custoProdField) {
    const custoProducaoPercentual = somaPrecosVenda > 0 ? (somaCustosDiretos / somaPrecosVenda) * 100 : 0;
    custoProdField.value = custoProducaoPercentual.toFixed(1).replace('.', ',') + '%';
    // Atualiza dinamicamente os campos de produção para cada produto
produtos.forEach((p, index) => {
  const preco = moedaParaNumero(p.precoVenda);
  const custo = moedaParaNumero(p.custoR);
  const perc = preco > 0 ? (custo / preco) * 100 : 0;
  const campoProducao = document.getElementById(`producao_produto_${index}`);
  if (campoProducao) {
    campoProducao.value = perc.toFixed(2).replace('.', ',') + '%';
  }
});

  }

  // ✅ Exibir custo de produção por produto na seção de Custos Variáveis
  let blocoIndividual = document.getElementById("custos_individuais_area");
  if (blocoIndividual) {
    blocoIndividual.innerHTML = `
        <h4 style="color: #fff;">Custos de Produção Individuais (%)</h4>
    `;

    produtos.forEach((p) => {
      const custo = parseFloat(p.custoR.replace(/\./g, '').replace(',', '.')) || 0;
      const preco = parseFloat(p.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;
      const percentual = preco > 0 ? (custo / preco) * 100 : 0;

      blocoIndividual.innerHTML += `
        <div style="margin-bottom:4px;">
          <strong style="color:#fff;">${p.nome}</strong>: ${percentual.toFixed(1).replace('.', ',')}%
        </div>
      `;
    });
  }

  // --- Correção: sempre atualizar custos variáveis em R$ e campos dinâmicos ao atualizar produtos ---
  atualizarCustosFixosEVariaveis();
  atualizarCamposCustosVariaveisPorProduto();
  calcularCustosVariaveisEmReais();
  calcularCustosVariaveisAnual();
}
function atualizarCamposCustosVariaveisPorProduto() {
  const container = document.getElementById("blocos_custos_variaveis_individuais");
  if (!container) return;

  container.innerHTML = "";

  if (!produtos || produtos.length === 0) {
    // Se não há produtos, exibe uma mensagem amigável
    container.innerHTML = `<div style="color:#bbb; padding:10px;">Cadastre ao menos um produto para detalhar os custos variáveis.</div>`;
    return;
  }

  // Recupera valores salvos do sessionStorage
  let custosVariaveisSalvos = {};
  try {
    custosVariaveisSalvos = JSON.parse(sessionStorage.getItem("custosVariaveisPorProduto") || "{}");
  } catch {
    custosVariaveisSalvos = {};
  }

  produtos.forEach((p, i) => {
    const grupo = document.createElement("div");
    grupo.className = "row";
    grupo.style.flexWrap = "wrap";
    grupo.style.padding = "15px";
    grupo.style.borderRadius = "10px";
    grupo.style.marginBottom = "5px";
    grupo.style.marginTop= "5px";
    grupo.style.border = "1px solid #333"; // Adiciona a borda igual ao blocoProduto

    const titulo = document.createElement("h4");
    titulo.innerText = `Produto: ${p.nome}`;
    titulo.style = "width:100%; color:#fff  ; margin-bottom: 5px;margin-top: 3px;";
    grupo.appendChild(titulo);

    // Calcula o percentual de produção com base no cadastro do produto
    let custo = 0, preco = 0;
    if (p.custoR && p.precoVenda) {
      custo = parseFloat(String(p.custoR).replace(/\./g, '').replace(',', '.').replace('R$', '').trim()) || 0;
      preco = parseFloat(String(p.precoVenda).replace(/\./g, '').replace(',', '.').replace('R$', '').trim()) || 0;
    }
    const percentualProducao = preco > 0 ? (custo / preco) * 100 : 0;

    // Campos de custos variáveis por produto (sem máscara %, R$ ou outro)
    const campos = [
      { id: 'producao', label: 'Produção (%)', valor: percentualProducao.toFixed(2) + '%', className: 'percent', readonly: true, backgroundColor: '#000', color: '#bbb' },
      { id: 'imposto', label: 'Impostos (%)', valor: '', backgroundColor: '#2c2c2c', color: '#fff' },
      { id: 'comissao', label: 'Comissão Venda (%)', valor: '', backgroundColor: '#2c2c2c', color: '#fff' },
      { id: 'cartao', label: 'Tarifas Cartão (%)', valor: '', backgroundColor: '#2c2c2c', color: '#fff' },
      { id: 'outros', label: 'Outros Valores (%)', valor: '', backgroundColor: '#2c2c2c', color: '#fff' }
    ];

    campos.forEach(c => {
      const col = document.createElement("div");
      col.className = "form-group col-20";

      const label = document.createElement("label");
      label.innerText = c.label;
      label.style = "color:#bbb;";
      
      const input = document.createElement("input");
      input.type = "text";
      input.id = `${c.id}_produto_${i}`;
      input.className = "percent"; // Adiciona a classe percent

      // Recupera valor salvo, se houver, exceto para produção (readonly)
      if (!c.readonly && custosVariaveisSalvos && custosVariaveisSalvos[i] && custosVariaveisSalvos[i][c.id]) {
        input.value = custosVariaveisSalvos[i][c.id];
      } else {
        input.value = c.valor;
      }

      input.placeholder = "%";
      input.style = `background:${c.backgroundColor}; color:${c.color}; border:1px solid #444; width:100%;`;
      if (c.readonly) {
      input.readOnly = true;
      }

      // Máscara de percentual
      input.addEventListener('input', () => {
        let raw = input.value.replace(/\D/g, '');
        if (raw === '') {
          input.value = '';
          return;
        }
        let valor;
        if (raw.length <= 2) {
          valor = (parseInt(raw) / 10).toFixed(1).replace('.', ',');
        } else {
          valor = (parseInt(raw) / 100).toFixed(2).replace('.', ',');
        }
        input.value = valor;
        // Salva no sessionStorage ao digitar
        salvarCustosVariaveisProduto(i, c.id, input.value);
      });
      input.addEventListener('blur', () => {
        if (!input.value.includes('%') && input.value !== '') {
          input.value += '%';
        }
        // Salva no sessionStorage ao sair do campo
        salvarCustosVariaveisProduto(i, c.id, input.value);
      });

      col.appendChild(label);
      col.appendChild(input);
      grupo.appendChild(col);
    });

    container.appendChild(grupo);
  });

  // Função auxiliar para salvar no sessionStorage
  function salvarCustosVariaveisProduto(prodIndex, campo, valor) {
    let salvos = {};
    try {
      salvos = JSON.parse(sessionStorage.getItem("custosVariaveisPorProduto") || "{}");
    } catch {
      salvos = {};
    }
    if (!salvos[prodIndex]) salvos[prodIndex] = {};
    salvos[prodIndex][campo] = valor;
    sessionStorage.setItem("custosVariaveisPorProduto", JSON.stringify(salvos));
  }
}

// Garante atualização ao cadastrar produto
// Chame esta função após salvarProduto() e atualizarTabelaProdutos()

function obterCustosVariaveisEtapa02() {
  const parsePercentual = (id) => {
    return parseFloat(
      (document.getElementById(id)?.value || "0")
        .replace('%', '')
        .replace(",", ".")
        .trim()
    ) || 0;
  };

  const impostoPerc = parsePercentual("inputImpostoPercentualEtapa02");
  const comissaoPerc = parsePercentual("inputComissaoPercentualEtapa02");
  const cartaoPerc = parsePercentual("inputCartaoPercentualEtapa02");
  const outrosPerc = parsePercentual("inputOutrosPercentualEtapa02");

  return { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc };
}


function removerProduto(index) {
  produtos.splice(index, 1);
  atualizarTabelaProdutos();
  atualizarCamposCustosVariaveisPorProduto();
}
  let indexProdutoEditando = null;

function editarProduto(index) {
  const p = produtos[index];
  document.getElementById("novoProdutoNome").value = p.nome;
  document.getElementById("novoCustoMonetario").value = p.custoR;
  document.getElementById("novoPrecoVenda").value = p.precoVenda;

  indexProdutoEditando = index;
  document.getElementById("modalProduto").style.display = "block";
  reconstruirTodasMatrizes();
  salvarNoStorage();
  atualizarMargemMensalPorProduto();
  atualizarCamposCustosVariaveisPorProduto();
}

function abrirModalPreco() {
  document.getElementById("modalPreco").style.display = 'block';
}
function fecharModalPreco() {
  document.getElementById("modalPreco").style.display = 'none';
  indexProdutoEditando = null;
}
function calcularPrecoVenda() {
  const custo = parseFloat(document.getElementById("preco_custo_calc").value.replace(',', '.')) || 0;
  const margem = parseFloat(document.getElementById("margem_lucro_calc").value.replace(',', '.')) || 0;
  const precoCalculado = custo * (1 + margem / 100);
  document.getElementById("novoPrecoVenda").value = precoCalculado.toFixed(2).replace('.', ',');
  fecharModalPreco();
  reconstruirTodasMatrizes();
  calcularLucros();
  atualizarCamposCustosVariaveisPorProduto();
}
</script>

<!-- ETAPA 03 – Receita e Projeção de Lucro REFEITA -->
<div class="step" id="step3">
  <h2>Etapa 03 – Receita e Projeção de Lucro</h2>

  <!-- Botão para adicionar ano -->
  <div class="form-group col-100" style="text-align: right; margin-bottom: 20px;">
    <button type="button" onclick="adicionarAno()" style="padding: 10px 20px;  background-color: #3d4952; color: white; border: none; border-radius: 6px;">
      + Adicionar Ano
    </button>
  </div>

  <!-- Contêiner das Matrizes -->
  <div  class="#tabelaProdutos"
  id="containerMatrizes"></div>
  <!-- Resumo Receita de produtos -->
  <h4>Resumo por Produto</h4>
<table class="tabela-padrao">
  <thead>
    <tr>
      <th>Produto</th>
      <th>Quantidade</th>
      <th>Valor (R$)</th>
    </tr>
  </thead>
  <tbody id="resumo_vendas_produto"></tbody>
</table>

  <!-- Resultados -->
  <div class="row" style="margin-top: 30px;">
  <div class="form-group col-50">
    <label>Receita Bruta Total (R$):</label>
    <input type="text" id="receita_anual" class="currency readonly-clone" readonly 
      style="background-color: #111; color: #bbb; border: 1px solid #333;">
  </div>
  <div class="form-group col-50">
    <label>Receita Média Mensal (R$):</label>
    <input type="text" id="receita_mensal" class="currency readonly-clone" readonly 
      style="background-color: #111; color: #bbb; border: 1px solid #333;">
  </div>
</div>
<h3 style="color:#c5c8cd; width: 100%; margin-top: 20px;">Lucros</h3>
<div class="row">
  <div class="form-group col-50">
    <label>Lucro Anual (R$):</label>
    <input type="text" id="lucro_anual" class="currency readonly-clone" readonly 
      style="background-color: #111; color: #bbb; border: 1px solid #fff;">
  </div>
  <div class="form-group col-50">
    <label>Lucro Mensal (R$):</label>
    <input type="text" id="lucro_mensal" class="currency readonly-clone" readonly 
      style="background-color: #111; color: #bbb; border: 1px solid #fff;">
  </div>
</div>

  <!-- Toggle para usar cenários automáticos -->
  <h3>Cenários de Receita (Automáticos)</h3>
  <div class="form-group">
    <label>
      <input type="checkbox" id="toggleCenarios" onchange="atualizarToggleCenarios()"> Usar projeção por cenário (%)
    </label>
  </div>

  <div id="blocoCenarios" style="margin-top: 15px;"></div>
<div id="analise_investimento_percentual" style="width:100%; margin-top:20px;">
  <h3 style="color:#c5c8cd;">Distribuição Percentual do Investimento</h3>
  <div class="row" id="itens_percentuais_investimento"></div>
</div>

  <!-- Projeção de Custo -->
  <h3>Projeção de Custos</h3>
  <div class="row" style="display: flex; flex-wrap: wrap; gap: 20px;">
    <div class="form-group col-33" style="flex: 1 1 48%; min-width: 220px;">
      <label>Custos Fixos (R$):</label>
      <input type="text" id="custos_fixos_total" class="readonly-clone" readonly 
             style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;" 
             value="R$ 0,00">
    </div>
    <div class="form-group col-33" style="flex: 1 1 48%; min-width: 220px;">
      <label>Custo Fixo Anual (R$):</label>
      <input type="text" id="custos_fixos_anual" class="readonly-clone" readonly 
             style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;" 
             value="R$ 0,00">
    </div>
    <div class="form-group col-33" style="flex: 1 1 100%; min-width: 220px;">
      <label>Investimento Inicial (R$):</label>
      <input type="text" id="investimento_inicial" class="readonly-clone" readonly 
             style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;" 
             value="R$ 0,00">
    </div>
  
 <!-- Custos Variáveis - Detalhamento individual -->
      <div class="row" id="custos_variaveis_exibidos"></div>
   <div id="custos_variaveis_valores_rs" class="row" style="margin-top:10px;">
     <h3 style="color:#c5c8cd; width:100%;">Custos Variáveis Convertidos (R$)</h3>
    </div>
    <div id="custos_variaveis_anuais" class="row" style="margin-top:30px;">
  <h3 style="color:#c5c8cd; width:100%;">Custos Variáveis Anual (R$)</h3>
</div>

  </div>
</div>
<script>
  function calcularLucros() {
    // Função robusta para converter "R$ 1.234,56" em número 1234.56
    function moedaParaNumero(str) {
      if (!str) return 0;
      return parseFloat(
        String(str)
          .replace(/R\$\s?/g, '')
          .replace(/\./g, '')
          .replace(',', '.')
          .replace(/\s/g, '')
      ) || 0;
    }

    // Receita anual continua puxando do mesmo campo
    const receitaAnual = moedaParaNumero(document.getElementById("receita_anual")?.value);

    // Custo variável anual: pega da tabela resumo-produto, linha "Total", coluna "Custo Variável Total (R$)"
    let custosVarAnual = 0;
    const custosVarTable = document.querySelector("#custos_variaveis_anuais table.resumo-produto");
    if (custosVarTable) {
      const linhas = custosVarTable.querySelectorAll("tbody tr");
      if (linhas.length > 0) {
        const linhaTotal = linhas[linhas.length - 1];
        const celulas = linhaTotal.querySelectorAll("td");
        // Última coluna é "Custo Variável Total (R$)"
        if (celulas.length > 0) {
          const texto = celulas[celulas.length - 1].innerText || "";
          custosVarAnual = moedaParaNumero(texto);
        }
      }
    }

    // Custo fixo anual
    const fixoAnual = moedaParaNumero(document.getElementById("custos_fixos_anual")?.value);

    const lucroAnual = receitaAnual - (custosVarAnual + fixoAnual);
    const meses = anosAdicionados.length * 12;
    const lucroMensal = meses > 0 ? lucroAnual / meses : 0;

    const campoLucroAnual = document.getElementById("lucro_anual");
    const campoLucroMensal = document.getElementById("lucro_mensal");

    if (campoLucroAnual) {
      campoLucroAnual.value = `R$ ${lucroAnual.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
    }
    if (campoLucroMensal) {
      campoLucroMensal.value = `R$ ${lucroMensal.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
    }
  }


function atualizarResumoPorProduto() {
  // Função para converter "R$ 1.234,56" em número 1234.56
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }

  const container = document.getElementById("containerMatrizes");
  const resumoBody = document.getElementById("resumo_vendas_produto");
  if (!container || !resumoBody) return;

  resumoBody.innerHTML = "";

  const blocos = container.querySelectorAll(".matriz-bloco");

  // Objeto para acumular totais por produto (caso o mesmo produto apareça em anos diferentes)
  const resumo = {};

  blocos.forEach(bloco => {
    const linhas = bloco.querySelectorAll("tbody tr");

    linhas.forEach(linha => {
      const colunas = linha.querySelectorAll("td");
      if (colunas.length > 2) {
        const nomeProduto = colunas[0].textContent.trim();
        const precoUnitario = moedaParaNumero(colunas[1].textContent.trim());
        let quantidadeTotal = 0;

        // Percorre os inputs de cada mês (pula a coluna "Total Ano" que é a coluna 2)
        for (let i = 3; i < colunas.length - 1; i++) {
          const input = colunas[i].querySelector("input");
          if (input) {
            const valor = parseFloat(input.value.replace(",", "."));
            if (!isNaN(valor)) quantidadeTotal += valor;
          }
        }

        // Se o produto já existe no resumo, acumula
        if (!resumo[nomeProduto]) {
          resumo[nomeProduto] = {
            quantidade: 0,
            preco: precoUnitario
          };
        }

        resumo[nomeProduto].quantidade += quantidadeTotal;
      }
    });
  });

  // Monta as linhas da tabela de resumo
  Object.entries(resumo).forEach(([nome, dados]) => {
    const total = dados.quantidade * dados.preco;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${nome}</td>
      <td style="text-align: center;">${dados.quantidade.toLocaleString("pt-BR")}</td>
      <td style="text-align: center;">R$ ${total.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
    `;
    resumoBody.appendChild(tr);
  });
}

  // Salvar no sessionStorage
function salvarNoStorage() {
  sessionStorage.setItem("produtos", JSON.stringify(produtos));
  sessionStorage.setItem("anosAdicionados", JSON.stringify(anosAdicionados));

  anosAdicionados.forEach((anoID) => {
    produtos.forEach((_, i) => {
      for (let m = 0; m < 12; m++) {
        const inputId = `${anoID}_produto_${i}_mes_${m}`;
        const input = document.getElementById(inputId);
        if (input) sessionStorage.setItem(inputId, input.value);
      }
    });
  });
  atualizarReceitaProdutos();
  calcularLucros();
 atualizarCamposCustosVariaveisPorProduto();
 calcularCustosVariaveisEmReais();


}

// Carregar do sessionStorage
function carregarDoStorage() {
  const produtosSalvos = sessionStorage.getItem("produtos");
  const anosSalvos = sessionStorage.getItem("anosAdicionados");

  if (produtosSalvos) {
    produtos = JSON.parse(produtosSalvos);
    atualizarTabelaProdutos();
    calcularCustosVariaveisEmReais();
  }

  if (anosSalvos) {
    anosAdicionados = JSON.parse(anosSalvos);
    anosAdicionados.forEach(anoID => adicionarAno(null, null, anoID)); // repõe matrizes
    setTimeout(() => atualizarReceitaProdutos(), 300);
  }
}

// Executar ao carregar a página
window.onload = () => {
  carregarDoStorage();
  setTimeout(() => {
    atualizarPontoEquilibrio();
     calcularCustosVariaveisAnual();
     calcularLucros();
     calcularTaxaDesconto();
     atualizarMargemMensalPorProduto();
     atualizarCamposCustosVariaveisPorProduto();
      calcularCustosVariaveisEmReais();  // ✅ Executa ao iniciar
  }, 300);
};
function atualizarReceitaProdutos() {
  const blocos = document.querySelectorAll(".matriz-bloco");

  blocos.forEach((matriz, idx) => {
    const anoID = matriz.id; // ex: matriz_1, matriz_2
    const inputs = matriz.querySelectorAll("input");

    inputs.forEach(input => {
      input.addEventListener("input", () => {
        calcularReceitaNova();
        salvarNoStorage();
        atualizarResumoPorProduto();
      });
    });

    // Restaurar os valores se existirem
    produtos.forEach((_, i) => {
      for (let m = 0; m < 12; m++) {
        const inputId = `${anoID}_produto_${i}_mes_${m}`;
        const val = sessionStorage.getItem(inputId);
        const input = document.getElementById(inputId);
        if (input) input.value = val || "";
      }
    });
  });

  calcularReceitaNova();
}
function calcularCustosVariaveisEmReais() {
  const container = document.getElementById("custos_variaveis_valores_rs");
  if (!container) return;

  container.innerHTML = `
    <h3 style="color:#c5c8cd; margin-top: 10px;">Custos Variáveis Convertidos por Produto (R$)</h3>
    <div id="blocoCustosVariaveisRS" style="display: flex; flex-direction: column; gap: 20px;"></div>
  `;

  const bloco = container.querySelector("#blocoCustosVariaveisRS");
  if (produtos.length === 0) return;

  produtos.forEach((produto, index) => {
    const precoVenda = parseFloat(produto.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;

    const getPercent = (id) => {
      const el = document.getElementById(`${id}_produto_${index}`);
      if (!el) return 0;
      return parseFloat(el.value.replace('%', '').replace(',', '.')) || 0;
    };

    // Produção (%) é o campo readonly, mas convertemos para R$ também
    const producao = precoVenda * (getPercent('producao') / 100);
    const imposto = precoVenda * (getPercent('imposto') / 100);
    const comissao = precoVenda * (getPercent('comissao') / 100);
    const cartao = precoVenda * (getPercent('cartao') / 100);
    const outros = precoVenda * (getPercent('outros') / 100);
    const total = producao + imposto + comissao + cartao + outros;

    const blocoProduto = document.createElement("div");
    blocoProduto.className = "bloco-produto-custos";
    blocoProduto.style.border = "1px solid #333";
    blocoProduto.style.padding = "15px";
    blocoProduto.style.borderRadius = "10px";
    blocoProduto.style.backgroundColor = "#111";
    blocoProduto.style.color = "#bbb";

    blocoProduto.innerHTML = `
      <h4 style="color:#fff ; margin-top: 0;">${produto.nome}</h4>
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <div class="form-group" style="width: 30%;">
          <label>Produção (R$)</label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${producao.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;">
        </div>
        <div class="form-group" style="width: 30%;">
          <label>Impostos (R$)</label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${imposto.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;">
        </div>
        <div class="form-group" style="width: 30%;">
          <label>Comissão de Vendas (R$)</label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${comissao.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;">
        </div>
        <div class="form-group" style="width: 30%;">
          <label>Tarifas de Cartão (R$)</label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${cartao.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;">
        </div>
        <div class="form-group" style="width: 30%;">
          <label>Outros Valores (R$)</label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${outros.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;">
        </div>
        <div class="form-group" style="width: 30%;">
          <label><strong>Custos Variável (R$):</strong></label>
          <input type="text" readonly class="currency readonly-clone" 
            value="R$ ${total.toFixed(2).replace('.', ',')}" 
            style="background-color: #111; color: #fff  ; font-weight: bold; border: 1px solid #fff ; width: 100%;">
        </div>
      </div>
    `;

    bloco.appendChild(blocoProduto);
  });
}

// --- SOLUÇÃO PARA ATUALIZAR DE IMEDIATO NA ETAPA 03 ---
// O problema ocorre porque os campos de custos variáveis por produto (imposto, comissão, etc) só existem no DOM da etapa 2.
// Quando você avança para a etapa 3, esses campos ainda não existem, então os valores não são lidos corretamente.
// Para resolver, sempre que avançar para a etapa 3, chame explicitamente:
//   atualizarCamposCustosVariaveisPorProduto();
//   calcularCustosVariaveisEmReais();
//   calcularCustosVariaveisAnual();
// Isso garante que os campos sejam criados e os cálculos feitos imediatamente.
// Exemplo (adicione no nextStep, logo após steps[i + 1].classList.add("active")):
//
// if (steps[i + 1].id === 'step3') {
//   atualizarCamposCustosVariaveisPorProduto();
//   calcularCustosVariaveisEmReais();
//   calcularCustosVariaveisAnual();
//   atualizarCustosFixosEVariaveis();
// }
//
// Assim, ao avançar, os valores aparecem imediatamente na etapa 3.
function calcularCustosVariaveisAnual() {
  const container = document.getElementById("custos_variaveis_anuais");
  if (!container) return;

  // Sobe a matriz para não ficar em cima do botão
  container.style.marginBottom = "40px";
  container.style.marginTop = "0px";

  // Helper para moeda
  const moedaParaNumero = (str) =>
    parseFloat(String(str || '').replace("R$", "").replace(/\./g, "").replace(",", ".")) || 0;

  // Monta tabela
  let html = `<table class="resumo-produto" style="margin-top:0;">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Produção (R$)</th>
        <th>Imposto (R$)</th>
        <th>Comissão (R$)</th>
        <th>Cartão (R$)</th>
        <th>Outros (R$)</th>
        <th>Custo Variável Total (R$)</th>
      </tr>
    </thead>
    <tbody>
  `;

  // Totais por coluna
  let totalProducao = 0, totalImposto = 0, totalComissao = 0, totalCartao = 0, totalOutros = 0, totalGeral = 0;

  produtos.forEach((p, index) => {
    const preco = moedaParaNumero(p.precoVenda);

    // Busca os percentuais de cada produto nos campos dinâmicos (sem máscara de %)
    const getPercent = (campo) => {
      const el = document.getElementById(`${campo}_produto_${index}`);
      if (!el) return 0;
      // Remove qualquer caractere não numérico exceto ponto e vírgula
      return parseFloat(String(el.value || '').replace('%', '').replace(',', '.').replace(/[^\d.-]/g, '')) || 0;
    };
    const prodPerc = getPercent('producao');
    const impPerc = getPercent('imposto');
    const comPerc = getPercent('comissao');
    const cartPerc = getPercent('cartao');
    const outPerc = getPercent('outros');

    // Soma quantidade total vendida no ano (todas matrizes)
    let quantidadeTotal = 0;
    anosAdicionados.forEach((anoID) => {
      for (let m = 0; m < 12; m++) {
        const input = document.getElementById(`${anoID}_produto_${index}_mes_${m}`);
        if (input) {
          quantidadeTotal += parseFloat(input.value) || 0;
        }
      }
    });

    // Calcula valores unitários
    const unitProducao = preco * (prodPerc / 100);
    const unitImposto = preco * (impPerc / 100);
    const unitComissao = preco * (comPerc / 100);
    const unitCartao = preco * (cartPerc / 100);
    const unitOutros = preco * (outPerc / 100);

    // Totais por produto
    const totalProd = unitProducao * quantidadeTotal;
    const totalImp = unitImposto * quantidadeTotal;
    const totalCom = unitComissao * quantidadeTotal;
    const totalCar = unitCartao * quantidadeTotal;
    const totalOut = unitOutros * quantidadeTotal;
    const totalProduto = totalProd + totalImp + totalCom + totalCar + totalOut;

    // Acumula totais
    totalProducao += totalProd;
    totalImposto += totalImp;
    totalComissao += totalCom;
    totalCartao += totalCar;
    totalOutros += totalOut;
    totalGeral += totalProduto;

    html += `
      <tr>
        <td style="text-align: center;">${p.nome}</td>
        <td style="text-align: center;">R$ ${totalProd.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align: center;">R$ ${totalImp.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align: center;">R$ ${totalCom.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align: center;">R$ ${totalCar.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align: center;">R$ ${totalOut.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align: center;"><strong>R$ ${totalProduto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong></td>
      </tr>
        `;
      });

  // Linha de totais (cor alterada para laranja)
  html += `
    <tr style="background:#333; color:#ff9800; font-weight:bold; text-align:center;">
      <td style="text-align:center;">Total</td>
      <td style="text-align:center;">R$ ${totalProducao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      <td style="text-align:center;">R$ ${totalImposto.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      <td style="text-align:center;">R$ ${totalComissao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      <td style="text-align:center;">R$ ${totalCartao.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      <td style="text-align:center;">R$ ${totalOutros.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      <td style="text-align:center;">R$ ${totalGeral.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
    </tr>
    `

  html += `</tbody></table>`;

  container.innerHTML = `<h3 style="color:#c5c8cd; width:100%; margin-bottom:10px;">Custos Variáveis Anual (R$)</h3>` + html;
  calcularLucros(); // Atualiza os lucros após calcular os custos variáveis
}

function atualizarCenariosProdutos() {
  const container = document.getElementById("tabelaCenariosProdutos");
  container.innerHTML = "";

  produtos.forEach((produto, i) => {
    const preco = parseFloat(produto.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;

    container.innerHTML += `
      <div class="row" style="margin-bottom: 15px; text-align: center;">
        <div class="form-group col-33" style="text-align: center;">
          <label style="display: block; text-align: center;">${produto.nome} – Unidades Pessimista:</label>
          <input type="number" class="pessimista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})" style="text-align: center;">
          <input type="text" id="perc_pess_${i}" placeholder="%" value="70" oninput="atualizarValoresCenario(${i}, ${preco})" style="width:60px; text-align:center;">
          <input type="text" id="val_pess_${i}" readonly style="text-align: center;">
        </div>
        <div class="form-group col-33" style="text-align: center;">
          <label style="display: block; text-align: center;">${produto.nome} – Unidades Realista:</label>
          <input type="number" class="realista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})" style="text-align: center;">
          <input type="text" id="perc_real_${i}" placeholder="%" value="100" oninput="atualizarValoresCenario(${i}, ${preco})" style="width:60px; text-align:center;">
          <input type="text" id="val_real_${i}" readonly style="text-align: center;">
        </div>
        <div class="form-group col-33" style="text-align: center;">
          <label style="display: block; text-align: center;">${produto.nome} – Unidades Otimista:</label>
          <input type="number" class="otimista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})" style="text-align: center;">
          <input type="text" id="perc_otim_${i}" placeholder="%" value="130" oninput="atualizarValoresCenario(${i}, ${preco})" style="width:60px; text-align:center;">
          <input type="text" id="val_otim_${i}" readonly style="text-align: center;">
        </div>
      </div>`;
  });
}

function atualizarValoresCenario(i, preco) {
  // Pega as quantidades
  const pess = parseInt(document.querySelector(`.pessimista[data-index='${i}']`)?.value || 0);
  const real = parseInt(document.querySelector(`.realista[data-index='${i}']`)?.value || 0);
  const otim = parseInt(document.querySelector(`.otimista[data-index='${i}']`)?.value || 0);

  // Pega as porcentagens (permite digitar com ou sem %)
  const percPess = parseFloat((document.getElementById(`perc_pess_${i}`)?.value || "70").replace('%','').replace(',','.')) || 0;
  const percReal = parseFloat((document.getElementById(`perc_real_${i}`)?.value || "100").replace('%','').replace(',','.')) || 0;
  const percOtim = parseFloat((document.getElementById(`perc_otim_${i}`)?.value || "130").replace('%','').replace(',','.')) || 0;

  // Calcula valores ajustados pela porcentagem
  document.getElementById(`val_pess_${i}`).value = (pess * preco * (percPess/100)).toFixed(2);
  document.getElementById(`val_real_${i}`).value = (real * preco * (percReal/100)).toFixed(2);
  document.getElementById(`val_otim_${i}`).value = (otim * preco * (percOtim/100)).toFixed(2);
}

function atualizarCustosFixosEVariaveis() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;

  // ✅ CUSTOS FIXOS – Soma pelos nomes
  let custosFixos = 0;
  const camposCustosFixos = [
    "Aluguel (R$):", "Energia (R$):", "Salários (R$):",
    "Internet (R$):", "Outros Custos (R$):",
    "Combustível (R$):", "Salários Equipe Comercial (R$):",
    "Despesa 1 (R$):", "Despesa 2 (R$):"
  ];

  document.querySelectorAll("#step2 label").forEach(label => {
    const texto = label.textContent.trim();
    if (camposCustosFixos.includes(texto)) {
      const input = label.closest(".form-group")?.querySelector("input");
      if (input && input.value) {
        custosFixos += moedaParaNumero(input.value);
      }
    }
  });

  // ✅ INVESTIMENTO INICIAL – Soma pelos nomes
  let investimento = 0;
  const camposInvestimento = [
    "Criação de Marca e Registro (R$):",
    "Abertura de Empresa e Licenças (R$):",
    "Consultorias (R$):",
    "Estoque Inicial (R$):",
    "Equipamentos (R$):",
    "Imobilizados (R$):",
    "Capital de Giro (R$):",
    "Outros Investimentos (R$):"
  ];

  document.querySelectorAll("#step2 label").forEach(label => {
    const texto = label.textContent.trim();
    if (camposInvestimento.includes(texto)) {
      const input = label.closest(".form-group")?.querySelector("input");
      if (input && input.value) {
        investimento += moedaParaNumero(input.value);
      }
    }
  });

  // ✅ Atualiza os campos da Etapa 03
  const campoFixos = document.getElementById("custos_fixos_total");
  const campoInvestimento = document.getElementById("investimento_inicial");

  if (campoFixos) {
    // Garante que o valor tenha a máscara "R$"
    let valor = custosFixos.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
    if (!valor.startsWith("R$")) valor = "R$ " + valor;
    campoFixos.value = valor;
  }
  const campoAnual = document.getElementById("custos_fixos_anual");
if (campoAnual) {
  const totalMatrizes = Math.max(1, anosAdicionados.length); // garante no mínimo 1
  const totalAnual = custosFixos * totalMatrizes * 12;
  campoAnual.value = `R$ ${totalAnual.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
}

  if (campoInvestimento) {
    campoInvestimento.value = `R$ ${investimento.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
  }

  // ✅ Replica os percentuais de Custos Variáveis
  const containerCV = document.getElementById("custos_variaveis_exibidos");
if (containerCV) containerCV.innerHTML = "";

// Campos de percentual que devem ser replicados
const camposReplicaveis = [
  { id: "auto_custo_prod", nome: "Produção (%)" },
  { id: "inputImpostoPercentualEtapa02", nome: "Impostos (%)" },
  { id: "inputComissaoPercentualEtapa02", nome: "Comissão Venda (%)" },
  { id: "inputCartaoPercentualEtapa02", nome: "Tarifas Cartão (%)" },
  { id: "inputOutrosPercentualEtapa02", nome: "Outros Valores (%)" },
  { id: "taxa_inflacao", nome: "Inflação Esperada (%)" },
  { id: "taxa_oportunidade", nome: "Custo Oportunidade (%)" },
  { id: "taxa_esperada", nome: "Retorno Esperado (%)" },
  { id: "taxa_tma", nome: "TMA (%)" }
];

camposReplicaveis.forEach(campo => {
  const input = document.getElementById(campo.id);
  if (input) {
    const div = document.createElement("div");
   div.className = "form-group col-25";
div.style.padding = "0 0px";
    div.innerHTML = `
      <label>${campo.nome}</label>
      <input type="text" class="percent readonly-clone" value="${input.value}" readonly style="background-color: #111; color: #bbb; border: 1px solid #333;">
    `;
    containerCV.appendChild(div);
  }
});
// 🔵 DISTRIBUIÇÃO PERCENTUAL DO INVESTIMENTO
const containerInvest = document.getElementById("itens_percentuais_investimento");
if (containerInvest) {
  containerInvest.innerHTML = "";

  camposInvestimento.forEach(nomeCampo => {
    document.querySelectorAll("#step2 label").forEach(label => {
      if (label.textContent.trim() === nomeCampo) {
        const input = label.closest(".form-group")?.querySelector("input");
        if (input && input.value) {
          const valor = moedaParaNumero(input.value);
          const percentual = investimento > 0 ? (valor / investimento) * 100 : 0;

          const div = document.createElement("div");
          div.className = "form-group col-33";
          div.innerHTML = `
            <label>${nomeCampo.replace('(R$):', '').trim()}</label>
            <input type="text" readonly class="readonly-clone" 
              style="background-color: #111; color: #bbb; border: 1px solid #333; width: 100%;" 
              value="${percentual.toFixed(2).replace('.', ',')}%">
          `;
          containerInvest.appendChild(div);
        }
      }
    });
  });
}
atualizarPontoEquilibrio();
calcularLucros()
}

let contadorAnos = 0;

function adicionarAno(dados = null, nomeCustom = null) {
  contadorAnos++;
  const anoLabel = nomeCustom || `Ano ${contadorAnos}`;
  const idMatriz = `matriz_${contadorAnos}`;
  anosAdicionados.push(idMatriz);
  const container = document.getElementById("containerMatrizes");
  const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

  

  let html = `
    <div class="matriz-bloco" id="${idMatriz}" style="margin-bottom: 40px;">
      <div class="matriz-cabecalho">
        <div style="display:flex; align-items:center; gap:8px;">
          <h3 id="${idMatriz}_titulo" class="titulo-editavel">${anoLabel}</h3>
          <span class="icone-editar" onclick="editarTitulo('${idMatriz}_titulo')">✏️</span>
        </div>
        <div class="matriz-botoes">
          <button class="btn-acoes" onclick="duplicarAno('${idMatriz}')">Duplicar</button>
          <button class="btn-acoes" onclick="excluirAno('${idMatriz}')">Excluir</button>
        </div>
      </div>
      <div style="overflow-x:auto;">
        <table style="min-width:800px; width:100%; color:white; border-collapse: collapse; text-align: center;">
         <thead>
  <tr>
    <th style="text-align: center;">Produto</th>
    <th style="text-align: center;">Preço Venda (R$)</th>
    <th style="text-align: center;">Total Ano</th>
    ${meses.map(m => `<th style="width: 60px;">${m}</th>`).join('')}
    <th style="white-space: nowrap;">Total R$</th>
  </tr>
</thead>
<tbody>
  ${produtos.map((p, i) => {
    const rowID = `${idMatriz}_produto_${i}`;
    return `
      <tr>
        <td style="text-align: center; white-space: nowrap; padding: 6px 12px;">${p.nome}</td>
        <td>
  <div style="display:inline-block; white-space:nowrap; padding:6px 12px; background-color:#1c1c1c; border-radius:4px;">
    R$ ${parseFloat(p.precoVenda.replace("R$", "").replace(/\./g, "").replace(",", "."))
      .toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
  </div>
</td>
        <td>
          <input type="number" id="${rowID}_totalAno" 
       value="${dados?.[`produto_${i}_totalAno`] || ''}" 
       oninput="distribuirEntreMeses('${rowID}')" 
       min="0" 
       style="width: 80px; text-align: center;" />
        </td>
        ${meses.map((_, m) => {
          const idInput = `${rowID}_mes_${m}`;
          const valor = dados?.[`produto_${i}_mes_${m}`] ?? "";
          return `<td style="text-align: center;">
  <input type="number" id="${idInput}" min="0" 
    oninput="atualizarTotalAno('${rowID}')" 
    style="width: 60px; text-align: center;" />
</td>`;
        }).join('')}
        <td><span id="${rowID}_total">0</span></td>
      </tr>
    `;
  }).join('')}
</tbody>
        </table>
      </div>
    </div>
  `;
  const wrapper = document.createElement("div");
wrapper.innerHTML = html;
container.appendChild(wrapper);

  calcularReceitaNova();
  atualizarMargemMensalPorProduto();
  atualizarResumoPorProduto();
  calcularCustosVariaveisAnual();
  atualizarCustosFixosEVariaveis();
}
function distribuirEntreMeses(rowID) {
  const totalAnoInput = document.getElementById(`${rowID}_totalAno`);
  if (!totalAnoInput) return;

  let total = parseInt(totalAnoInput.value) || 0;

  // Zera todos os meses antes de distribuir
  for (let i = 0; i < 12; i++) {
    const inputMes = document.getElementById(`${rowID}_mes_${i}`);
    if (inputMes) inputMes.value = '';
  }

  // Distribui de forma igualitária entre os meses
  const base = Math.floor(total / 12);
  let resto = total % 12;

  for (let i = 0; i < 12; i++) {
    const inputMes = document.getElementById(`${rowID}_mes_${i}`);
    if (inputMes) {
      let valor = base;
      if (resto > 0) {
        valor += 1;
        resto--;
      }
      inputMes.value = valor > 0 ? valor : '';
    }
  }

  calcularReceitaNova(); // atualiza todos os resumos
}

function atualizarTotalAno(rowID) {
  let total = 0;
  for (let i = 0; i < 12; i++) {
    const input = document.getElementById(`${rowID}_mes_${i}`);
    const valor = parseFloat(input?.value || 0);
    if (!isNaN(valor)) total += valor;
  }
  const campoTotalAno = document.getElementById(`${rowID}_totalAno`);
  if (campoTotalAno) campoTotalAno.value = total;
  calcularReceitaNova();
}

function excluirAno(idMatriz) {
  const el = document.getElementById(idMatriz);
  if (el) el.remove();

  // Atualiza a lista de anos
  anosAdicionados = anosAdicionados.filter(id => id !== idMatriz);

  const blocos = document.querySelectorAll(".matriz-bloco");
  contadorAnos = blocos.length;

  calcularReceitaNova();
  atualizarMargemMensalPorProduto();
  atualizarResumoPorProduto();
  atualizarCustosFixosEVariaveis();
  calcularCustosVariaveisAnual(); // ✅ aqui o custo anual será recalculado corretamente
}

function duplicarAno(idOrigem) {
  const dados = {};

  const matriz = document.getElementById(idOrigem);
  const linhas = matriz.querySelectorAll("tbody tr");

  linhas.forEach((linha, i) => {
    const inputs = linha.querySelectorAll("input");
inputs.forEach((input, mesIndex) => {
  const id = input.id;
  if (id.includes("_mes_")) {
    const key = `produto_${i}_mes_${mesIndex}`;
    dados[key] = input.value;
  }
});

// Captura o Total Ano
const totalAnoInput = linha.querySelector(`#${idOrigem}_produto_${i}_totalAno`);
if (totalAnoInput) {
  const keyTotal = `produto_${i}_totalAno`;
  dados[keyTotal] = totalAnoInput.value;
}
  });

  const nomeOriginal = document.getElementById(`${idOrigem}_titulo`)?.innerText || "";
  const nomeDuplicado = nomeOriginal.includes(" (cópia)") ? nomeOriginal : `${nomeOriginal} (cópia)`;

  adicionarAno({ ...dados }, nomeDuplicado); // Passa cópia dos dados para evitar referência direta
  setTimeout(() => atualizarMargemMensalPorProduto(), 100);
  atualizarResumoPorProduto();
  atualizarCustosFixosEVariaveis();
  calcularCustosVariaveisAnual();
}

function calcularReceitaNova() {
  const moeda = v => parseFloat(String(v).replace(/\./g, '').replace(',', '.')) || 0;

  let receitaTotal = 0;
  let totalMeses = 0;

  // Para cada matriz (ano)
  document.querySelectorAll(".matriz-bloco").forEach((matriz) => {
    const linhas = matriz.querySelectorAll("tbody tr");
    linhas.forEach((linha, i) => {
      let somaProduto = 0;
      // Soma apenas os inputs dos meses (não o Total Ano)
      for (let m = 0; m < 12; m++) {
        const input = linha.querySelector(`input[id$="_mes_${m}"]`);
        if (input) {
          somaProduto += (parseInt(input.value || 0) * moeda(produtos[i]?.precoVenda));
        }
      }
      // Atualiza o campo de total da linha
      linha.querySelector("span").innerText = somaProduto.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
      receitaTotal += somaProduto;
    });
    totalMeses += 12;
  });

  document.getElementById("receita_anual").value = receitaTotal.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
  document.getElementById("receita_mensal").value = (totalMeses > 0 ? receitaTotal / totalMeses : 0).toLocaleString("pt-BR", { minimumFractionDigits: 2 });
  atualizarMargemMensalPorProduto();
  atualizarResumoPorProduto();
  atualizarPontoEquilibrio();
  calcularCustosVariaveisAnual();
  calcularLucros(); // ✅ Chamada obrigatória para atualizar lucros
}


function atualizarToggleCenarios() {
  usarCenarios = document.getElementById("toggleCenarios").checked;
  atualizarCenarios();
}

function atualizarCenarios() {
  const container = document.getElementById("blocoCenarios");
  if (!usarCenarios || produtos.length === 0 || anosAdicionados.length === 0) {
    container.innerHTML = "";
    return;
  }

  let receitaBase = moedaParaNumero(document.getElementById("receita_anual").value);
  container.innerHTML = "";

  const cenarios = [
    { nome: "Pessimista", fator: 0.7 },
    { nome: "Realista", fator: 1.0 },
    { nome: "Otimista", fator: 1.3 }
  ];

  cenarios.forEach((c, i) => {
    const valor = receitaBase * c.fator;
    container.innerHTML += `
      <div class="form-group col-100" style="margin-bottom: 10px;">
        <label>
          <input type="text" value="${c.nome}" style="width:200px; margin-right:10px;" oninput="salvarNoStorage()">
          Receita Estimada (${(c.fator * 100).toFixed(0)}%): R$ ${valor.toFixed(2).replace('.', ',')}
        </label>
      </div>
    `;
  });
}
function reconstruirTodasMatrizes() {
  const container = document.getElementById("containerMatrizes");
  const blocos = document.querySelectorAll(".matriz-bloco");

  const matrizesSalvas = [];

  blocos.forEach((matriz, i) => {
    const titulo = matriz.querySelector("h3")?.innerText || `Ano ${i+1}`;
    const inputs = matriz.querySelectorAll("input");
    const dados = {};

    inputs.forEach((input, idx) => {
      const key = input.id.split("_");
      const produtoIdx = key[2]; // posição do produto
      const mesIdx = key[4]; // posição do mês
      const comp = `produto_${produtoIdx}_mes_${mesIdx}`;
      dados[comp] = input.value;
    });

    matrizesSalvas.push({ titulo, dados });
  });

  container.innerHTML = ""; // limpa todas

  contadorAnos = 0;
anosAdicionados = [];// reinicia o contador corretamente

  matrizesSalvas.forEach(m => {
    adicionarAno(m.dados, m.titulo);
  });
  setTimeout(() => atualizarMargemMensalPorProduto(), 100);
setTimeout(() => {
  atualizarMargemMensalPorProduto();
  atualizarPontoEquilibrio(); // ✅ Chamada obrigatória
}, 100);
}
function editarTitulo(id) {
  const el = document.getElementById(id);
  const nomeAtual = el.innerText;

  const novoNome = prompt("Digite um novo nome para esse ano:", nomeAtual);
  if (novoNome && novoNome.trim() !== "") {
    el.innerText = novoNome.trim();

    
  }
}


// 🟢 Atualizar ao digitar ou mudar valores
["input", "change"].forEach(evt =>
  document.addEventListener(evt, () => {
    setTimeout(() => {
      atualizarCustosFixosEVariaveis();
      atualizarMargemMensalPorProduto();
      calcularCustosVariaveisAnual();
      calcularLucros();
      calcularTaxaDesconto();
    }, 50);
  })
);

</script>

<!-- ETAPA 04 – Módulo 2 – Análise Financeira -->
<div class="step" id="step4">
  <h2>Etapa 04 – Análise Financeira</h2>
<h3 style="color:#c5c8cd;">6. Taxas de Desconto</h3>
<div class="row">
  <div class="form-group col-50">
    <label>Taxa de Desconto (anual):</label>
    <input type="text" id="taxa_desconto_anual" class="readonly-clone" readonly 
           style="background-color:#111; color:#bbb; border:1px solid #333;">
  </div>
  <div class="form-group col-50">
    <label>Taxa de Desconto Mês (composto):</label>
    <input type="text" id="taxa_desconto_mensal" class="readonly-clone" readonly 
           style="background-color:#111; color:#bbb; border:1px solid #333;">
  </div>
</div>
  <!-- Margem de Contribuição Unitária (6.1) -->
  <h3 style="color:#c5c8cd; margin-top: 30px;">6.1 Margem de Contribuição Unitária</h3>

<!-- Margem Total -->
<h3 style="color:#c5c8cd;">Resumo MCu</h3>
<div class="row">
  <div class="form-group col-25">
    <label>MCu (Total):</label>
    <input type="text" id="margem_total" class="readonly-clone" readonly
      style="background:#111; color:#bbb; border:1px solid #333;">
  </div>
  <div class="form-group col-25">
    <label>MCu Mensal:</label>
    <input type="text" id="mcu_mensal" class="readonly-clone" readonly
      style="background:#111; color:#bbb; border:1px solid #333;">
  </div>
  <div class="form-group col-25">
    <label>MCu Anual:</label>
    <input type="text" id="mcu_anual" class="readonly-clone" readonly
      style="background:#111; color:#bbb; border:1px solid #333;">
  </div>
   <div class="form-group col-25">
    <label>Margem Lucro:</label>
    <input type="text" id="margem_lucro" class="readonly-clone" readonly
      style="background:#111; color:#bbb; border:1px solid #333;">
  </div>
</div>
  <!-- Margem de Contribuição Total (6.2) por mês em forma de matriz -->
<div style="overflow-x: auto; padding-bottom: 10px;">
  <table style="min-width: 800px; width: max-content; margin-top: 10px; text-align: center; color: #fff; border-collapse: collapse;">
    <tbody id="margem_matriz"></tbody>
  </table>
</div>
  <!-- Ponto de Equilíbrio -->
  <h3 style="color:#c5c8cd;">7. Ponto de Equilíbrio</h3>
  
<h4 style="color:white; margin-top: 30px;">7.3 Ponto de Equilíbrio por Produto</h4>
<div id="peq_individual" style="color:white; margin-top: 10px;">
  <!-- Conteúdo será inserido via JS -->
</div>
 
  <!-- ROI -->
  <h3 style="color:#c5c8cd;">8. Indicadores Financeiros</h3>
  <div id="calculoIndicadores" style="color:white; margin-top: 10px;"></div>
  </div>

<script>
function calcularTaxaDesconto() {
  // Função para remover qualquer máscara e retornar número decimal
  const parsePercent = (id) => {
    let val = document.getElementById(id)?.value || "0";
    val = val.replace(/[^0-9,.-]/g, ''); // Remove tudo exceto números, vírgula, ponto e sinal
    val = val.replace(/\./g, ''); // Remove pontos de milhar
    val = val.replace(',', '.'); // Troca vírgula por ponto
    return parseFloat(val) / 100 || 0;
  };

  const inflacao = parsePercent("taxa_inflacao");
  const oportunidade = parsePercent("taxa_oportunidade");
  const retorno = parsePercent("taxa_esperada");

  // Cálculo composto
  const taxaDescontoAnual = (1 + inflacao) * (1 + oportunidade) * (1 + retorno) - 1;
  const taxaDescontoMensal = Math.pow(1 + taxaDescontoAnual, 1 / 12) - 1;

  // Exibir nos campos
  document.getElementById("taxa_desconto_anual").value = (taxaDescontoAnual * 100).toFixed(2).replace('.', ',') + '%';
  document.getElementById("taxa_desconto_mensal").value = (taxaDescontoMensal * 100).toFixed(2).replace('.', ',') + '%';
}
 
function atualizarMargemUnitáriaPorProduto() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const container = document.getElementById("margem-unitaria-produto");
  if (!container) return;

  container.innerHTML = "";

  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  produtos.forEach(p => {
    const precoVenda = moedaParaNumero(p.precoVenda);
    const custoDireto = moedaParaNumero(p.custoR);

    const impostoR$ = precoVenda * (impostoPerc / 100);
    const comissaoR$ = precoVenda * (comissaoPerc / 100);
    const cartaoR$ = precoVenda * (cartaoPerc / 100);
    const outrosR$ = precoVenda * (outrosPerc / 100);

    const margemUnit = precoVenda - (custoDireto + impostoR$ + comissaoR$ + cartaoR$ + outrosR$);

    container.innerHTML += `
      <div style="margin-bottom: 5px; color: #fff;">
        <strong>${p.nome}</strong>: R$ ${margemUnit.toFixed(2).replace('.', ',')}
      </div>
    `;
  });
}


function atualizarMargemUnitáriaTotal() {
  let somaCustosDiretos = 0;
  let somaPrecoVenda = 0;

  // Soma os valores totais de custo direto e preço de venda
  produtos.forEach(p => {
  const precoVendaproduto = moedaParaNumero(p.precoVenda);
  const custoDiretoproduto = moedaParaNumero(p.custoR);
  somaCustosDiretos += custoDiretoproduto;
  somaPrecoVenda += precoVendaproduto;
});

  // Pega os percentuais definidos na Etapa 02
  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  // Aplica os percentuais sobre o total de preço de venda
  const impostoReais = somaPrecoVenda * (impostoPerc / 100);
  const comissaoReais = somaPrecoVenda * (comissaoPerc / 100);
  const cartaoReais = somaPrecoVenda * (cartaoPerc / 100);
  const outrosReais = somaPrecoVenda * (outrosPerc / 100);

  // Margem total considerando todos os custos
  const margemTotal = somaPrecoVenda - (somaCustosDiretos + impostoReais + comissaoReais + cartaoReais + outrosReais);

  // Atualiza o valor na tela
  const campo = document.getElementById("margem-unitaria-total");
  if (campo) campo.innerText = "R$ " + margemTotal.toFixed(2).replace('.', ',');
atualizarPontoEquilibrio();
}

function atualizarMargemMensalPorProduto() {
  // Função para converter moeda para número
  const moedaParaNumero = str => {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  };

  // O container correto para exibir a matriz mensal é o tbody da tabela "margem_matriz"
  const container = document.getElementById("margem_matriz");
  if (!container) return;

  // Limpa o conteúdo anterior
  container.innerHTML = "";

  // Cabeçalho da matriz (sem MC Ponderada)
  let header = `<tr>
    <th>Produto</th>
    <th>Participação Receita (%)</th>
    <th>MCu (Unitária)</th>
    <th>MCu Mensal</th>
    <th>MCu Anual</th>
    <th>Margem Contribuição (%)</th>
  </tr>`;

  // Centraliza a tabela
  container.parentElement.style.display = "flex";
  container.parentElement.style.justifyContent = "center";

  // Primeiro, calcula o total de quantidade de todos os produtos
  let totalQuantidadeProdutos = 0;
  let quantidadesPorProduto = [];
  let totalReceitaProdutos = 0;
  let receitasPorProduto = [];

  produtos.forEach((p, index) => {
    let quantidadeTotal = 0;
    anosAdicionados.forEach((anoID) => {
      for (let m = 0; m < 12; m++) {
        const input = document.getElementById(`${anoID}_produto_${index}_mes_${m}`);
        if (input) {
          quantidadeTotal += parseFloat(input.value) || 0;
        }
      }
    });
    quantidadesPorProduto[index] = quantidadeTotal;
    totalQuantidadeProdutos += quantidadeTotal;

    // Receita por produto
    const preco = moedaParaNumero(p.precoVenda);
    const receita = quantidadeTotal * preco;
    receitasPorProduto[index] = receita;
    totalReceitaProdutos += receita;
  });

  // Linhas da matriz
  let linhas = "";
  let totalMCu = 0;
  let totalMCuMensal = 0;
  let totalMCuAnual = 0;
  const meses = anosAdicionados.length * 12;

  // Para MC Ponderada
  let somaMcPonderada = 0;

  // Para Preço Médio Ponderado de Venda
  let somaPrecoMedioPonderado = 0;

  produtos.forEach((p, index) => {
    const preco = moedaParaNumero(p.precoVenda);

    // Busca os valores de custos variáveis convertidos em R$ da seção "Custos Variáveis Convertidos por Produto (R$)"
    let blocoProduto = document.querySelectorAll("#blocoCustosVariaveisRS .bloco-produto-custos")[index];
    let producaoR = 0, impostoR = 0, comissaoR = 0, cartaoR = 0, outrosR = 0;
    if (blocoProduto) {
      const inputs = blocoProduto.querySelectorAll("input[readonly]");
      if (inputs.length >= 5) {
        producaoR = moedaParaNumero(inputs[0].value);
        impostoR = moedaParaNumero(inputs[1].value);
        comissaoR = moedaParaNumero(inputs[2].value);
        cartaoR = moedaParaNumero(inputs[3].value);
        outrosR = moedaParaNumero(inputs[4].value);
      }
    }

    // MCu unitária = Preço de venda - soma dos custos variáveis unitários em R$
    const custoVariavelUnitario = producaoR + impostoR + comissaoR + cartaoR + outrosR;
    const mcu = preco - custoVariavelUnitario;

    // Margem Contribuição % = MCu (Unitária) / Preço de Venda
    let margemContribuicaoPerc = preco > 0 ? (mcu / preco) * 100 : 0;

    // Quantidade total vendida
    let quantidadeTotal = quantidadesPorProduto[index];

    const margemAno = mcu * quantidadeTotal;
    const margemMes = meses > 0 ? margemAno / meses : 0;

    // Participação Quantidade (%)
    let participacaoQuantidade = totalQuantidadeProdutos > 0 ? (quantidadeTotal / totalQuantidadeProdutos) * 100 : 0;

    // Participação Receita (%)
    let receitaProduto = receitasPorProduto[index];
    let participacaoReceita = totalReceitaProdutos > 0 ? (receitaProduto / totalReceitaProdutos) * 100 : 0;

    // MC Ponderada (%) = MargemContribuição%(Da matriz) * Part.Receita (da matriz) / 100
    let mcPonderada = (margemContribuicaoPerc *  participacaoReceita) / 100;
    somaMcPonderada += mcPonderada;

    // Preço Médio Ponderado de Venda (por produto): P.Venda * Part.Receita (usando ParticipaçãoQuantidade)
    let precoMedioPonderadoProduto = preco * (participacaoReceita / 100);
    somaPrecoMedioPonderado += precoMedioPonderadoProduto;

    linhas += `
      <tr>
        <td>${p.nome}</td>
        <td>${ participacaoReceita.toFixed(2).replace('.', ',')}%</td>
        <td>R$ ${mcu.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
        <td>R$ ${margemMes.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
        <td>R$ ${margemAno.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}</td>
        <td>${margemContribuicaoPerc.toFixed(2).replace('.', ',')}%</td>
      </tr>
    `;

    totalMCu += mcu;
    totalMCuMensal += margemMes;
    totalMCuAnual += margemAno;
  });

  // Adiciona o cabeçalho e linhas ao container (tbody)
  container.innerHTML = header + linhas;

  // Exibe os totais nos campos abaixo
  document.getElementById("margem_total").value = `R$ ${totalMCu.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
  document.getElementById("mcu_mensal").value = `R$ ${totalMCuMensal.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
  document.getElementById("mcu_anual").value = `R$ ${totalMCuAnual.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
  // Pegando os valores de lucro mensal e receita mensal
  const lucroMensal = moedaParaNumero(document.getElementById("lucro_mensal").value);
  const receitaMensal = moedaParaNumero(document.getElementById("receita_mensal").value);

  // Calculando margem de lucro
  let margemLucro = receitaMensal > 0 ? (lucroMensal / receitaMensal) * 100 : 0;

  // Exibindo no input
  document.getElementById("margem_lucro").value = `${margemLucro.toFixed(2).replace('.', ',')}%`;

  // Adiciona campo MC Ponderada (%) ao lado de Margem Lucro
  let campoMcPonderada = document.getElementById("mc_ponderada");
  if (!campoMcPonderada) {
    // Cria o campo se não existir
    const parent = document.getElementById("margem_lucro").closest(".row");
    if (parent) {
      const div = document.createElement("div");
      div.className = "form-group col-25";
      div.innerHTML = `
        <label>MC Ponderada (%):</label>
        <input type="text" id="mc_ponderada" class="readonly-clone" readonly
          style="background:#111; color:#bbb; border:1px solid #333;">
      `;
      parent.appendChild(div);
      campoMcPonderada = div.querySelector("input");
    }
  }
  if (campoMcPonderada) {
    campoMcPonderada.value = `${somaMcPonderada.toFixed(2).replace('.', ',')}%`;
  }

  // Adiciona campo Preço Médio Ponderado de Venda ao lado de MC Ponderada (%)
  let campoPrecoMedioPond = document.getElementById("preco_medio_pond");
  if (!campoPrecoMedioPond) {
    const parent = document.getElementById("margem_lucro").closest(".row");
    if (parent) {
      const div = document.createElement("div");
      div.className = "form-group col-25";
      div.innerHTML = `
        <label style="color:#bbb;">P. Médio Ponderado Venda</label>
        <input type="text" id="preco_medio_pond" class="readonly-clone" readonly
          style="background:#111; color:#bbb; border:1px solid #f00; font-weight:bold;">
        <span style="font-size:11px; color:#bbb; display:block; margin-top:2px;"</span>
      `;
      parent.appendChild(div);
      campoPrecoMedioPond = div.querySelector("input");
    }
  }
  if (campoPrecoMedioPond) {
    campoPrecoMedioPond.value = `R$ ${somaPrecoMedioPonderado.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`;
  }
}

function atualizarPontoEquilibrio() {
  const moedaParaNumero = str => {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  };
  const numeroParaMoeda = num => num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  const campoCustoFixo = document.getElementById("custos_fixos_total");
  const campoMCPonderada = document.getElementById("mc_ponderada");
  const campoPrecoMedioPond = document.getElementById("preco_medio_pond");
  const containerPEQ = document.getElementById("peq_individual");

  if (!campoCustoFixo || !campoMCPonderada || !containerPEQ) return;

  // Custo fixo mensal
  const custoFixo = moedaParaNumero(campoCustoFixo.value || "0");
  // MC Ponderada (%) - já está em percentual, precisa dividir por 100
  const mcPonderadaPerc = moedaParaNumero(campoMCPonderada.value || "0") / 100;

  // Quantidade de matrizes (anos)
  const qtdAnos = typeof anosAdicionados !== "undefined" && anosAdicionados.length > 0 ? anosAdicionados.length : 1;

  // Receita Necessária no Ponto de Equilíbrio
  let receitaNecessaria = 0;
  if (mcPonderadaPerc > 0) {
    receitaNecessaria = (custoFixo) / mcPonderadaPerc;
  }

  // Preço Médio Ponderado de Venda
  // Preço Médio Ponderado de Venda: pega do campo já calculado na função anterior
  let precoMedioPonderado = moedaParaNumero(document.getElementById("preco_medio_pond")?.value || "0");

  // PE - Quantidade Média Ponderada
  let peQuantidadeMediaPonderada = 0;
  if (precoMedioPonderado > 0) {
    peQuantidadeMediaPonderada = receitaNecessaria / precoMedioPonderado;
  }

  // Calcula participação receita (%) de cada produto
  let totalReceitaProdutos = 0;
  let receitasPorProduto = [];
  produtos.forEach((p, index) => {
    let quantidadeTotal = 0;
    anosAdicionados.forEach((anoID) => {
      for (let m = 0; m < 12; m++) {
        const input = document.getElementById(`${anoID}_produto_${index}_mes_${m}`);
        if (input) {
          quantidadeTotal += parseFloat(input.value) || 0;
        }
      }
    });
    const preco = moedaParaNumero(p.precoVenda);
    const receita = quantidadeTotal * preco;
    receitasPorProduto[index] = receita;
    totalReceitaProdutos += receita;
  });

  // Exibe resultado
  containerPEQ.innerHTML = `
   
    <div style="margin-bottom: 8px;">
      <strong>Receita Necessária no Ponto de Equilíbrio:</strong> ${numeroParaMoeda(receitaNecessaria)}
      <span style="color:#bbb; font-size:12px;"</span>
    </div>
    <div style="margin-bottom: 8px;">
      <strong>Ponto de Equilibrio Média Ponderada:</strong> ${peQuantidadeMediaPonderada.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
      <span style="color:#bbb; font-size:12px;"</span>
    </div>
   
  `;

  // (Função removida conforme solicitado)
  

  atualizarReceitaEquilibrioPorProduto();
}
function atualizarReceitaEquilibrioPorProduto() {
  const container = document.getElementById("peq_individual");
  if (!container) return;

  const campoCustoFixo = document.getElementById("custos_fixos_total");
  if (!campoCustoFixo) return;

  // Função robusta para converter moeda para número
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }
  function numeroParaMoeda(num) {
    return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  const custoFixo = moedaParaNumero(campoCustoFixo.value || "0");

  container.innerHTML += `<h4 style="color:#fff; margin-top: 25px;">7.4 Ponto de Equilíbrio (Unitário)</h4>`;

  produtos.forEach((p, idx) => {
    const precoVenda = moedaParaNumero(p.precoVenda);
    const custoDireto = moedaParaNumero(p.custoR);

    // Busca custos variáveis percentuais por produto (da etapa 2)
    let impostoR$ = 0, comissaoR$ = 0, cartaoR$ = 0, outrosR$ = 0;
    const impEl = document.getElementById(`imposto_produto_${idx}`);
    const comEl = document.getElementById(`comissao_produto_${idx}`);
    const cartEl = document.getElementById(`cartao_produto_${idx}`);
    const outEl = document.getElementById(`outros_produto_${idx}`);
    if (impEl) impostoR$ = precoVenda * (parseFloat(impEl.value.replace('%','').replace(',','.'))/100 || 0);
    if (comEl) comissaoR$ = precoVenda * (parseFloat(comEl.value.replace('%','').replace(',','.'))/100 || 0);
    if (cartEl) cartaoR$ = precoVenda * (parseFloat(cartEl.value.replace('%','').replace(',','.'))/100 || 0);
    if (outEl) outrosR$ = precoVenda * (parseFloat(outEl.value.replace('%','').replace(',','.'))/100 || 0);

    // MCu Unitária = Preço de venda - (custo direto + custos variáveis unitários)
    const margemUnit = precoVenda - (custoDireto + impostoR$ + comissaoR$ + cartaoR$ + outrosR$);

    // PE Quantidade Unitário = Custos Fixos / MCu Unitária
    const peUnit = margemUnit > 0 ? custoFixo / margemUnit : 0;

    container.innerHTML += `
      <div style="margin-bottom: 5px; font-size: 15px;">
        <strong>${p.nome}</strong> – Ponto de Equilibrio Quantidade: ${peUnit > 0 ? peUnit.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : 'N/D'} unidades
        <span style="color:#bbb; font-size:12px;"</span>
      </div>
    `;
  });

  // --- Novo cálculo: Ponto de Equilíbrio Distribuído ---
  // Receita Necessária no Ponto de Equilíbrio
  // MC Ponderada (%) - já está em percentual, precisa dividir por 100
  const campoMCPonderada = document.getElementById("mc_ponderada");
  const campoPrecoMedioPond = document.getElementById("preco_medio_pond");
  let receitaNecessaria = 0;
  let mcPonderadaPerc = 0;
  if (campoMCPonderada) {
    mcPonderadaPerc = moedaParaNumero(campoMCPonderada.value || "0") / 100;
    if (mcPonderadaPerc > 0) {
      receitaNecessaria = custoFixo / mcPonderadaPerc;
    }
  }

  // Calcula participação receita (%) de cada produto
  let totalReceitaProdutos = 0;
  let receitasPorProduto = [];
  produtos.forEach((p, index) => {
    let quantidadeTotal = 0;
    anosAdicionados.forEach((anoID) => {
      for (let m = 0; m < 12; m++) {
        const input = document.getElementById(`${anoID}_produto_${index}_mes_${m}`);
        if (input) {
          quantidadeTotal += parseFloat(input.value) || 0;
        }
      }
    });
    const preco = moedaParaNumero(p.precoVenda);
    const receita = quantidadeTotal * preco;
    receitasPorProduto[index] = receita;
    totalReceitaProdutos += receita;
  });

  container.innerHTML += `<h4 style="color:#fff; margin-top: 25px;">7.5 Ponto de Equilíbrio Distribuído</h4>`;

  produtos.forEach((p, idx) => {
    const precoVenda = moedaParaNumero(p.precoVenda);
    // Participação Receita (%)
    let participacaoReceita = totalReceitaProdutos > 0 ? (receitasPorProduto[idx] / totalReceitaProdutos) : 0;
    // PE Distribuído = (receitaNecessaria * participacaoReceita) / precoVenda
    let peDistribuido = (precoVenda > 0) ? (receitaNecessaria * participacaoReceita) / precoVenda : 0;

    container.innerHTML += `
      <div style="margin-bottom: 5px; font-size: 15px;">
        <strong>${p.nome}</strong> – Ponto de Equilíbrio Distribuído: ${peDistribuido > 0 ? peDistribuido.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) : 'N/D'} unidades
        <span style="color:#bbb; font-size:12px;"</span>
      </div>
    `;
  });
}


function calcularIndicadoresFinanceiros() {
  const container = document.getElementById("calculoIndicadores");
  if (!container) return;

  // Função para remover máscaras de R$, %, "."
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }
  const numeroParaMoeda = num => num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  // Pega campos necessários
  const campoFixos = document.getElementById("custos_fixos_total");
  const campoInvestimento = document.getElementById("investimento_inicial");
  const campoLucroAnual = document.getElementById("lucro_anual");
  const campoLucroMensal = document.getElementById("lucro_mensal");

  const investimentoInicial = moedaParaNumero(campoInvestimento?.value || "0");
  const custosFixosMensal = moedaParaNumero(campoFixos?.value || "0");
  const lucroAnual = moedaParaNumero(campoLucroAnual?.value || "0");
  const lucroMensal = moedaParaNumero(campoLucroMensal?.value || "0");

  // Quantidade de matrizes (anos)
  const matrizes = document.querySelectorAll(".matriz-bloco");
  const qtdMatrizes = matrizes.length || 1;

  // ROI
  const roi = investimentoInicial > 0 ? (lucroAnual / investimentoInicial) : 0;
  const roiMensal = investimentoInicial > 0 ? (lucroMensal / investimentoInicial) : 0;
  const roiTotal = investimentoInicial > 0 ? (((lucroMensal * 12 * qtdMatrizes) - investimentoInicial) / investimentoInicial) : 0;

  // Payback
  const paybackMensal = lucroMensal > 0 ? (investimentoInicial / lucroMensal) : 0;
  const paybackAnual = lucroAnual > 0 ? (investimentoInicial / lucroAnual) : 0;

  // Atualiza campos/ids para uso em outras etapas/checklist/pdf
  document.getElementById("ROI")?.setAttribute("value", (roi * 100).toFixed(2) + "%");
  document.getElementById("paybackSimples")?.setAttribute("value", paybackMensal.toFixed(2));
  document.getElementById("paybackAnual")?.setAttribute("value", paybackAnual.toFixed(2));
  document.getElementById("roiMensal")?.setAttribute("value", (roiMensal * 100).toFixed(2) + "%");
  document.getElementById("roiTotal")?.setAttribute("value", (roiTotal * 100).toFixed(2) + "%");

  container.innerHTML = `
    <div style="margin-top: 20px; font-size: 15px;">
      <div><strong>ROI (%):</strong> ${(roi * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}%</div>
      <div><strong>ROI Mensal (%):</strong> ${(roiMensal * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}%</div>
      <div><strong>ROI Total (%):</strong> ${(roiTotal * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}%</div>
      <div><strong>Payback Mensal Simples:</strong> ${paybackMensal.toFixed(2)} meses</div>
      <div><strong>Payback Anual Simples:</strong> ${paybackAnual.toFixed(2)} anos</div>
  `;
}
function gerarMatrizFluxoCaixa() {
  // Parâmetros
  const anos = 6; // Ano 0 até 5
  const containerId = "matriz_fluxo_caixa";
  let container = document.getElementById(containerId);
  if (!container) {
    container = document.createElement("div");
    container.id = containerId;
    container.style.marginTop = "30px";
    document.getElementById("step4").appendChild(container);
  }
  container.innerHTML = "<h3 style='color:#c5c8cd; text-align:center;'>Fluxo de Caixa Projetado - 5 anos</h3>";

  // Função para converter moeda para número
  const moedaParaNumero = str => {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  };

  // TMA (Taxa Mínima de Atratividade)
  let tma = moedaParaNumero(document.getElementById("taxa_tma")?.value || "0") / 100;
  if (!tma || isNaN(tma)) tma = 0.12; // valor padrão 12% se não preenchido

  // Investimento Inicial (Ano 0)
  const investimentoInicial = moedaParaNumero(document.getElementById("investimento_inicial")?.value || "0");

  // Lucro Anual por ano (Ano 1 a 5)
  // Para cada ano, calcula o lucro anual daquele ano
  let lucrosAnuais = [];
  for (let ano = 0; ano < anos; ano++) {
    if (ano === 0) {
      lucrosAnuais.push(-investimentoInicial);
    } else {
      // Para cada produto, soma as vendas do ano correspondente
      let lucroAno = 0;
      produtos.forEach((p, idx) => {
        let quantidade = 0;
        const anoID = anosAdicionados[ano - 1];
        if (anoID) {
          for (let m = 0; m < 12; m++) {
            const input = document.getElementById(`${anoID}_produto_${idx}_mes_${m}`);
            if (input) quantidade += parseFloat(input.value) || 0;
          }
        }
        // Receita do produto
        const precoVenda = moedaParaNumero(p.precoVenda);
        const receita = quantidade * precoVenda;

        // Custos variáveis por produto
        const getPercent = campo => {
          const el = document.getElementById(`${campo}_produto_${idx}`);
          if (!el) return 0;
          return parseFloat(el.value.replace('%', '').replace(',', '.')) || 0;
        };
        const prodPerc = getPercent('producao');
        const impPerc = getPercent('imposto');
        const comPerc = getPercent('comissao');
        const cartPerc = getPercent('cartao');
        const outPerc = getPercent('outros');
        const custoVariavelUnit = precoVenda * (prodPerc + impPerc + comPerc + cartPerc + outPerc) / 100;
        const custoVariavelTotal = custoVariavelUnit * quantidade;

        // Lucro do produto no ano
        lucroAno += receita - custoVariavelTotal;
      });
      // Subtrai custos fixos anuais (apenas uma vez por ano)
      const custoFixoMensal = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");
      const custoFixoAnual = custoFixoMensal * 12;
      lucroAno -= custoFixoAnual;
      lucrosAnuais.push(lucroAno);
    }
  }

  // Calcula VPL de cada ano
  let vpls = [];
  for (let ano = 0; ano < anos; ano++) {
    const vpl = lucrosAnuais[ano] / Math.pow(1 + tma, ano);
    vpls.push(vpl);
  }

  // Saldo acumulado
  let saldos = [];
  for (let ano = 0; ano < anos; ano++) {
    if (ano === 0) {
      saldos.push(vpls[0]);
    } else {
      saldos.push(saldos[ano - 1] + vpls[ano]);
    }
  }

  // Monta tabela HTML centralizada e responsiva (apenas uma vez)
  let html = `
    <div style="display:flex; justify-content:center; width:100%;">
      <table class="resumo-produto" style="margin-top:10px; margin-bottom:30px; min-width:unset; width:auto; text-align:center;">
        <thead>
          <tr>
            <th style="text-align:center;">Ano</th>
            <th style="text-align:center;">Lucro Anual (R$)</th>
            <th style="text-align:center;">VPL (R$)</th>
            <th style="text-align:center;">Saldo Acumulado (R$)</th>
          </tr>
        </thead>
        <tbody>
  `;
  for (let ano = 0; ano < anos; ano++) {
    html += `
      <tr>
        <td style="text-align:center;">${ano}</td>
        <td style="text-align:center;">${lucrosAnuais[ano] < 0 ? '-' : ''}R$ ${Math.abs(lucrosAnuais[ano]).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align:center;">R$ ${vpls[ano].toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
        <td style="text-align:center;">R$ ${saldos[ano].toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
      </tr>
    `;
  }
  html += "</tbody></table></div>";

  // Indicadores abaixo da matriz
  // VPL = somatório da coluna VPL
  const vplTotal = vpls.reduce((a, b) => a + b, 0);

  // VPL Descontado (Payback Descontado)
  // Encontrar o ano em que o saldo muda de negativo para positivo
  let anoPayback = null;
  for (let i = 1; i < saldos.length; i++) {
    if (saldos[i - 1] < 0 && saldos[i] >= 0) {
      anoPayback = i;
      break;
    }
  }
  let vplDescontado = "-";
  let vplDescontadoMeses = "-";
  if (anoPayback !== null && anoPayback > 0) {
    const saldoAnterior = saldos[anoPayback - 1];
    const vplAnoPositivo = vpls[anoPayback];
    // Fórmula: ano anterior + (|saldo anterior| / VPL do primeiro ano positivo)
    vplDescontado = (anoPayback - 1) + (Math.abs(saldoAnterior) / vplAnoPositivo);
    vplDescontado = vplDescontado.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
    // Também calcula em meses
    vplDescontadoMeses = (parseFloat(vplDescontado.replace(',','.')) * 12).toLocaleString('pt-BR', { minimumFractionDigits: 0 });
  }

  // --- TIR (Taxa Interna de Retorno) ---
  // Tenta encontrar a taxa r que faz o VPL = 0
  function calcularTIR(fluxos) {
    // fluxos: array de fluxos de caixa, ano 0 até N
    // Retorna TIR em decimal (ex: 0.18 para 18%)
    let guess = 0.15; // chute inicial 15%
    let tol = 1e-6;
    let maxIter = 1000;
    let r = guess;
    let iter = 0;
    let diff = 1;
    function npv(rate) {
      let sum = 0;
      for (let t = 0; t < fluxos.length; t++) {
        sum += fluxos[t] / Math.pow(1 + rate, t);
      }
      return sum;
    }
    // Busca binária entre -0.99 e 20000 (ou 20000%)
    let low = 0, high = 20000;
    let npvLow = npv(low);
    let npvHigh = npv(high);
    if (npvLow * npvHigh > 0) return null; // Não há raiz no intervalo
    while (iter < maxIter && Math.abs(diff) > tol) {
      r = (low + high) / 2;
      let npvR = npv(r);
      if (Math.abs(npvR) < tol) break;
      if (npvLow * npvR < 0) {
        high = r;
        npvHigh = npvR;
      } else {
        low = r;
        npvLow = npvR;
      }
      diff = npvR;
      iter++;
    }
    return r;
  }
  // Calcula TIR usando os fluxos de caixa anuais
  let tir = calcularTIR(lucrosAnuais);
  let tirTexto = "Não atingido";
  if (tir !== null && isFinite(tir)) {
    tirTexto = (tir * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + "%";
  }

  // Adiciona os indicadores fora da matriz, cada um em sua linha igual ao checklist
  container.innerHTML += html;
  container.innerHTML += `
    <div style="margin-top: 10px; color:#fff; text-align:left; padding:0; border-radius:0; max-width:500px; margin-left:0;">
      <div style="margin-bottom:6px;"><strong>VPL Total:</strong> <span id="vpl">${"R$ " + vplTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
      <div style="margin-bottom:6px;"><strong>Payback Descontado:</strong> <span id="paybackDescontado">${vplDescontado !== "-" ? vplDescontado + " anos" : "Não atingido"}</span></div>
      <div style="margin-bottom:6px;"><strong>Payback Descontado Mês:</strong> <span id="paybackDescontadoMes">${vplDescontadoMeses !== "-" ? vplDescontadoMeses + " meses" : "Não atingido"}</span></div>
      <div style="margin-bottom:6px;"><strong>Taxa Interna de Retorno (TIR):</strong> <span id="tir">${tirTexto}</span></div>
    </div>
  `;

  // Atualiza campo oculto para uso em outros cálculos/checklist/pdf
  // Removido campo oculto tirAnual, usa-se o campo direto agora
  
  // Atualiza campos ocultos para PDF/checklist
  let vplInput = document.getElementById("vpl");
  if (!vplInput) {
    vplInput = document.createElement("span");
    vplInput.id = "vpl";
    vplInput.style.display = "none";
    document.body.appendChild(vplInput);
  }
  vplInput.innerText = "R$ " + vplTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

  let paybackDescInput = document.getElementById("paybackDescontado");
  if (!paybackDescInput) {
    paybackDescInput = document.createElement("input");
    paybackDescInput.type = "hidden";
    paybackDescInput.id = "paybackDescontado";
    document.body.appendChild(paybackDescInput);
  }
  paybackDescInput.value = vplDescontado !== "-" ? vplDescontado : "N/D";
}

document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    // Só gera a matriz se a etapa 4 existir no DOM
    if (document.getElementById("step4")) {
      gerarMatrizFluxoCaixa();
    }
  }, 500);
});
["input", "change"].forEach(evt =>
  document.addEventListener(evt, () => {
    setTimeout(() => {
      if (document.getElementById("step4")) {
        gerarMatrizFluxoCaixa();
      }
    }, 200);
  })
);
function calcularMargemSegurancaEIL() {
  // Função para converter moeda para número
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }

  // Receita Necessária no Ponto de Equilíbrio (campo gerado na etapa 4)
  // Extrai receitaNecessaria diretamente da função atualizarPontoEquilibrio
  let receitaNecessaria = 0;
  const campoCustoFixo = document.getElementById("custos_fixos_total");
  const campoMCPonderada = document.getElementById("mc_ponderada");
  if (campoCustoFixo && campoMCPonderada) {
    const custoFixo = moedaParaNumero(campoCustoFixo.value || "0");
    const mcPonderadaPerc = moedaParaNumero(campoMCPonderada.value || "0") / 100;
    if (mcPonderadaPerc > 0) {
      receitaNecessaria = custoFixo / mcPonderadaPerc;
    }
  }

  // Receita Média Mensal
  const receitaMensal = moedaParaNumero(document.getElementById("receita_mensal")?.value || "0");
  // Lucro Mensal
  const lucroMensal = moedaParaNumero(document.getElementById("lucro_mensal")?.value || "0");
  // Lucro Anual
  const lucroAnual = moedaParaNumero(document.getElementById("lucro_anual")?.value || "0");
  // Investimento Inicial
  const investimentoInicial = moedaParaNumero(document.getElementById("investimento_inicial")?.value || "0");

  // Margem de Segurança %
  let margemSeguranca = 0;
  if (receitaMensal > 0) {
    margemSeguranca = 1 - (receitaNecessaria / receitaMensal);
  }

  // IL %
  let il = 0;
  if (receitaMensal > 0) {
    il = lucroMensal / receitaMensal;
  }

  // Rentabilidade
  let rentabilidade = 0;
  if (investimentoInicial > 0) {
    rentabilidade = (lucroAnual + investimentoInicial) / investimentoInicial;
  }

  // Cria/atualiza campos ocultos para uso em checklist e PDF
  let campoMargem = document.getElementById("margemSeguranca");
  if (!campoMargem) {
    campoMargem = document.createElement("input");
    campoMargem.type = "hidden";
    campoMargem.id = "margemSeguranca";
    document.body.appendChild(campoMargem);
  }
  campoMargem.value = (margemSeguranca * 100).toFixed(2).replace('.', ',');

  let campoIL = document.getElementById("il");
  if (!campoIL) {
    campoIL = document.createElement("input");
    campoIL.type = "hidden";
    campoIL.id = "il";
    document.body.appendChild(campoIL);
  }
  campoIL.value = il.toFixed(2).replace('.', ',');

  let campoRent = document.getElementById("rentabilidade");
  if (!campoRent) {
    campoRent = document.createElement("input");
    campoRent.type = "hidden";
    campoRent.id = "rentabilidade";
    campoRent.style.marginBottom = "20px";
    document.body.appendChild(campoRent);
  } else {
    campoRent.style.marginBottom = "20px";
  }
  campoRent.value = (rentabilidade * 100).toFixed(2).replace('.', ',');

  // --- EXIBE OS CAMPOS NO HTML DA ETAPA 4 ---
  let container = document.getElementById("margem_seguranca_il_html");
  if (!container) {
    // Cria o container logo após o bloco de indicadores financeiros
    const ref = document.getElementById("calculoIndicadores");
    container = document.createElement("div");
    container.id = "margem_seguranca_il_html";
    container.className = "row";
    container.style.marginTop = "20px";
    if (ref && ref.parentNode) {
      ref.parentNode.insertBefore(container, ref.nextSibling);
    } else {
      document.getElementById("step4")?.appendChild(container);
    }
  }
  container.innerHTML = `
    <div class="form-group col-25">
      <label>Margem de Segurança (%)</label>
      <input type="text" class="readonly-clone" readonly value="${(margemSeguranca * 100).toFixed(2).replace('.', ',')}%" style="background:#111; color:#bbb; border:1px solid #333;">
    </div>
    <div class="form-group col-25">
      <label>Índice de Lucratividade (IL)</label>
      <input type="text" class="readonly-clone" readonly value="${(il*100).toFixed(2).replace('.', ',')}%" style="background:#111; color:#bbb; border:1px solid #333;">
    </div>
    <div class="form-group col-25">
      <label>Rentabilidade (%)</label>
      <input type="text" class="readonly-clone" readonly value="${(rentabilidade * 100).toFixed(2).replace('.', ',')}%" style="background:#111; color:#bbb; border:1px solid #333;">
    </div>
  `;
}

// Atualiza sempre que houver mudanças relevantes
["input", "change"].forEach(evt =>
  document.addEventListener(evt, () => {
    setTimeout(calcularMargemSegurancaEIL, 100);
  })
);

// Executa ao carregar a etapa 4
setTimeout(calcularMargemSegurancaEIL, 500);
</script>


 <!-- Etapa 5 -->
  <div class="step" id="step5">
  <h2>Análise Final</h2>
  <table>
    <thead>
      <tr>
        <th>Item</th>
        <th>Valor</th>
        <th>Referência</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>A empresa é lucrativa? (IL)</td>
        <td id="valor_il"></td>
        <td id="referencia_il">&gt; 1</td>
        <td id="check_il"></td>
      </tr>
      <tr>
        <td>O Payback atende à necessidade do cliente?</td>
        <td id="valor_payback_desc"></td>
        <td id="referencia_payback"></td>
        <td id="check_payback_desc"></td>
      </tr>
      <tr>
        <td>O ROI atende à expectativa do cliente?</td>
        <td id="valor_roi"></td>
        <td id="referencia_roi"></td>
        <td id="check_roi_final"></td>
      </tr>
      <tr>
        <td>A TIR supera a rentabilidade de uma aplicação conservadora? &gt; TMA</td>
        <td id="valor_tir_tma"></td>
        <td id="referencia_tir_tma"></td>
        <td id="check_tir_tma"></td>
      </tr>
          </tr>
    </tbody>
  </table>
  <div class="form-group col-100">
    <label for="avaliacao_final">Avaliação de Viabilidade Econômica:</label>
    <select id="avaliacao_final">
      <option value="">Selecione...</option>
      <option>Viável com Alta Rentabilidade</option>
      <option>Viável com Ajustes</option>
      <option>Pouco Viável no Momento</option>
      <option>Não Recomendado</option>
    </select>
  </div>

  <div class="form-group col-100" style="margin-top: 20px; text-align: center;">
    <button type="button" onclick="gerarPDFPersonalizado()" style="background-color:#3d4952; color:#fff; border:none; padding:10px 20px; border-radius:6px; font-size:16px; cursor:pointer;">
      📄 Gerar Relatório em PDF
    </button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function carregarImagemBase64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
  
}
// 1. Atualiza visual e dados do checklist
function atualizarChecklistFinal() {
  // Função para converter moeda/percentual para número
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }
  // Helper para formatar número com vírgula e duas casas
  function formatarNumero(num) {
    return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function formatarPercentual(num) {
    return formatarNumero(num) + "%";
  }

  // IL = Lucro Líquido / Receita Total
  let lucroAnual = moedaParaNumero(document.getElementById("lucro_anual")?.value || "0");
  let receitaAnual = moedaParaNumero(document.getElementById("receita_anual")?.value || "0");
  let il = receitaAnual > 0 ? lucroAnual / receitaAnual : 0;
  document.getElementById("valor_il").textContent = formatarNumero(il);
  document.getElementById("referencia_il").textContent = "> 1";
  document.getElementById("check_il").textContent = il > 1 ? "Sim" : "Não";

  // Payback Descontado (em meses)
  // Payback = Investimento Inicial / Lucro Mensal
  let investimentoInicial = moedaParaNumero(document.getElementById("investimento_inicial")?.value || "0");
  let lucroMensal = moedaParaNumero(document.getElementById("lucro_mensal")?.value || "0");
  let paybackDesc = lucroMensal > 0 ? investimentoInicial / lucroMensal : 0;
  let paybackDescStr = paybackDesc > 0 ? formatarNumero(paybackDesc) : "N/D";
  document.getElementById("valor_payback_desc").textContent = paybackDescStr;
  document.getElementById("referencia_payback").textContent = "<= 12 meses";
  document.getElementById("check_payback_desc").textContent = paybackDesc > 0 && paybackDesc <= 12 ? "Sim" : "Não";

  // ROI Mensal = Lucro Mensal / Investimento Inicial
  let roiMensal = investimentoInicial > 0 ? (lucroMensal / investimentoInicial) * 100 : 0;
  let retornoEsperado = moedaParaNumero(document.getElementById("taxa_esperada")?.value || "0");
  document.getElementById("valor_roi").textContent = formatarPercentual(roiMensal);
  document.getElementById("referencia_roi").textContent = "> " + formatarPercentual(retornoEsperado);
  document.getElementById("check_roi_final").textContent = roiMensal > retornoEsperado ? "Sim" : "Não";

    
    // Calcula TIR usando os fluxos de caixa anuais (lucrosAnuais)
    // Calcula lucrosAnuais localmente para o checklist
    let lucrosAnuais = [];
    const anos = 6; // Ano 0 até 5
    // Função para converter moeda para número já está definida acima
    lucrosAnuais.push(-investimentoInicial);
    for (let ano = 1; ano < anos; ano++) {
      let lucroAno = 0;
      produtos.forEach((p, idx) => {
        let quantidade = 0;
        const anoID = anosAdicionados[ano - 1];
        if (anoID) {
          for (let m = 0; m < 12; m++) {
            const input = document.getElementById(`${anoID}_produto_${idx}_mes_${m}`);
            if (input) quantidade += parseFloat(input.value) || 0;
          }
        }
        const precoVenda = moedaParaNumero(p.precoVenda);
        const receita = quantidade * precoVenda;
        const getPercent = campo => {
          const el = document.getElementById(`${campo}_produto_${idx}`);
          if (!el) return 0;
          return parseFloat(el.value.replace('%', '').replace(',', '.')) || 0;
        };
        const prodPerc = getPercent('producao');
        const impPerc = getPercent('imposto');
        const comPerc = getPercent('comissao');
        const cartPerc = getPercent('cartao');
        const outPerc = getPercent('outros');
        const custoVariavelUnit = precoVenda * (prodPerc + impPerc + comPerc + cartPerc + outPerc) / 100;
        const custoVariavelTotal = custoVariavelUnit * quantidade;
        lucroAno += receita - custoVariavelTotal;
      });
      const custoFixoMensal = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");
      const custoFixoAnual = custoFixoMensal * 12;
      lucroAno -= custoFixoAnual;
      lucrosAnuais.push(lucroAno);
    }
    // Função calcularTIR local
    function calcularTIR(fluxos) {
      let guess = 0.15;
      let tol = 1e-6;
      let maxIter = 1000;
      let r = guess;
      let iter = 0;
      let diff = 1;
      function npv(rate) {
        let sum = 0;
        for (let t = 0; t < fluxos.length; t++) {
          sum += fluxos[t] / Math.pow(1 + rate, t);
        }
        return sum;
      }
      let low = 0, high = 20000;
      let npvLow = npv(low);
      let npvHigh = npv(high);
      if (npvLow * npvHigh > 0) return null;
      while (iter < maxIter && Math.abs(diff) > tol) {
        r = (low + high) / 2;
        let npvR = npv(r);
        if (Math.abs(npvR) < tol) break;
        if (npvLow * npvR < 0) {
          high = r;
          npvHigh = npvR;
        } else {
          low = r;
          npvLow = npvR;
        }
        diff = npvR;
        iter++;
      }
      return r;
    }
    let tir = calcularTIR(lucrosAnuais);
    tir = tir !== null && isFinite(tir) ? tir * 100 : 0;
    let tma = moedaParaNumero(document.getElementById("taxa_tma")?.value || "0");
    // Máscara para percentual no formato 000.000.000,00%
    function mascaraPercentualBR(valor) {
      let num = Number(valor).toFixed(2).replace('.', ',');
      // Adiciona separador de milhar
      let partes = num.split(',');
      partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      return partes.join(',');
    }
    document.getElementById("valor_tir_tma").textContent = mascaraPercentualBR(tir) + "%";
    document.getElementById("referencia_tir_tma").textContent = "TIR > " + mascaraPercentualBR(tma) + "%";
    document.getElementById("check_tir_tma").textContent = tir > tma ? "Sim" : "Não";
}
document.addEventListener("input", atualizarChecklistFinal);
setTimeout(atualizarChecklistFinal, 500);

// 3. PDF SUPER COMPLETO
async function gerarPDFPersonalizado() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const imgBase64 = await carregarImagemBase64('./img/layout_canva.png');
  const margem = 15;
  let y = 20;

  // Função robusta para converter moeda para número
  function moedaParaNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }

  // Função para escrever campo (label + valor na mesma linha)
  const escreveCampo = (label, valor) => {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`${label}:`, margem, y);
    doc.setFont('helvetica', 'bold');
    doc.text(String(valor), margem + 70, y); // valor ao lado (ajuste 70 conforme largura desejada)
    doc.setFont('helvetica', 'normal');
    y += 7;
  };

  // Função para escrever título de seção
  const escreveTitulo = (titulo) => {
    doc.setFontSize(15);
    doc.setFont('helvetica', 'bold');
    doc.text(titulo, margem, y);
    y += 8;
  };

  // Função para escrever subtítulo
  const escreveSubtitulo = (subtitulo) => {
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(subtitulo, margem, y);
    y += 7;
  };

  // Função para nova página com fundo
  const novaPagina = () => {
    doc.addPage();
    doc.addImage(imgBase64, 'PNG', 0, 0, 210, 297);
    y = 20;
  };
  // Função para nova página sem fundo
  const novaPaginaSemFundo = () => {
    doc.addPage();
    y = 20;
  };

  doc.addImage(imgBase64, 'PNG', 0, 0, 210, 297);

  // ===== Pagina 01 =====
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text('1. Dados da Empresa', margem, y);
  y += 10;

  // Função para campo sem espaçamento entre label e valor
  const escreveCampoSimples = (label, valor) => {
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    doc.text(`${label}: ${String(valor)}`, margem, y);
    doc.setFont('helvetica', 'bold');
    y += 7;
  };

  escreveCampoSimples('Projeto', document.getElementById('nome')?.value || '');
  escreveCampoSimples('Responsável', document.getElementById('responsavel')?.value || '');
  escreveCampoSimples('E-mail', document.getElementById('email')?.value || '');
  escreveCampoSimples('Telefone', document.getElementById('telefone')?.value || '');
  escreveCampoSimples('Tipo', document.getElementById('tipo')?.value || '');
  escreveCampoSimples('Estado', document.getElementById('estado')?.value || '');
  escreveCampoSimples('Cidade', document.getElementById('cidade')?.value || '');

  // ===== Pagina 02 =====
  novaPagina();
  escreveTitulo('2. Custos e Investimentos');

  // 2.1 Descrição do Produto
  escreveSubtitulo('2.1 Descrição do Produto');
  produtos.forEach((p, idx) => {
    escreveCampo(`Produto ${String(idx + 1)}`, p.nome);
    escreveCampo('Custo Direto', p.custoR || 'R$ 0,00');
    escreveCampo('Preço de Venda', p.precoVenda || 'R$ 0,00');
    // Quantidade Venda Ano 01, Ano 02, etc.
    anosAdicionados.forEach((anoID, anoIdx) => {
      let quantidadeAno = 0;
      for (let m = 0; m < 12; m++) {
        const input = document.getElementById(`${anoID}_produto_${idx}_mes_${m}`);
        if (input) quantidadeAno += parseInt(input.value || 0);
      }
      escreveCampo(`Quantidade Venda Ano ${anoIdx + 1}`, `${quantidadeAno} Unidade${quantidadeAno !== 1 ? 's' : ''}`);
    });
    y += 2;
  });

  // 2.2 Investimento
  escreveSubtitulo('2.2 Investimento');
  escreveCampo('Investimento Inicial', document.getElementById('investimento_inicial')?.value || 'R$ 0,00');
  y += 2;

  // 2.3 Custos
  escreveSubtitulo('2.3 Custos');
  escreveCampo('Custos Fixos Mensal', document.getElementById('custos_fixos_total')?.value || 'R$ 0,00');
  escreveCampo('Custos Fixos Anual', document.getElementById('custos_fixos_anual')?.value || 'R$ 0,00');
  // Custos Variáveis Mensal e Anual
  // Mensal: soma dos custos variáveis convertidos por produto
  let custosVarMensal = 0, custosVarAnual = 0;
  produtos.forEach((p, idx) => {
    // Mensal: pega da seção "Custos Variáveis Convertidos por Produto (R$)"
    const bloco = document.querySelectorAll("#blocoCustosVariaveisRS .bloco-produto-custos")[idx];
    if (bloco) {
      const totalInput = bloco.querySelectorAll("input[readonly]");
      if (totalInput.length >= 6) {
        custosVarMensal += moedaParaNumero(totalInput[5].value);
      }
    }
    // Anual: pega da tabela resumo-produto (custos_variaveis_anuais)
    const tabela = document.querySelector("#custos_variaveis_anuais table.resumo-produto");
    if (tabela) {
      const linhas = tabela.querySelectorAll("tbody tr");
      if (linhas.length > idx) {
        const celulas = linhas[idx].querySelectorAll("td");
        if (celulas.length > 6) {
          custosVarAnual += moedaParaNumero(celulas[6].innerText);
        }
      }
    }
  });
  escreveCampo('Custos Variáveis Mensal', `R$ ${custosVarMensal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`);
  escreveCampo('Custos Variáveis Anual', `R$ ${custosVarAnual.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`);
  y += 2;

  // 2.4 Taxa de avaliação
  escreveSubtitulo('2.4 Taxa de avaliação');
  escreveCampo('Taxa de Desconto Composto Mês', document.getElementById('taxa_desconto_mensal')?.value || '%');
  escreveCampo('Taxa de Desconto Anual', document.getElementById('taxa_desconto_anual')?.value || '%');
  escreveCampo('Retorno Esperado', document.getElementById('taxa_esperada')?.value || '%');
  escreveCampo('Taxa Mínima de Atratividade - TMA', document.getElementById('taxa_tma')?.value || '%');
  y += 2;

  // 3. Receita e Projeção de Lucro
  escreveTitulo('3. Receita e Projeção de Lucro');
  escreveSubtitulo('3.1 Receitas e Lucros');
  escreveCampo('Receita Bruta Total', document.getElementById('receita_anual')?.value || 'R$ 0,00');
  escreveCampo('Receita Média Mensal', document.getElementById('receita_mensal')?.value || 'R$ 0,00');
  escreveCampo('Lucro Mensal', document.getElementById('lucro_mensal')?.value || 'R$ 0,00');
  escreveCampo('Lucro Anual', document.getElementById('lucro_anual')?.value || 'R$ 0,00');

  // ===== Pagina 03 =====
  novaPagina();
  escreveTitulo('4. Análise Financeira');
  escreveSubtitulo('4.1 Margem de Contribuição Unitária');
  escreveCampo('MCu Total', document.getElementById('margem_total')?.value || 'R$ 0,00');
  escreveCampo('MCu Anual', document.getElementById('mcu_anual')?.value || 'R$ 0,00');
  escreveCampo('MCu Mensal', document.getElementById('mcu_mensal')?.value || 'R$ 0,00');
  escreveCampo('MCu Ponderada', document.getElementById('mc_ponderada')?.value || '%');
  escreveCampo('Margem de Lucro', document.getElementById('margem_lucro')?.value || '%');
  escreveCampo('Preço Médio Ponderado Venda', document.getElementById('preco_medio_pond')?.value || 'R$ 0,00');
  // Participação Receita e Margem Contribuição por produto
  produtos.forEach((p, idx) => {
    // Participação Receita
    let partReceita = '';
    let margemContrib = '';
    // Busca na matriz de margem (tabela)
    const linhas = document.querySelectorAll("#margem_matriz tr");
    if (linhas.length > idx + 1) {
      const celulas = linhas[idx + 1].querySelectorAll("td");
      if (celulas.length > 5) {
        partReceita = celulas[1].innerText;
        margemContrib = celulas[5].innerText;
      }
    }
    escreveCampo(`Participação Receita - ${p.nome}`, partReceita || '%');
    escreveCampo(`Margem Contribuição - ${p.nome}`, margemContrib || '%');
  });
  y += 2;

  // 5. Ponto de Equilíbrio
  escreveTitulo('5. Ponto de Equilíbrio');
  escreveSubtitulo('5.1 Ponto de Equilíbrio Receita');
  // Receita Necessária e Média Ponderada
  let receitaNecessaria = '';
  let mediaPonderada = '';
  const peqDiv = document.getElementById('peq_individual');
  if (peqDiv) {
    const html = peqDiv.innerHTML;
    const matchReceita = html.match(/Receita Necessária[^:]*:\s*([^<]+)/i);
    const matchMedia = html.match(/Ponto de Equilibrio Média Ponderada[^:]*:\s*([^<]+)/i);
    receitaNecessaria = matchReceita ? matchReceita[1].trim() : '';
    mediaPonderada = matchMedia ? matchMedia[1].trim() : '';
  }
  escreveCampo('Receita Necessária', receitaNecessaria || 'R$ 0,00');
  escreveCampo('Média Ponderada', mediaPonderada || 'Unidade');
  y += 2;

  // 5.2 Ponto de Equilíbrio Unitário
  escreveSubtitulo('5.2 Ponto de Equilíbrio Unitário');
  produtos.forEach((p, idx) => {
    // Busca no peq_individual
    let qtd = '';
    const html = peqDiv?.innerHTML || '';
    const regex = new RegExp(`<strong>${p.nome}</strong> – Ponto de Equilibrio Quantidade: ([^<]+) unidades`, 'i');
    const match = html.match(regex);
    qtd = match ? match[1].trim() : '';
    escreveCampo(`Quantidade - ${p.nome}`, `${qtd || '0,00'} Unidade`);
  });
  y += 2;

  // 5.3 Ponto de Equilíbrio Distribuído
  escreveSubtitulo('5.3 Ponto de Equilíbrio Distribuído');
  produtos.forEach((p, idx) => {
    let qtd = '';
    const html = peqDiv?.innerHTML || '';
    const regex = new RegExp(`<strong>${p.nome}</strong> – Ponto de Equilíbrio Distribuído: ([^<]+) unidades`, 'i');
    const match = html.match(regex);
    qtd = match ? match[1].trim() : '';
    escreveCampo(`Quantidade - ${p.nome}`, `${qtd || '0,00'} Unidade`);
  });
  y += 2;

  // 6. Indicadores Financeiros
  escreveTitulo('6. Indicadores Financeiros');
  escreveSubtitulo('6.1 Indicadores');
  escreveCampo('ROI (%)', document.getElementById('ROI')?.value || '%');
  escreveCampo('ROI Mensal', document.getElementById('roiMensal')?.value || '%');
  escreveCampo('ROI Total', document.getElementById('roiTotal')?.value || '%');
  escreveCampo('Payback Mensal Simples', document.getElementById('paybackSimples')?.value || 'Meses');
  escreveCampo('Payback Anual Simples', document.getElementById('paybackAnual')?.value || 'Anos');
  escreveCampo('VPL Total', document.getElementById('vpl')?.innerText || 'R$ 0,00');
  escreveCampo('Payback Descontado', document.getElementById('paybackDescontado')?.value || 'Anos');
  escreveCampo('Payback Descontado Mês', document.getElementById('paybackDescontadoMes')?.innerText || 'Meses');
  escreveCampo('Taxa Interna de Retorno (TIR)', document.getElementById('tirAnual')?.value || '%');

  // ===== Pagina 04 =====
  novaPagina();
  escreveTitulo('7. Checklist e Avaliação');
  escreveSubtitulo('7.1 Checklist');
  // Checklist: pega da tabela da etapa 5
  const tabelaChecklist = document.querySelector('#step5 table');
  if (tabelaChecklist) {
    const linhas = tabelaChecklist.querySelectorAll('tbody tr');
    linhas.forEach(linha => {
      const tds = linha.querySelectorAll('td');
      if (tds.length >= 4) {
        // Escreve o item
        escreveCampoSimples(tds[0].innerText, '');
        // Escreve os valores embaixo, um por linha
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Valor: ${tds[1].innerText}`, margem + 5, y);
        y += 5;
        doc.text(`Referência: ${tds[2].innerText}`, margem + 5, y);
        y += 5;
        doc.text(`Status: ${tds[3].innerText}`, margem + 5, y);
        y += 8;
      }
    });
  }
  

  // ===== Pagina 05 =====
  novaPaginaSemFundo();
  escreveTitulo('8. Interpretação dos Indicadores');
  y += 2;

  // Função para remover máscara de percentual e moeda
  function desmascararNumero(str) {
    if (!str) return 0;
    return parseFloat(
      String(str)
        .replace(/R\$\s?/g, '')
        .replace(/%/g, '')
        .replace(/\./g, '')
        .replace(',', '.')
        .replace(/\s/g, '')
    ) || 0;
  }

  // Monta o texto interpretativo
  const textoResumo = [];
  const roi = desmascararNumero(document.getElementById("roiMensal")?.value) / 100;
  const paybackSimples = desmascararNumero(document.getElementById("paybackSimples")?.value);
  const paybackDesc = desmascararNumero(document.getElementById("paybackDescontado")?.value);
  const tirAnual = desmascararNumero(document.getElementById("tirAnual")?.value) / 100;
  const margemSeguranca = desmascararNumero(document.getElementById("margemSeguranca")?.value) / 100;
  const il = desmascararNumero(document.getElementById("il")?.value);
  // Definir lucroMensal corretamente
  const lucroMensal = (() => {
    const el = document.getElementById("lucro_mensal");
    if (!el) return 0;
    return desmascararNumero(el.value);
  })();
  // Corrige: converte todos os valores para percentual (exceto payback e IL) e formata para exibição
  function formatarPercentual(num) {
    return (num * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) + "%";
  }
  function formatarNumero(num) {
    return num.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  }

  const condicaoRuim = roi < 0.2 || paybackSimples > 12 || tirAnual < 0.2 || margemSeguranca < 0.2 || il < 1;

  if (condicaoRuim) {
    textoResumo.push(
      `O projeto, com ROI de ${formatarPercentual(roi)}, apresenta retorno abaixo do esperado, indicando baixa atratividade frente a outros investimentos. O payback simples é de ${formatarNumero(paybackSimples)} meses, e o descontado, ${formatarNumero(paybackDesc)} meses, ambos considerados longos e aumentando o risco. A TIR anual de ${formatarPercentual(tirAnual)} está abaixo do mínimo desejado, sugerindo rentabilidade limitada. A margem de contribuição e a margem de segurança, ambas baixas (${formatarPercentual(margemSeguranca)}), mostram que pequenas quedas nas vendas podem levar ao prejuízo. O índice de lucratividade (IL) de ${formatarNumero(il)} reforça que o capital poderia render mais em outras alternativas. Em resumo, o projeto exige ajustes para se tornar viável e competitivo.`
    );
  } else {
    textoResumo.push(
      `O projeto demonstra forte potencial, com ROI de ${formatarPercentual(roi)} e payback simples de ${formatarNumero(paybackSimples)} meses, indicando retorno rápido do investimento. O payback descontado, de ${formatarNumero(paybackDesc)} meses, confirma a atratividade mesmo considerando o valor do dinheiro no tempo. A TIR anual de ${formatarPercentual(tirAnual)} supera as expectativas do mercado, mostrando excelente capacidade de geração de valor. Margem de contribuição positiva e margem de segurança de ${formatarPercentual(margemSeguranca)} garantem folga operacional e resiliência a oscilações nas vendas. O índice de lucratividade (IL) de ${formatarNumero(il)} indica retorno eficiente para cada real investido. Assim, o projeto se destaca como uma opção sólida e rentável.`
    );
  }

  // Escreve o texto no PDF com formatação controlada
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');

  textoResumo.forEach(paragrafo => {
    if (paragrafo.trim() === "") return;

    const linhas = doc.splitTextToSize(paragrafo, 180);

    linhas.forEach(linha => {
      if (y > 270) {
        novaPaginaSemFundo();
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
      }
      try {
        doc.text(linha, margem, y, { align: 'justify', maxWidth: 180 });
      } catch {
        doc.text(linha, margem, y);
      }
      y += 6;
    });

    y += 2;
  });
  doc.save('Relatorio_Viabilidade_Economica.pdf');
}

function novaPagina() {
  doc.addPage();
  doc.addImage(imgBase64, 'PNG', 0, 0, 210, 297);
  y = 20; // reposiciona y se necessário
}
  function novaPaginaSemFundo() {
  doc.addPage();
  y = 20;
}


</script>
 

  <div class="buttons" id="navigationButtons" style="margin-top: 2px;"></div>
  </form> <!-- Fechamento correto do formulário -->
</div> 
  <script>
    function renderButtons(currentStep) {
      const container = document.getElementById('navigationButtons');
      container.innerHTML = '';

      // Só mostra o botão Limpar nos steps 0, 1, 2 (step 1, 2, 3 para o usuário)
      if (currentStep <= 2) {
        const limpar = document.createElement('button');
        limpar.textContent = 'Limpar';
        limpar.type = 'button';
        limpar.onclick = limparCamposEtapa;
        container.appendChild(limpar);
      }

      if (currentStep > 0) {
        const voltar = document.createElement('button');
        voltar.textContent = 'Voltar';
        voltar.type = 'button';
        voltar.onclick = prevStep;
        container.appendChild(voltar);
      }

      if (currentStep < document.querySelectorAll('.step').length - 1) {
        const proximo = document.createElement('button');
        proximo.textContent = 'Próximo';
        proximo.type = 'button';
        proximo.onclick = nextStep;
        container.appendChild(proximo);
      }
       if (currentStep === 4) {
        const salvar = document.createElement('button');
        salvar.textContent = 'Salvar';
        salvar.type = 'button';
        salvar.onclick = salvarAnalise;
        container.appendChild(salvar);
      }
    }
  

   function nextStep() {
  const steps = document.querySelectorAll(".step");

  for (let i = 0; i < steps.length; i++) {
    if (steps[i].classList.contains("active")) {

      // Validação apenas da Etapa 1 em diante
      if (i !== 0) {
        const requiredInputs = steps[i].querySelectorAll("input[required], select[required]");
        for (let j = 0; j < requiredInputs.length; j++) {
          if (!requiredInputs[j].value) {
            alert("Por favor, preencha todos os campos obrigatórios antes de continuar.");
            return;
          }
        }
      }

      // Remove a etapa atual
      steps[i].classList.remove("active");

      // Ativa a próxima etapa
      if (steps[i + 1]) {
        steps[i + 1].classList.add("active");
        renderButtons(i + 1);
        if (produtos.length === 0) {
  abrirModalProduto();
}

        // ✅ Etapa 03 – Executa os cálculos dos produtos
        if (steps[i + 1].id === 'step3') {
          atualizarReceitaProdutos();
          calcularCustosVariaveisEmReais();
          atualizarCustosFixosEVariaveis();
          atualizarCamposCustosVariaveisPorProduto();
          calcularCustosVariaveisAnual();
          
        }

        if (steps[i + 1].id === 'step4') {
  if (produtos && produtos.length > 0) {
    setTimeout(() => {
      atualizarMargemUnitáriaTotal();
      atualizarMargemUnitáriaPorProduto();
      atualizarPontoEquilibrio(); 
      calcularIndicadoresFinanceiros();
      atualizarMargemMensalPorProduto(); // ✅ chamada aqui // já chama atualizarReceitaEquilibrioPorProduto() internamente
    }, 100); // Pequeno delay para garantir DOM renderizado
  } else {
    console.warn("Lista de produtos está vazia ao entrar na Etapa 04.");
  }
}
      }
      break;
    }
  }
}
    function prevStep() {
      const steps = document.querySelectorAll(".step");
      for (let i = 0; i < steps.length; i++) {
        if (steps[i].classList.contains("active")) {
          steps[i].classList.remove("active");
          if (i - 1 >= 0) {
            steps[i - 1].classList.add("active");
            renderButtons(i - 1);
          }
          break;
        }
      }
    }

    function limparCamposEtapa() {
      const etapaAtual = document.querySelector('.step.active');
      const inputs = etapaAtual.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea, select');

      inputs.forEach(input => {
        if (input.tagName.toLowerCase() === 'select') {
          input.selectedIndex = 0;
        } else {
          input.value = '';
        }
      });
    }

    window.onload = () => {
      renderButtons(0);
  // Bloqueia letras em campos numéricos
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function () {
      this.value = this.value.replace(/[^0-9]/g, '');
    });
  });
};
    
document.addEventListener("input", function(e) {
      if (e.target.classList.contains("currency")) {
        let value = e.target.value.replace(/\D/g, "");
        value = (parseInt(value, 10) / 100).toFixed(2);
        e.target.value = value.replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      }
      // Removido cálculo manual de receita_mensal e receita_anual para evitar multiplicação errada por 12.
      // Use apenas calcularReceitaNova() para atualizar corretamente os valores.
});
     

    function numeroParaMoeda(num) {
      return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
  
  </script>
<script>
function moedaParaNumero(str) {
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }
// Máscara para moeda (R$)
document.querySelectorAll('input.currency[placeholder="R$"]').forEach(input => {
  input.addEventListener('input', () => {
    let val = input.value.replace(/\D/g, '');
    val = (parseInt(val) / 100).toFixed(2) + '';
    val = val.replace('.', ',');
    val = val.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    input.value = 'R$ ' + val;
  });
});
// Atualiza o cálculo dos custos variáveis em R$ sempre que um input da etapa 2 for alterado
document.querySelectorAll("#step2 input").forEach(input => {
  input.addEventListener("input", () => {
    calcularCustosVariaveisEmReais();
  });
});
// Corrige comportamento da máscara de percentual (%)
document.querySelectorAll('input.percent').forEach(input => {
  input.addEventListener('input', () => {
    let raw = input.value.replace(/\D/g, '');
    if (raw === '') {
      input.value = '';
      return;
    }

    let valor;

    if (raw.length <= 2) {
      valor = (parseInt(raw) / 10).toFixed(1).replace('.', ',');
    } else {
      valor = (parseInt(raw) / 100).toFixed(2).replace('.', ',');
        }
    input.value = valor;
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === "Backspace") {
      let val = input.value.replace(/\D/g, '');
      val = val.slice(0, -1);
      if (val === '') {
        input.value = '';
        e.preventDefault();
      }
    }
  });

  input.addEventListener('blur', () => {
    if (!input.value.includes('%') && input.value !== '') {
      input.value += '%';
    }
  });
});

</script>
<script>
 ["input", "change"].forEach(evt =>
  document.addEventListener(evt, () => {
    setTimeout(() => {
      atualizarCustosFixosEVariaveis();
      atualizarMargemUnitáriaPorProduto();
      atualizarMargemUnitáriaTotal();
      atualizarMargemMensalPorProduto();
      atualizarPontoEquilibrio();
      
    }, 50);
  })
);
 
</script>
<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCa-dgw5QA2QJbTrJykkOk0x1iJV1OiTvw",
    authDomain: "analiseviabilidadewa.firebaseapp.com",
    projectId: "analiseviabilidadewa",
    storageBucket: "analiseviabilidadewa.appspot.com",
    messagingSenderId: "705210629815",
    appId: "1:705210629815:web:2bd3bf2f281ae278335732",
    measurementId: "G-GMQSJW9JE2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function carregarProjetos() {
    const projetosRef = collection(db, "projetos");
    const q = query(projetosRef, orderBy("dataCadastro", "desc"));
    const querySnapshot = await getDocs(q);
    let html = "";
    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      html += `
        <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
          <strong>${data.nomeProjeto}</strong><br>
          Investimento: R$ ${data.investimento}<br>
          Receita: R$ ${data.receita}<br>
          ROI: ${data.roi}%<br>
          <button onclick="deletarProjeto('${docSnap.id}')">Excluir</button>
        </div>
      `;
    });
    document.getElementById("listaProjetos").innerHTML = html;
  }

  window.deletarProjeto = async function deletarProjeto(id) {
    if (confirm("Tem certeza que deseja excluir este projeto?")) {
      try {
        await deleteDoc(doc(db, "projetos", id));
        alert("Projeto excluído!");
        carregarProjetos();
      } catch (error) {
        console.error("Erro ao excluir:", error);
      }
    }
  };

  // Carrega os dados ao abrir a página
  window.addEventListener("DOMContentLoaded", carregarProjetos);

  window.salvarAnalise = async function salvarAnalise() {
    const nomeProjeto = document.getElementById("nome")?.value || "";
    const investimento = parseFloat((document.getElementById("investimento_inicial")?.value || "0").replace(/\D/g, '').replace(',', '.')) || 0;
    const receita = parseFloat((document.getElementById("receita_anual")?.value || "0").replace(/\D/g, '').replace(',', '.')) || 0;
    const roi = investimento > 0 ? ((receita - investimento) / investimento) * 100 : 0;

    try {
      // Coleta campos principais
      const responsavel = document.getElementById("responsavel")?.value || "";
      const tipo = document.getElementById("tipo")?.value || "";
      const estado = document.getElementById("estado")?.value || "";
      const cidade = document.getElementById("cidade")?.value || "";
      const email = document.getElementById("email")?.value || "";
      const telefone = document.getElementById("telefone")?.value || "";

      // Produtos cadastrados
      const produtosSalvos = (window.produtos || []).map((p, idx) => {
        // Quantidade por ano
        const quantidades = [];
        (window.anosAdicionados || []).forEach((anoID, anoIdx) => {
          let quantidadeAno = 0;
          for (let m = 0; m < 12; m++) {
            const input = document.getElementById(`${anoID}_produto_${idx}_mes_${m}`);
            if (input) quantidadeAno += parseInt(input.value || 0);
          }
          quantidades.push({ ano: anoIdx + 1, quantidade: quantidadeAno });
        });
        return {
          nome: p.nome,
          custoDireto: p.custoR,
          precoVenda: p.precoVenda,
          quantidades
        };
      });

      // Busca valores dos campos principais
      const custosFixosMensal = document.getElementById("custos_fixos_total")?.value || "";
      const custosFixosAnual = document.getElementById("custos_fixos_anual")?.value || "";
      const custosVariaveisMensal = (() => {
        let total = 0;
        (window.produtos || []).forEach((p, idx) => {
          const bloco = document.querySelectorAll("#blocoCustosVariaveisRS .bloco-produto-custos")[idx];
          if (bloco) {
            const totalInput = bloco.querySelectorAll("input[readonly]");
            if (totalInput.length >= 6) {
              let val = totalInput[5].value || "";
              total += parseFloat(String(val).replace(/\D/g, '').replace(',', '.')) || 0;
            }
          }
        });
        return "R$ " + total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      })();
      const custosVariaveisAnual = (() => {
        let total = 0;
        const tabela = document.querySelector("#custos_variaveis_anuais table.resumo-produto");
        if (tabela) {
          const linhas = tabela.querySelectorAll("tbody tr");
          linhas.forEach((linha, idx) => {
            const celulas = linha.querySelectorAll("td");
            if (celulas.length > 6) {
              let val = celulas[6].innerText || "";
              total += parseFloat(String(val).replace(/\D/g, '').replace(',', '.')) || 0;
            }
          });
        }
        return "R$ " + total.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      })();

      // Taxas
      const taxaDescontoMensal = document.getElementById("taxa_desconto_mensal")?.value || "";
      const taxaDescontoAnual = document.getElementById("taxa_desconto_anual")?.value || "";
      const taxaEsperada = document.getElementById("taxa_esperada")?.value || "";
      const taxaTMA = document.getElementById("taxa_tma")?.value || "";

      // Receitas e lucros
      const receitaBrutaTotal = document.getElementById("receita_anual")?.value || "";
      const receitaMediaMensal = document.getElementById("receita_mensal")?.value || "";
      const lucroMensal = document.getElementById("lucro_mensal")?.value || "";
      const lucroAnual = document.getElementById("lucro_anual")?.value || "";

      // Margens
      const mcuTotal = document.getElementById("margem_total")?.value || "";
      const mcuAnual = document.getElementById("mcu_anual")?.value || "";
      const mcuMensal = document.getElementById("mcu_mensal")?.value || "";
      const mcuPonderada = document.getElementById("mc_ponderada")?.value || "";
      const margemLucro = document.getElementById("margem_lucro")?.value || "";
      const precoMedioPond = document.getElementById("preco_medio_pond")?.value || "";

      // Participação receita e margem contribuição por produto
      const participacaoReceita = [];
      const margemContribuicao = [];
      const linhasMargem = document.querySelectorAll("#margem_matriz tr");
      (window.produtos || []).forEach((p, idx) => {
        let part = "", marg = "";
        if (linhasMargem.length > idx + 1) {
          const celulas = linhasMargem[idx + 1].querySelectorAll("td");
          if (celulas.length > 5) {
            part = celulas[1].innerText;
            marg = celulas[5].innerText;
          }
        }
        participacaoReceita.push({ produto: p.nome, valor: part });
        margemContribuicao.push({ produto: p.nome, valor: marg });
      });

      // Ponto de equilíbrio
      let receitaNecessaria = "";
      let mediaPonderada = "";
      const peqDiv = document.getElementById('peq_individual');
      if (peqDiv) {
        const html = peqDiv.innerHTML;
        const matchReceita = html.match(/Receita Necessária[^:]*:\s*([^<]+)/i);
        const matchMedia = html.match(/Ponto de Equilibrio Média Ponderada[^:]*:\s*([^<]+)/i);
        receitaNecessaria = matchReceita ? matchReceita[1].trim() : '';
        mediaPonderada = matchMedia ? matchMedia[1].trim() : '';
      }

      // Quantidade por produto (unitário e distribuído)
      const quantidadesUnitario = [];
      const quantidadesDistribuido = [];
      (window.produtos || []).forEach((p, idx) => {
        let qtdUnit = "", qtdDist = "";
        const html = peqDiv?.innerHTML || '';
        const regexUnit = new RegExp(`<strong>${p.nome}</strong> – Ponto de Equilibrio Quantidade: ([^<]+) unidades`, 'i');
        const regexDist = new RegExp(`<strong>${p.nome}</strong> – Ponto de Equilíbrio Distribuído: ([^<]+) unidades`, 'i');
        const matchUnit = html.match(regexUnit);
        const matchDist = html.match(regexDist);
        qtdUnit = matchUnit ? matchUnit[1].trim() : '';
        qtdDist = matchDist ? matchDist[1].trim() : '';
        quantidadesUnitario.push({ produto: p.nome, valor: qtdUnit });
        quantidadesDistribuido.push({ produto: p.nome, valor: qtdDist });
      });

      // Indicadores financeiros
      const roiPercent = document.getElementById("ROI")?.value || "";
      const roiMensal = document.getElementById("roiMensal")?.value || "";
      const roiTotal = document.getElementById("roiTotal")?.value || "";
      const paybackMensal = document.getElementById("paybackSimples")?.value || "";
      const paybackAnual = document.getElementById("paybackAnual")?.value || "";
      const vplTotal = document.getElementById("vpl")?.innerText || "";
      const paybackDescontado = document.getElementById("paybackDescontado")?.value || "";
      const paybackDescontadoMes = document.getElementById("paybackDescontadoMes")?.innerText || "";
      const tir = document.getElementById("tir")?.innerText || "";

      await addDoc(collection(db, "projetos"), {
        nomeProjeto,
        responsavel,
        tipo,
        estado,
        cidade,
        email,
        telefone,
        produtos: produtosSalvos,
        investimento,
        custosFixosMensal,
        custosFixosAnual,
        custosVariaveisMensal,
        custosVariaveisAnual,
        taxaDescontoMensal,
        taxaDescontoAnual,
        taxaEsperada,
        taxaTMA,
        receitaBrutaTotal,
        receitaMediaMensal,
        lucroMensal,
        lucroAnual,
        mcuTotal,
        mcuAnual,
        mcuMensal,
        mcuPonderada,
        margemLucro,
        precoMedioPond,
        participacaoReceita,
        margemContribuicao,
        receitaNecessaria,
        mediaPonderada,
        quantidadesUnitario,
        quantidadesDistribuido,
        roi: roiPercent,
        roiMensal,
        roiTotal,
        paybackMensal,
        paybackAnual,
        vplTotal,
        paybackDescontado,
        paybackDescontadoMes,
        tir,
        dataCadastro: new Date()
      });
      alert("Projeto salvo com sucesso!");
    } catch (error) {
      console.error("Erro ao salvar:", error);
    }
  }
</script>
</body>
</html>
