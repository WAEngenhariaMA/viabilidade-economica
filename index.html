<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WA Engenharia – Analisador de Viabilidade Econômica</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 50px auto;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
    }
    h1 {
      text-align: center;
      color: #00bcd4;
      margin-bottom: 10px;
      font-size: 30px;
    }
    h2 {
      text-align: left;
      margin-top: 40px;
      font-size: 21px;
      color: #fff;
      margin-bottom: 20px;
      font-weight: 400;
    }
    h4 {
      text-align: left;
      margin-top: 20px;
      font-size: 18px;
      color: #fff;
      margin-bottom: 20px;
      font-weight: 400;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1px;
      margin-bottom: 15px;
    }
    .row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .col-100 {
      flex: 1 1 100%;
    }
    .col-66 {
      flex: 1 1 64%;
    }
    .col-50 {
      flex: 1 1 48%;
    }
    .col-33 {
      flex: 1 1 30%;
    }
    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      box-sizing: border-box;
      margin-top: 2px;
    }
    .buttons {
      margin-top: 20px;
      text-align: right;
    }
    button {
      padding: 10px 20px;
      background-color: #00bcd4;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #0193a3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WA Engenharia – Analisador de Viabilidade Econômica</h1>
    <form id="viabilidadeForm">
      <!-- ETAPA 01 - DADOS GERAIS DO PROJETO -->
      <div class="step active" id="step1">
  <h2>Dados Gerais do Projeto</h2>

  <div class="form-group col-100">
    <label for="nome">Nome do Projeto/Empresa:</label>
    <input type="text" id="nome" name="nome" required>
  </div>

  <div class="row">
    <div class="form-group col-33">
      <label for="tipo">Tipo de Atividade:</label>
      <select id="tipo" name="tipo" required>
        <option value="">Selecione...</option>
        <option value="Construção Civil">Construção Civil</option>
        <option value="Serviços Técnicos Profissionais">Serviços Técnicos Profissionais</option>
        <option value="Comércio e Varejo">Comércio e Varejo</option>
        <option value="Indústria e Produção">Indústria e Produção</option>
        <option value="Estética, Saúde e Bem-Estar">Estética, Saúde e Bem-Estar</option>
        <option value="Eventos, Campeonatos e Produções">Eventos, Campeonatos e Produções</option>
        <option value="Negócios Digitais e Tecnologia">Negócios Digitais e Tecnologia</option>
        <option value="Alimentação, Bares e Delivery">Alimentação, Bares e Delivery</option>
        <option value="Franquias e Modelos Licenciados">Franquias e Modelos Licenciados</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="estado">Estado:</label>
      <select id="estado" name="estado" required></select>
    </div>

    <div class="form-group col-33">
      <label for="cidade">Cidade:</label>
      <select id="cidade" name="cidade" required></select>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-33">
      <label for="estrutura">Estrutura:</label>
      <select id="estrutura" name="estrutura" required>
        <option value="">Selecione...</option>
        <option value="Física">Física</option>
        <option value="Virtual">Virtual</option>
        <option value="Híbrida">Híbrida</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="regime">Regime Tributário:</label>
      <select id="regime" name="regime">
        <option value="">Não se aplica / Não definido</option>
        <option value="MEI">MEI</option>
        <option value="Simples Nacional">Simples Nacional</option>
        <option value="Lucro Presumido">Lucro Presumido</option>
        <option value="Lucro Real">Lucro Real</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="situacao">Situação Atual:</label>
      <select id="situacao" name="situacao" required>
        <option value="">Selecione...</option>
        <option value="Planejamento">Planejamento</option>
        <option value="Em operação">Em operação</option>
        <option value="Em expansão">Em expansão</option>
      </select>
    </div>
  </div>

  <div class="form-group col-100">
    <label for="responsavel">Responsável:</label>
    <input type="text" id="responsavel" name="responsavel" required>
  </div>

 <div class="row">
  <div class="form-group col-66">
    <label for="email">E-mail:</label>
    <input type="email" id="email" name="email" required>
  </div>

  <div class="form-group col-33">
    <label for="telefone">Telefone:</label>
    <input type="tel" id="telefone" name="telefone" placeholder="(00) 00000-0000" required>
  </div>
</div>
</div>
<script>
  // Lista de estados e cidades (exemplo parcial)
  const estadosECidades = {
  "AC": ["Rio Branco", "Cruzeiro do Sul", "Sena Madureira"],
  "AL": ["Maceió", "Arapiraca", "Palmeira dos Índios"],
  "AP": ["Macapá", "Santana", "Laranjal do Jari"],
  "AM": ["Manaus", "Parintins", "Itacoatiara"],
  "BA": ["Salvador", "Feira de Santana", "Vitória da Conquista"],
  "CE": ["Fortaleza", "Caucaia", "Juazeiro do Norte"],
  "DF": ["Brasília"],
  "ES": ["Vitória", "Vila Velha", "Serra"],
  "GO": ["Goiânia", "Aparecida de Goiânia", "Anápolis"],
  "MA": ["São Luís", "Imperatriz", "Caxias"],
  "MT": ["Cuiabá", "Várzea Grande", "Rondonópolis"],
  "MS": ["Campo Grande", "Dourados", "Três Lagoas"],
  "MG": ["Belo Horizonte", "Uberlândia", "Contagem"],
  "PA": ["Belém", "Santarém", "Ananindeua"],
  "PB": ["João Pessoa", "Campina Grande", "Patos"],
  "PR": ["Curitiba", "Londrina", "Maringá"],
  "PE": ["Recife", "Jaboatão dos Guararapes", "Olinda"],
  "PI": ["Teresina", "Parnaíba", "Picos"],
  "RJ": ["Rio de Janeiro", "Niterói", "Duque de Caxias"],
  "RN": ["Natal", "Mossoró", "Parnamirim"],
  "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas"],
  "RO": ["Porto Velho", "Ji-Paraná", "Ariquemes"],
  "RR": ["Boa Vista"],
  "SC": ["Florianópolis", "Joinville", "Blumenau"],
  "SP": ["São Paulo", "Campinas", "Santos"],
  "SE": ["Aracaju", "Nossa Senhora do Socorro", "Lagarto"],
  "TO": ["Palmas", "Araguaína", "Gurupi"]
};

  const estadoSelect = document.getElementById('estado');
  const cidadeSelect = document.getElementById('cidade');

  for (const estado in estadosECidades) {
    const option = document.createElement('option');
    option.value = estado;
    option.textContent = estado;
    estadoSelect.appendChild(option);
  }

  estadoSelect.addEventListener('change', () => {
    const cidades = estadosECidades[estadoSelect.value] || [];
    cidadeSelect.innerHTML = '';
    cidades.forEach(cidade => {
      const opt = document.createElement('option');
      opt.value = cidade;
      opt.textContent = cidade;
      cidadeSelect.appendChild(opt);
    });
  });

  // Máscara para telefone
  document.getElementById('telefone').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '').slice(0, 11);
    v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    e.target.value = v;
  });
</script>
<!-- ETAPA 02 COMPLETA (HTML + JS) -->
<div class="step" id="step2">
  <h2>Custos e Investimentos</h2>

  <!-- PRODUTOS -->
  <h3 style="color:#00bcd4;">1.1 Produto – Descrição do Produto</h3>
  <button type="button" onclick="abrirModalProduto()">+ Cadastrar Novo Produto</button>
  <table id="tabelaProdutos" style="margin-top:10px;width:100%;color:#fff;text-align:center;">
    <thead>
      <tr><th style="text-align:center;">Produto</th><th style="text-align:center;">Custo Direto (R$)</th><th style="text-align:center;">Custo Direto (%)</th><th style="text-align:center;">Preço de Venda (R$)</th><th style="text-align:center;">Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- MODAL PRODUTO -->
  <div id="modalProduto" style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#222;padding:20px;border-radius:10px;z-index:1000;width:90%;max-width:500px;">
    <h3 style="color:#00bcd4;">Novo Produto</h3>
    <label>Nome do Produto:</label>
    <input type="text" id="novoProdutoNome">
    <label>Custo Direto (R$):</label>
    <input type="text" id="novoCustoMonetario" class="currency"  placeholder="R$">
    <label>Custo Direto (%):</label>
    <input type="text" id="novoCustoPercentual" class="percent" placeholder="%">
    <label>Preço de Venda Pretendido (R$):</label>
    <input type="text" id="novoPrecoVenda" class="currency" placeholder="R$">
    <button type="button" onclick="abrirModalPreco()" style="margin-top: 10px;">Calcular Preço de Venda</button>
    <div style="text-align:right;margin-top:5px;">
      <button type="button" onclick="salvarProduto()">Salvar</button>
      <button type="button" onclick="fecharModalProduto()">Cancelar</button>
    </div>
  </div>

  <!-- MODAL PREÇO VENDA (MAIOR JANELA) -->
  <div id="modalPreco" style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#222;padding:30px;border-radius:12px;z-index:2000;width:95%;max-width:700px;">
    <h3 style="color:#00bcd4;">Cálculo do Preço de Venda</h3>
    <label>Custos Totais (R$):</label>
    <input type="text" id="preco_custo_calc" class="currency"  placeholder="R$">
    <label>Margem de Lucro Desejada (%):</label>
    <input type="text" id="margem_lucro_calc" class="percent" placeholder="%">
    <label>Preço da Concorrência (R$):</label>
    <input type="text" id="concorrencia_calc" class="currency" placeholder="R$">
    <div style="text-align:right;margin-top:10px;">
      <button type="button" onclick="calcularPrecoVenda()">Calcular</button>
      <button type="button" onclick="fecharModalPreco()">Cancelar</button>
    </div>
  </div>

  <!-- INVESTIMENTO INICIAL -->
  <h3 style="color:#00bcd4;">2. Investimento Inicial</h3>
  <div class="row">
    <div class="form-group col-33"><label>Criação de Marca e Registro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Abertura de Empresa e Licenças (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Consultorias (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Estoque Inicial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Equipamentos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Imobilizados (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Capital de Giro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>

  <!-- CUSTOS VARIÁVEIS -->
  <h3 style="color:#00bcd4;">3. Custos Variáveis</h3>
  <div class="row">
    <div class="form-group col-50"><label>Custos com Produção (%):</label><input type="text" id="auto_custo_prod" placeholder="%" readonly></div>
    <div class="form-group col-50"><label>Impostos (%):</label><input type="text" class="percent" placeholder="%"></div>
    <div class="form-group col-33"><label>Comissão de Vendas (%):</label><input type="text" class="percent" placeholder="%"></div>
    <div class="form-group col-33"><label>Tarifas de Cartão (%):</label><input type="text" class="percent" placeholder="%"></div>
    <div class="form-group col-33"><label>Outros (%):</label><input type="text" class="percent" placeholder="%"></div>
  </div>

  <!-- CUSTOS FIXOS -->
  <h3 style="color:#00bcd4;">4. Custos Mensais Fixos</h3>
  <h4>Despesas Administrativas</h4>
  <div class="row">
    <div class="form-group col-50"><label>Aluguel (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Energia (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Salários (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Internet (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Comerciais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Combustível (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Salários Equipe Comercial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Operacionais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Despesa 1 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Despesa 2 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>

  <!-- PLANO COMERCIAL -->
  <h3 style="color:#00bcd4;">5. Plano Comercial</h3>
  <label>Público-Alvo:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Diferenciais do Produto:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Possíveis Concorrentes:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  
  <label>Taxa de Crescimento Mensal (%):</label><input type="text" class="percent" placeholder="%">
</div>
<script>
let produtos = [];
function abrirModalProduto() {
  document.getElementById("modalProduto").style.display = 'block';
}
function fecharModalProduto() {
  document.getElementById("modalProduto").style.display = 'none';
  document.getElementById("novoProdutoNome").value = '';
  document.getElementById("novoCustoMonetario").value = '';
  document.getElementById("novoCustoPercentual").value = '';
  document.getElementById("novoPrecoVenda").value = '';
}
function salvarProduto() {
  const nome = document.getElementById("novoProdutoNome").value;
  const custoR = document.getElementById("novoCustoMonetario").value;
  const custoP = document.getElementById("novoCustoPercentual").value;
  const precoVenda = document.getElementById("novoPrecoVenda").value;

  if (nome && precoVenda) {
    produtos.push({ nome, custoR, custoP, precoVenda });
    atualizarTabelaProdutos();
    fecharModalProduto();
  } else {
    alert("Preencha pelo menos o nome do produto e o preço de venda.");
  }
}

function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  const volumeDiv = document.getElementById("volumeProdutos"); // Caso use essa parte
  const custoProdField = document.getElementById("auto_custo_prod"); // Campo automático de custos com produção

  tbody.innerHTML = "";
  if (volumeDiv) volumeDiv.innerHTML = "";

  let somaCustosDiretos = 0;
  let somaPrecosVenda = 0;

  produtos.forEach((p, index) => {
    // Adiciona à tabela
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.nome}</td>
      <td>${p.custoR}</td>
      <td>${p.custoP}</td>
      <td>${p.precoVenda}</td>
      <td><button type="button" onclick="removerProduto(${index})">Excluir</button></td>
    `;
    tbody.appendChild(row);

    // Campo de volume por produto (caso deseje exibir)
    if (volumeDiv) {
      volumeDiv.innerHTML += `
        <div class="row" style="margin-bottom: 10px; align-items: center;">
          <div class="col-50"><label>${p.nome}</label></div>
          <div class="col-50">
            <input type="number" class="volumeProdutoInput" data-index="${index}" min="0" style="width: 100%; padding: 6px;" />
          </div>
        </div>
      `;
    }

    // Cálculo acumulado dos custos e preços
    const custo = parseFloat(p.custoR.replace(/\./g, '').replace(',', '.')) || 0;
    const preco = parseFloat(p.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;
    somaCustosDiretos += custo;
    somaPrecosVenda += preco;
  });

  // Cálculo final do campo automático de custo de produção (%)
  if (custoProdField) {
    const custoProducaoPercentual = somaPrecosVenda > 0 ? (somaCustosDiretos / somaPrecosVenda) * 100 : 0;
    custoProdField.value = custoProducaoPercentual.toFixed(1).replace('.', ',') + '%';
  }
}

function removerProduto(index) {
  produtos.splice(index, 1);
  atualizarTabelaProdutos();
}
function abrirModalPreco() {
  document.getElementById("modalPreco").style.display = 'block';
}
function fecharModalPreco() {
  document.getElementById("modalPreco").style.display = 'none';
}
function calcularPrecoVenda() {
  const custo = parseFloat(document.getElementById("preco_custo_calc").value.replace(',', '.')) || 0;
  const margem = parseFloat(document.getElementById("margem_lucro_calc").value.replace(',', '.')) || 0;
  const precoCalculado = custo * (1 + margem / 100);
  document.getElementById("novoPrecoVenda").value = precoCalculado.toFixed(2).replace('.', ',');
  fecharModalPreco();
}
</script>

<!-- ETAPA 03 COMPLETA (HTML + JS Corrigido) -->
<div class="step" id="step3">
  <h2>Etapa 03 – Receita e Projeção de Lucro</h2>

  <!-- RECEITA ESPERADA -->
  <h3 style="color:#00bcd4;">Receita Esperada</h3>
  <div class="row" id="receitaProdutos"></div>

  <div class="form-group col-50">
    <label>Receita Bruta Mensal (R$):</label>
    <input type="text" id="receita_mensal" class="currency" readonly>
  </div>
  <div class="form-group col-50">
    <label>Receita Anual Estimada (R$):</label>
    <input type="text" id="receita_anual" class="currency" readonly>
  </div>

  <!-- RECEITA POR CENÁRIOS -->
  <h3 style="color:#00bcd4;">Receita por Cenários</h3>
  <div id="receitaCenarios"></div>

  <!-- PROJEÇÃO DE LUCRO -->
  <h3 style="color:#00bcd4;">Projeção de Lucro</h3>
  <div class="form-group col-50">
    <label>Custos Fixos (R$):</label>
    <input type="text" id="custos_fixos_total" class="currency" readonly>
  </div>
  <div class="form-group col-50">
    <label>Custos Variáveis (R$):</label>
    <input type="text" id="custos_variaveis_total" class="currency" readonly>
  </div>
  <div class="form-group col-50">
    <label>Investimento Inicial (R$):</label>
    <input type="text" id="totalInvestimento" class="currency" readonly>
  </div>
</div>

<script>
function atualizarReceita() {
  let receitaMensal = 0;
  const produtosDiv = document.getElementById("receitaProdutos");
  produtosDiv.innerHTML = "";

  produtos.forEach((p, i) => {
    const volumeInput = document.createElement("input");
    volumeInput.type = "number";
    volumeInput.placeholder = "Unidades por mês";
    volumeInput.className = "volumeProdutoInput";
    volumeInput.setAttribute("data-index", i);
    volumeInput.oninput = (e) => {
  produtos[i].volume = parseInt(e.target.value) || 0;
  atualizarReceita();
};
    const label = document.createElement("label");
    label.innerText = `${p.nome} (R$${p.precoVenda}):`;

    const wrapper = document.createElement("div");
    wrapper.className = "form-group col-50";
    wrapper.appendChild(label);
    wrapper.appendChild(volumeInput);
    produtosDiv.appendChild(wrapper);
  });

  document.querySelectorAll(".volumeProdutoInput").forEach((input, i) => {
    const volume = parseInt(input.value) || 0;
    const preco = moedaParaNumero(produtos[i].precoVenda || "0");
    receitaMensal += volume * preco;
  });

  document.getElementById("receita_mensal").value = numeroParaMoeda(receitaMensal);
  document.getElementById("receita_anual").value = numeroParaMoeda(receitaMensal * 12);

  atualizarReceitaCenarios();
  atualizarCustosFixosVariaveis();
}

function atualizarReceitaCenarios() {
  const cenariosDiv = document.getElementById("receitaCenarios");
  cenariosDiv.innerHTML = "";

  produtos.forEach((p, i) => {
    const preco = moedaParaNumero(p.precoVenda || "0");

    const pessInput = document.createElement("input");
    const realInput = document.createElement("input");
    const otiInput = document.createElement("input");

    pessInput.type = realInput.type = otiInput.type = "number";
    pessInput.placeholder = "Unidades Pessimista";
    realInput.placeholder = "Unidades Realista";
    otiInput.placeholder = "Unidades Otimista";

    pessInput.oninput = realInput.oninput = otiInput.oninput = () => atualizarReceitaCenarios();

    const pessOutput = document.createElement("input");
    const realOutput = document.createElement("input");
    const otiOutput = document.createElement("input");
    pessOutput.readOnly = realOutput.readOnly = otiOutput.readOnly = true;
    pessOutput.className = realOutput.className = otiOutput.className = "currency";

    const receitaP = (parseInt(pessInput.value) || 0) * preco;
    const receitaR = (parseInt(realInput.value) || 0) * preco;
    const receitaO = (parseInt(otiInput.value) || 0) * preco;

    pessOutput.value = numeroParaMoeda(receitaP);
    realOutput.value = numeroParaMoeda(receitaR);
    otiOutput.value = numeroParaMoeda(receitaO);

    const bloco = document.createElement("div");
    bloco.innerHTML = `
      <h4 style="margin-top:10px;">${p.nome}</h4>
      <div class="row">
        <div class="form-group col-50">
          <label>Unidades - Pessimista:</label>
          ${pessInput.outerHTML}
          <label>Receita Pessimista (R$):</label>
          ${pessOutput.outerHTML}
        </div>
        <div class="form-group col-50">
          <label>Unidades - Realista:</label>
          ${realInput.outerHTML}
          <label>Receita Realista (R$):</label>
          ${realOutput.outerHTML}
        </div>
        <div class="form-group col-50">
          <label>Unidades - Otimista:</label>
          ${otiInput.outerHTML}
          <label>Receita Otimista (R$):</label>
          ${otiOutput.outerHTML}
        </div>
      </div>
    `;
    cenariosDiv.appendChild(bloco);
  });
}

function atualizarCustosFixosVariaveis() {
  let totalFixos = 0;
  let totalVariaveis = 0;

  document.querySelectorAll(".currency").forEach(input => {
    const label = input.previousElementSibling?.textContent || "";
    const val = moedaParaNumero(input.value || "0");
    if (label.includes("(R$)")) totalFixos += val;
    if (label.includes("(%)")) totalVariaveis += val;
  });

  document.getElementById("custos_fixos_total").value = numeroParaMoeda(totalFixos);
  document.getElementById("custos_variaveis_total").value = numeroParaMoeda(totalVariaveis);

  const investimentos = document.querySelectorAll('#step2 input.currency');
  let totalInv = 0;
  investimentos.forEach(input => {
    const label = input.previousElementSibling?.textContent || "";
    if (label.includes("Investimento") || label.includes("Marca") || label.includes("Estoque") || label.includes("Capital")) {
      totalInv += moedaParaNumero(input.value || "0");
    }
  });
  document.getElementById("totalInvestimento").value = numeroParaMoeda(totalInv);
}

document.addEventListener("DOMContentLoaded", () => {
  atualizarReceita();
});
</script>

<!-- ETAPA 04 - MÓDULO 02: ANÁLISE -->
<div class="step" id="step4">
  <h2>Etapa 04 – Módulo 02: Análise</h2>

  <!-- 6. Margem de Contribuição -->
  <div class="bloco">
    <h3>6. Margem de Contribuição</h3>

    <!-- 6.1 Unitária -->
    <div class="subbloco">
      <h4>6.1. Margem de Contribuição Unitária (por produto)</h4>
      <div id="margemUnitTable"></div>
    </div>

    <!-- 6.2 Total -->
    <div class="subbloco">
      <h4>6.2. Margem de Contribuição Total</h4>
      <input type="text" id="margem_contribuicao_total" class="currency" readonly>
    </div>

    <!-- 6.3 Ponderada -->
    <div class="subbloco">
      <h4>6.3. Margem de Contribuição Ponderada</h4>
      <input type="text" id="margemPonderada" class="currency" readonly placeholder="Aguardando fórmula...">
    </div>
  </div>

  <!-- 7. Ponto de Equilíbrio -->
  <div class="bloco">
    <h3>7. Ponto de Equilíbrio</h3>
    <div class="form-group col-50">
      <label>Ponto de Equilíbrio (R$):</label>
      <input type="text" id="ponto_equilibrio" class="currency" readonly>
    </div>
  </div>

  <!-- 8. ROI -->
  <div class="bloco">
    <h3>8. ROI (Retorno Sobre Investimento)</h3>
    <div class="form-group col-50">
      <label>ROI (%):</label>
      <input type="text" id="roi" readonly>
    </div>
  </div>

  <!-- 9. PAYBACK -->
  <div class="bloco">
    <h3>9. Payback Simples</h3>
    <div class="form-group col-50">
      <label>Payback (meses):</label>
      <input type="text" id="payback" readonly>
    </div>
  </div>
</div>

<script>
function atualizarMargemUnitTable() {
  const tableDiv = document.getElementById("margemUnitTable");
  tableDiv.innerHTML = "";

  if (produtos.length === 0) {
    tableDiv.innerHTML = "<p style='color:#ccc;'>Nenhum produto cadastrado.</p>";
    return;
  }

  let totalMargem = 0;
  let totalVenda = 0;
  let totalCustoVariavel = 0;

  let html = "<table style='width:100%; text-align:center; color:#fff; margin-top:10px;'>";
  html += "<tr><th>Produto</th><th>Margem Unitária (R$)</th></tr>";

  produtos.forEach(p => {
    const preco = moedaParaNumero(p.precoVenda || "0");
    const custo = moedaParaNumero(p.custoDiretoReais || "0");
    const impostos = moedaParaNumero(document.getElementById("impostos")?.value || "0");
    const comissao = moedaParaNumero(document.getElementById("comissao_vendas")?.value || "0");
    const cartao = moedaParaNumero(document.getElementById("tarifas_cartao")?.value || "0");
    const outros = moedaParaNumero(document.getElementById("outros_variaveis")?.value || "0");
    const volume = parseFloat(p.volume || 0);

    const totalVariavelUnit = custo + (preco * (impostos + comissao + cartao + outros) / 100);
    const margemUnit = preco - totalVariavelUnit;

    html += `<tr><td>${p.nome}</td><td>R$ ${numeroParaMoeda(margemUnit)}</td></tr>`;

    totalMargem += margemUnit * volume;
    totalVenda += preco * volume;
    totalCustoVariavel += totalVariavelUnit * volume;
  });

  html += "</table>";
  tableDiv.innerHTML = html;

  // 6.2 Margem de Contribuição Total
  document.getElementById("margem_contribuicao_total").value = `R$ ${numeroParaMoeda(totalMargem)}`;

  // 7. Ponto de Equilíbrio
  const custoFixo = moedaParaNumero(document.getElementById("totalCustosFixos")?.value || "0");
  const pontoEquilibrio = totalMargem !== 0 ? custoFixo / totalMargem : 0;
  document.getElementById("ponto_equilibrio").value = `R$ ${numeroParaMoeda(custoFixo / (totalMargem / totalVenda))}`;

  // 8. ROI
  const investimento = moedaParaNumero(document.getElementById("totalInvestimento")?.value || "0");
  const lucro = totalMargem - custoFixo;
  const roi = investimento !== 0 ? ((lucro - investimento) / investimento) * 100 : 0;
  document.getElementById("roi").value = `${roi.toFixed(2)}%`;

  // 9. Payback
  const saldoMensal = totalMargem - custoFixo;
  const payback = saldoMensal !== 0 ? investimento / saldoMensal : 0;
  document.getElementById("payback").value = payback.toFixed(1);
}

document.addEventListener("input", atualizarMargemUnitTable);
</script>
 <!-- Etapa 5 -->
  <div class="step" id="step5">
  <h2>Análise Final e Observações</h2>
  <table>
    <thead>
      <tr><th>Item</th><th>Status (Sim/Não)</th></tr>
    </thead>
    <tbody>
      <tr><td>Receita cobre os custos fixos?</td><td id="check_receita"></td></tr>
      <tr><td>Projeto tem ROI acima de 20%?</td><td id="check_roi"></td></tr>
      <tr><td>Payback abaixo de 12 meses?</td><td id="check_payback"></td></tr>
      <tr><td>Fluxo de caixa positivo nos 6 primeiros meses?</td><td id="check_fluxo"></td></tr>
    </tbody>
  </table>
  <div class="form-group col-100">
    <label for="avaliacao_final">Avaliação de Viabilidade Econômica:</label>
    <select id="avaliacao_final">
      <option value="">Selecione...</option>
      <option>Viável com Alta Rentabilidade</option>
      <option>Viável com Ajustes</option>
      <option>Pouco Viável no Momento</option>
      <option>Não Recomendado</option>
    </select>
  </div>

  <div class="form-group col-100" style="margin-top: 20px; text-align: center;">
    <button type="button" onclick="gerarPDFPersonalizado()" style="background-color:#00bcd4; color:#fff; border:none; padding:10px 20px; border-radius:6px; font-size:16px; cursor:pointer;">
      📄 Gerar Relatório em PDF
    </button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function carregarImagemBase64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

async function gerarPDFPersonalizado() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const imgBase64 = await carregarImagemBase64('./img/layout_canva.png');

  doc.addImage(imgBase64, 'PNG', 0, 0, 210, 297);

  let y = 30;
  doc.setFontSize(18);
  doc.setTextColor(1, 10, 40);
  doc.setFont('helvetica', 'bold');
  doc.text('Relatório de Viabilidade Econômica', 15, y);
  y += 10;

  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.setFont('helvetica', 'bold');
  doc.text(`Projeto: ${document.getElementById('nome').value}`, 15, y);
  y += 8;

  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('Dados Gerais:', 15, y);
  y += 6;

  doc.setFont('helvetica', 'normal');
  const dados = [
    ['Tipo de Atividade', 'tipo'],
    ['Cidade/Estado', 'local'],
    ['Estrutura', 'estrutura'],
    ['Regime Tributário', 'regime'],
    ['Situação Atual', 'situacao'],
    ['Responsável', 'responsavel'],
    ['E-mail', 'email'],
    ['Telefone', 'telefone']
  ];
  dados.forEach(([label, id]) => {
    doc.text(`${label}: ${document.getElementById(id).value}`, 15, y);
    y += 6;
  });

  y += 4;
  doc.setFont('helvetica', 'bold');
  doc.text('Indicadores Financeiros:', 15, y);
  y += 6;
  doc.setFont('helvetica', 'normal');

  const indicadores = [
    ['Receita Mensal', 'receita_mensal'],
    ['Receita Anual', 'receita_anual'],
    ['Lucro Operacional Mensal', 'lucro_operacional'],
    ['Margem de Lucro', 'margem_lucro'],
    ['Ponto de Equilíbrio', 'ponto_equilibrio'],
    ['Payback', 'payback'],
    ['ROI', 'roi'],
    ['VPL', 'vpl'],
    ['TIR', 'tir']
  ];

  indicadores.forEach(([label, id]) => {
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
    doc.text(`${label}: ${document.getElementById(id).value}`, 15, y);
    y += 6;
  });

  y += 6;
  doc.setFont('helvetica', 'bold');
  doc.text('Checklist de Viabilidade:', 15, y);
  y += 6;
  doc.setFont('helvetica', 'normal');

  const checklist = [
    ['Receita cobre os custos fixos?', 'check_receita'],
    ['Projeto tem ROI acima de 20%?', 'check_roi'],
    ['Payback abaixo de 12 meses?', 'check_payback'],
    ['Fluxo de caixa positivo nos 6 primeiros meses?', 'check_fluxo']
  ];
  checklist.forEach(([label, id]) => {
    doc.text(`${label}: ${document.getElementById(id).textContent}`, 15, y);
    y += 6;
  });

  y += 6;
  doc.setFont('helvetica', 'bold');
  doc.text(`Avaliação Final: ${document.getElementById('avaliacao_final').value}`, 15, y);

  doc.save('Relatorio_Viabilidade_Economica.pdf');
}
</script>
<script>
function atualizarChecklistAnalise() {
  const receita = parseFloat(document.getElementById('receita_mensal').value.replace(/\./g, '').replace(',', '.')) || 0;
  const fixos = parseFloat(document.getElementById('custos_fixos_total').value.replace(/\./g, '').replace(',', '.')) || 0;
  const roi = parseFloat(document.getElementById('roi').value.replace('%','').replace(',', '.')) || 0;
  const payback = parseFloat(document.getElementById('payback').value.replace(',', '.')) || 0;
  const lucro = receita - fixos;

  const check_receita = receita >= fixos;
  const check_roi = roi > 20;
  const check_payback = payback > 0 && payback <= 12;
  const check_fluxo = lucro > 0;

  document.getElementById('check_receita').textContent = check_receita ? 'Sim' : 'Não';
  document.getElementById('check_roi').textContent = check_roi ? 'Sim' : 'Não';
  document.getElementById('check_payback').textContent = check_payback ? 'Sim' : 'Não';
  document.getElementById('check_fluxo').textContent = check_fluxo ? 'Sim' : 'Não';

  const totalSim = [check_receita, check_roi, check_payback, check_fluxo].filter(Boolean).length;
  const avaliacaoFinal = document.getElementById('avaliacao_final');

  if (totalSim === 4) {
    avaliacaoFinal.value = 'Viável com Alta Rentabilidade';
  } else if (totalSim === 3) {
    avaliacaoFinal.value = 'Viável com Ajustes';
  } else if (totalSim === 2) {
    avaliacaoFinal.value = 'Pouco Viável no Momento';
  } else {
    avaliacaoFinal.value = 'Não Recomendado';
  }
}

document.addEventListener("input", atualizarChecklistAnalise);
</script>
 
<script>
  document.addEventListener("input", function () {
    function moedaParaNumero(str) {
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }
    function numeroParaMoeda(num) {
      return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    const preco = moedaParaNumero(document.getElementById('preco_unitario').value);
    const qtd = parseInt(document.getElementById('quantidade_mensal').value) || 0;
    const receitaMensal = preco * qtd;
    const receitaAnual = receitaMensal * 12;

    document.getElementById('receita_mensal').value = numeroParaMoeda(receitaMensal);
    document.getElementById('receita_anual').value = numeroParaMoeda(receitaAnual);

    // Receita por Cenários
    const pess = parseInt(document.getElementById('qtd_pessimista').value) || 0;
    const real = parseInt(document.getElementById('qtd_realista').value) || 0;
    const otim = parseInt(document.getElementById('qtd_otimista').value) || 0;

    document.getElementById('receita_pessimista').value = numeroParaMoeda(pess * preco);
    document.getElementById('receita_realista').value = numeroParaMoeda(real * preco);
    document.getElementById('receita_otimista').value = numeroParaMoeda(otim * preco);


    const fixos = moedaParaNumero(document.getElementById('custos_fixos_total').value);
    const variaveis = moedaParaNumero(document.getElementById('custos_variaveis_total').value);
    const lucro = receitaMensal - (fixos + variaveis);
    const margem = receitaMensal ? (lucro / receitaMensal) * 100 : 0;

    document.getElementById('lucro_operacional').value = numeroParaMoeda(lucro);
    document.getElementById('margem_lucro').value = margem.toFixed(1).replace('.', ',') + '%';

    const custoVariavelUnitario = moedaParaNumero(document.getElementById('custo_unitario_variavel').value);
    const pontoEquilibrio = preco > custoVariavelUnitario ? (fixos / (preco - custoVariavelUnitario)) : 0;

    document.getElementById('ponto_equilibrio').value = Math.ceil(pontoEquilibrio);
  }); 
</script>
  <div class="buttons" id="navigationButtons"></div>
  </form> <!-- Fechamento correto do formulário -->
</div> 
  <script>
    function renderButtons(currentStep) {
      const container = document.getElementById('navigationButtons');
      container.innerHTML = '';

      const limpar = document.createElement('button');
      limpar.textContent = 'Limpar';
      limpar.type = 'button';
      limpar.onclick = limparCamposEtapa;
      container.appendChild(limpar);

      if (currentStep > 0) {
        const voltar = document.createElement('button');
        voltar.textContent = 'Voltar';
        voltar.type = 'button';
        voltar.onclick = prevStep;
        container.appendChild(voltar);
      }

      if (currentStep < document.querySelectorAll('.step').length - 1) {
        const proximo = document.createElement('button');
        proximo.textContent = 'Próximo';
        proximo.type = 'button';
        proximo.onclick = nextStep;
        container.appendChild(proximo);
      }
    }

    function nextStep() {
      const steps = document.querySelectorAll(".step");
      for (let i = 0; i < steps.length; i++) {
        if (steps[i].classList.contains("active")) {
           // Ignora verificação apenas na Etapa 01 (índice 0)
      if (i !== 0) {          
          const requiredInputs = steps[i].querySelectorAll("input[required], select[required]");
          for (let j = 0; j < requiredInputs.length; j++) {
            if (!requiredInputs[j].value) {
              alert("Por favor, preencha todos os campos obrigatórios antes de continuar.");
              return;
            }
          }
        }
          steps[i].classList.remove("active");
          if (steps[i + 1]) {
        steps[i + 1].classList.add("active");
            renderButtons(i + 1);
          }
          break;
        }
      }
    }

    function prevStep() {
      const steps = document.querySelectorAll(".step");
      for (let i = 0; i < steps.length; i++) {
        if (steps[i].classList.contains("active")) {
          steps[i].classList.remove("active");
          if (i - 1 >= 0) {
            steps[i - 1].classList.add("active");
            renderButtons(i - 1);
          }
          break;
        }
      }
    }

    function limparCamposEtapa() {
      const etapaAtual = document.querySelector('.step.active');
      const inputs = etapaAtual.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea, select');

      inputs.forEach(input => {
        if (input.tagName.toLowerCase() === 'select') {
          input.selectedIndex = 0;
        } else {
          input.value = '';
        }
      });
    }

    window.onload = () => {
      renderButtons(0);
  // Bloqueia letras em campos numéricos
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function () {
      this.value = this.value.replace(/[^0-9]/g, '');
    });
  });
};

    
    document.addEventListener("input", function(e) {
      if (e.target.classList.contains("currency")) {
        let value = e.target.value.replace(/\D/g, "");
        value = (parseInt(value, 10) / 100).toFixed(2);
        e.target.value = value.replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      }

      // Etapa 3 cálculo automático
      const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
      const numeroParaMoeda = num => num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");

      const preco = moedaParaNumero(document.getElementById('preco_unitario').value);
      const qtd = parseInt(document.getElementById('quantidade_mensal').value) || 0;
      const receitaMensal = preco * qtd;
      document.getElementById('receita_mensal').value = numeroParaMoeda(receitaMensal);
      document.getElementById('receita_anual').value = numeroParaMoeda(receitaMensal * 12);

      let fixos = 0, variaveis = 0;
      document.querySelectorAll('#camposEspecificos h3').forEach(h3 => {
  const categoria = h3.textContent.trim().toLowerCase();
  let soma = 0;

  let elementoAtual = h3.nextElementSibling;
  while (elementoAtual && elementoAtual.tagName !== 'H3') {
    const input = elementoAtual.querySelector('input');
    if (input) soma += moedaParaNumero(input.value);
    elementoAtual = elementoAtual.nextElementSibling;
  }

  if (categoria.includes('fixos')) fixos += soma;
  if (categoria.includes('variáveis')) variaveis += soma;
});


      document.getElementById('custos_fixos_total').value = numeroParaMoeda(fixos);
      document.getElementById('custos_variaveis_total').value = numeroParaMoeda(variaveis);

      const lucro = receitaMensal - (fixos + variaveis);
      document.getElementById('lucro_operacional').value = numeroParaMoeda(lucro);
      document.getElementById('margem_lucro').value = receitaMensal ? ((lucro / receitaMensal) * 100).toFixed(1).replace('.', ',') + '%' : '0%';

      const custoVariavelUnitario = moedaParaNumero(document.getElementById('custo_unitario_variavel').value);
      const pontoEquilibrio = preco > custoVariavelUnitario ? (fixos / (preco - custoVariavelUnitario)) : 0;
      document.getElementById('ponto_equilibrio').value = Math.ceil(pontoEquilibrio);
    });
     function moedaParaNumero(str) {
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }

    function numeroParaMoeda(num) {
      return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function calcularEtapa4() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const numeroParaMoeda = num => num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");

  const receita = moedaParaNumero(document.getElementById('receita_mensal').value);
  const fixos = moedaParaNumero(document.getElementById('custos_fixos_total').value);
  const variaveis = moedaParaNumero(document.getElementById('custos_variaveis_total').value);
  const lucro = receita - (fixos + variaveis);
  const taxa = moedaParaNumero(document.getElementById('taxa_desconto').value) / 100;

  // 🧮 Investimento Inicial (buscando todos os campos após h3 "Investimento Inicial")
let investimento = 0;
document.querySelectorAll('#camposEspecificos h3').forEach(h3 => {
  const categoria = h3.textContent.trim().toLowerCase();
  if (categoria.includes('investimento')) {
    let el = h3.nextElementSibling;
    while (el && el.tagName !== 'H3') {
      const input = el.querySelector('input');
      if (input) investimento += moedaParaNumero(input.value);
      el = el.nextElementSibling;
    }
  }
});

  // 🧠 Cálculos principais
  const margem = receita ? (variaveis / receita) : 0;
  const pontoEq = receita ? (fixos / (1 - margem)) : 0;
  const payback = lucro > 0 ? (Math.abs(investimento) / lucro) : 0;
  const roi = investimento > 0 ? ((lucro * 12 / Math.abs(investimento)) * 100) : 0;

  // 💰 VPL e TIR (fluxo de 60 meses)
  let vpl = 0;
  for (let t = 1; t <= 60; t++) {
    vpl += lucro / Math.pow(1 + taxa, t);
  }
  vpl -= investimento;

  let tir = 0, step = 0.0001;
  while (tir < 1) {
    let testVPL = 0;
    for (let t = 1; t <= 60; t++) {
      testVPL += lucro / Math.pow(1 + tir, t);
    }
    if (testVPL < investimento) break;
    tir += step;
  }

  // 📩 Preencher os campos da etapa 4
  document.getElementById('ponto_equilibrio_fin').value = numeroParaMoeda(pontoEq);
  document.getElementById('payback').value = payback.toFixed(1).replace('.', ',');
  document.getElementById('roi').value = roi.toFixed(1).replace('.', ',') + '%';
  document.getElementById('vpl').value = numeroParaMoeda(vpl);
  document.getElementById('tir').value = (tir * 100).toFixed(2).replace('.', ',') + '%';
}

    document.addEventListener("input", calcularEtapa4);
  </script>
<script>
// Máscara para moeda (R$)
document.querySelectorAll('input.currency[placeholder="R$"]').forEach(input => {
  input.addEventListener('input', () => {
    let val = input.value.replace(/\D/g, '');
    val = (parseInt(val) / 100).toFixed(2) + '';
    val = val.replace('.', ',');
    val = val.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    input.value = 'R$ ' + val;
  });
});

// Corrige comportamento da máscara de percentual (%)
document.querySelectorAll('input.percent').forEach(input => {
  input.addEventListener('input', () => {
    let raw = input.value.replace(/\D/g, '');
    if (raw === '') {
      input.value = '';
      return;
    }
    let valor = (parseInt(raw) / 10).toFixed(1).replace('.', ',');
    input.value = valor;
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === "Backspace") {
      let val = input.value.replace(/\D/g, '');
      val = val.slice(0, -1);
      if (val === '') {
        input.value = '';
        e.preventDefault();
      }
    }
  });

  input.addEventListener('blur', () => {
    if (!input.value.includes('%') && input.value !== '') {
      input.value += '%';
    }
  });
});
</script>
</body>
</html>
