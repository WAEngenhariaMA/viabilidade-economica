<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>WA Engenharia ‚Äì Analisador de Viabilidade Econ√¥mica</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap">
  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }
    .container {
      max-width: 900px;
      margin: 50px auto;
      background-color: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
    }
    h1 {
      text-align: center;
      color: #00bcd4;
      margin-bottom: 10px;
      font-size: 30px;
    }
    h2 {
      text-align: left;
      margin-top: 40px;
      font-size: 21px;
      color: #fff;
      margin-bottom: 20px;
      font-weight: 400;
    }
    h4 {
      text-align: left;
      margin-top: 20px;
      font-size: 18px;
      color: #fff;
      margin-bottom: 20px;
      font-weight: 400;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      color: #ccc;
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1px;
      margin-bottom: 15px;
    }
    .row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .col-100 {
      flex: 1 1 100%;
    }
    .col-66 {
      flex: 1 1 64%;
    }
    .col-50 {
      flex: 1 1 48%;
    }
    .col-33 {
      flex: 1 1 30%;
    }
    .col-20 {
      width: 20%;
      float: left;
      box-sizing: border-box;
      padding: 8px;
    } 
    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      box-sizing: border-box;
      margin-top: 2px;
    }
    .buttons {
      margin-top: 20px;
      text-align: right;
    }
    button {
      padding: 10px 20px;
      background-color: #00bcd4;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
    button:hover {
      background-color: #0193a3;
    }
    form {
  display: block;
  width: auto;
  height: auto; /* <- ESSENCIAL */
  overflow: visible; /* <- garante que conte√∫do fora n√£o seja cortado */
  max-width: 1200px; /* <- opcional, para limitar a largura do formul√°rio */
  min-width: 300px; /* <- opcional, para garantir que o formul√°rio n√£o seja muito estreito */

}
.container {
  height: auto;
  overflow: visible;
}

  </style>
</head>
<body>
  <div class="container">
    <h1>WA Engenharia ‚Äì Analisador de Viabilidade Econ√¥mica</h1>
    <form id="viabilidadeForm">
      <!-- ETAPA 01 - DADOS GERAIS DO PROJETO -->
      <div class="step active" id="step1">
  <h2>Dados Gerais do Projeto</h2>

  <div class="form-group col-100">
    <label for="nome">Nome do Projeto/Empresa:</label>
    <input type="text" id="nome" name="nome" required>
  </div>

  <div class="row">
    <div class="form-group col-33">
      <label for="tipo">Tipo de Atividade:</label>
      <select id="tipo" name="tipo" required>
        <option value="">Selecione...</option>
        <option value="Constru√ß√£o Civil">Constru√ß√£o Civil</option>
        <option value="Servi√ßos T√©cnicos Profissionais">Servi√ßos T√©cnicos Profissionais</option>
        <option value="Com√©rcio e Varejo">Com√©rcio e Varejo</option>
        <option value="Ind√∫stria e Produ√ß√£o">Ind√∫stria e Produ√ß√£o</option>
        <option value="Est√©tica, Sa√∫de e Bem-Estar">Est√©tica, Sa√∫de e Bem-Estar</option>
        <option value="Eventos, Campeonatos e Produ√ß√µes">Eventos, Campeonatos e Produ√ß√µes</option>
        <option value="Neg√≥cios Digitais e Tecnologia">Neg√≥cios Digitais e Tecnologia</option>
        <option value="Alimenta√ß√£o, Bares e Delivery">Alimenta√ß√£o, Bares e Delivery</option>
        <option value="Franquias e Modelos Licenciados">Franquias e Modelos Licenciados</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="estado">Estado:</label>
      <select id="estado" name="estado" required></select>
    </div>

    <div class="form-group col-33">
      <label for="cidade">Cidade:</label>
      <select id="cidade" name="cidade" required></select>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-33">
      <label for="estrutura">Estrutura:</label>
      <select id="estrutura" name="estrutura" required>
        <option value="">Selecione...</option>
        <option value="F√≠sica">F√≠sica</option>
        <option value="Virtual">Virtual</option>
        <option value="H√≠brida">H√≠brida</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="regime">Regime Tribut√°rio:</label>
      <select id="regime" name="regime">
        <option value="">N√£o se aplica / N√£o definido</option>
        <option value="MEI">MEI</option>
        <option value="Simples Nacional">Simples Nacional</option>
        <option value="Lucro Presumido">Lucro Presumido</option>
        <option value="Lucro Real">Lucro Real</option>
      </select>
    </div>

    <div class="form-group col-33">
      <label for="situacao">Situa√ß√£o Atual:</label>
      <select id="situacao" name="situacao" required>
        <option value="">Selecione...</option>
        <option value="Planejamento">Planejamento</option>
        <option value="Em opera√ß√£o">Em opera√ß√£o</option>
        <option value="Em expans√£o">Em expans√£o</option>
      </select>
    </div>
  </div>

  <div class="form-group col-100">
    <label for="responsavel">Respons√°vel:</label>
    <input type="text" id="responsavel" name="responsavel" required>
  </div>

 <div class="row">
  <div class="form-group col-66">
    <label for="email">E-mail:</label>
    <input type="email" id="email" name="email" required>
  </div>

  <div class="form-group col-33">
    <label for="telefone">Telefone:</label>
    <input type="tel" id="telefone" name="telefone" placeholder="(00) 00000-0000" required>
  </div>
</div>
</div>

<script>
  // Lista de estados e cidades (exemplo parcial)
  const estadosECidades = {
  "AC": ["Rio Branco", "Cruzeiro do Sul", "Sena Madureira"],
  "AL": ["Macei√≥", "Arapiraca", "Palmeira dos √çndios"],
  "AP": ["Macap√°", "Santana", "Laranjal do Jari"],
  "AM": ["Manaus", "Parintins", "Itacoatiara"],
  "BA": ["Salvador", "Feira de Santana", "Vit√≥ria da Conquista"],
  "CE": ["Fortaleza", "Caucaia", "Juazeiro do Norte"],
  "DF": ["Bras√≠lia"],
  "ES": ["Vit√≥ria", "Vila Velha", "Serra"],
  "GO": ["Goi√¢nia", "Aparecida de Goi√¢nia", "An√°polis"],
  "MA": ["S√£o Lu√≠s", "Imperatriz", "Caxias"],
  "MT": ["Cuiab√°", "V√°rzea Grande", "Rondon√≥polis"],
  "MS": ["Campo Grande", "Dourados", "Tr√™s Lagoas"],
  "MG": ["Belo Horizonte", "Uberl√¢ndia", "Contagem"],
  "PA": ["Bel√©m", "Santar√©m", "Ananindeua"],
  "PB": ["Jo√£o Pessoa", "Campina Grande", "Patos"],
  "PR": ["Curitiba", "Londrina", "Maring√°"],
  "PE": ["Recife", "Jaboat√£o dos Guararapes", "Olinda"],
  "PI": ["Teresina", "Parna√≠ba", "Picos"],
  "RJ": ["Rio de Janeiro", "Niter√≥i", "Duque de Caxias"],
  "RN": ["Natal", "Mossor√≥", "Parnamirim"],
  "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas"],
  "RO": ["Porto Velho", "Ji-Paran√°", "Ariquemes"],
  "RR": ["Boa Vista"],
  "SC": ["Florian√≥polis", "Joinville", "Blumenau"],
  "SP": ["S√£o Paulo", "Campinas", "Santos"],
  "SE": ["Aracaju", "Nossa Senhora do Socorro", "Lagarto"],
  "TO": ["Palmas", "Aragua√≠na", "Gurupi"]
};

  const estadoSelect = document.getElementById('estado');
  const cidadeSelect = document.getElementById('cidade');

  for (const estado in estadosECidades) {
    const option = document.createElement('option');
    option.value = estado;
    option.textContent = estado;
    estadoSelect.appendChild(option);
  }

  estadoSelect.addEventListener('change', () => {
    const cidades = estadosECidades[estadoSelect.value] || [];
    cidadeSelect.innerHTML = '';
    cidades.forEach(cidade => {
      const opt = document.createElement('option');
      opt.value = cidade;
      opt.textContent = cidade;
      cidadeSelect.appendChild(opt);
    });
  });

  // M√°scara para telefone
  document.getElementById('telefone').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '').slice(0, 11);
    v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    e.target.value = v;
  });
  
</script>
<!-- ETAPA 02 COMPLETA (HTML + JS) -->
<div class="step" id="step2">
  <h2>Custos e Investimentos</h2>

  <!-- PRODUTOS -->
  <h3 style="color:#00bcd4;">1.1 Produto ‚Äì Descri√ß√£o do Produto</h3>
  <button type="button" onclick="abrirModalProduto()">+ Cadastrar Novo Produto</button>
  <table id="tabelaProdutos" style="margin-top:10px;width:100%;color:#fff;text-align:center;">
    <thead>
      <tr><th style="text-align:center;">Produto</th><th style="text-align:center;">Custo Direto (R$)</th><th style="text-align:center;">Custo Direto (%)</th><th style="text-align:center;">Pre√ßo de Venda (R$)</th><th style="text-align:center;">A√ß√µes</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- MODAL PRODUTO -->
  <div id="modalProduto" style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#222;padding:20px;border-radius:10px;z-index:1000;width:90%;max-width:500px;">
    <h3 style="color:#00bcd4;">Novo Produto</h3>
    <label>Nome do Produto:</label>
    <input type="text" id="novoProdutoNome">
    <label>Custo Direto (R$):</label>
    <input type="text" id="novoCustoMonetario" class="currency"  placeholder="R$">
    <label>Custo Direto (%):</label>
    <input type="text" id="novoCustoPercentual" class="percent" placeholder="%">
    <label>Pre√ßo de Venda Pretendido (R$):</label>
    <input type="text" id="novoPrecoVenda" class="currency" placeholder="R$">
    <button type="button" onclick="abrirModalPreco()" style="margin-top: 10px;">Calcular Pre√ßo de Venda</button>
    <div style="text-align:right;margin-top:5px;">
      <button type="button" onclick="salvarProduto()">Salvar</button>
      <button type="button" onclick="fecharModalProduto()">Cancelar</button>
    </div>
  </div>

  <!-- MODAL PRE√áO VENDA (MAIOR JANELA) -->
  <div id="modalPreco" style="display:none;position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#222;padding:30px;border-radius:12px;z-index:2000;width:95%;max-width:700px;">
    <h3 style="color:#00bcd4;">C√°lculo do Pre√ßo de Venda</h3>
    <label>Custos Totais (R$):</label>
    <input type="text" id="preco_custo_calc" class="currency"  placeholder="R$">
    <label>Margem de Lucro Desejada (%):</label>
    <input type="text" id="margem_lucro_calc" class="percent" placeholder="%">
    <label>Pre√ßo da Concorr√™ncia (R$):</label>
    <input type="text" id="concorrencia_calc" class="currency" placeholder="R$">
    <div style="text-align:right;margin-top:10px;">
      <button type="button" onclick="calcularPrecoVenda()">Calcular</button>
      <button type="button" onclick="fecharModalPreco()">Cancelar</button>
    </div>
  </div>

  <!-- INVESTIMENTO INICIAL -->
  <h3 style="color:#00bcd4;">2. Investimento Inicial</h3>
  <div class="row">
    <div class="form-group col-33"><label>Cria√ß√£o de Marca e Registro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Abertura de Empresa e Licen√ßas (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Consultorias (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Estoque Inicial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Equipamentos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Imobilizados (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Capital de Giro (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros Investimentos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>

  <!-- CUSTOS VARI√ÅVEIS -->
  <h3 style="color:#00bcd4;">3. Custos Vari√°veis</h3>
  <div class="row">
    <div class="form-group col-50"><label>Custos com Produ√ß√£o (%):</label><input type="text" id="auto_custo_prod" placeholder="%" readonly></div>
    <div class="form-group col-50">
    <label>Impostos (%):</label>
    <input type="text" id="inputImpostoPercentualEtapa02" class="percent" placeholder="%">
  </div>
  <div class="form-group col-33">
    <label>Comiss√£o de Vendas (%):</label>
    <input type="text" id="inputComissaoPercentualEtapa02" class="percent" placeholder="%">
  </div>
  <div class="form-group col-33">
    <label>Tarifas de Cart√£o (%):</label>
    <input type="text" id="inputCartaoPercentualEtapa02" class="percent" placeholder="%">
  </div>
  <div class="form-group col-33">
    <label>Outros Valores (%):</label>
    <input type="text" id="inputOutrosPercentualEtapa02" class="percent" placeholder="%">
  </div>
    <!-- Custos de Produ√ß√£o por Produto -->
<div id="custos_individuais_area" style="margin-top: 10px;"></div>
  </div>

  <!-- CUSTOS FIXOS -->
  <h3 style="color:#00bcd4;">4. Custos Mensais Fixos</h3>
  <h4>Despesas Administrativas</h4>
  <div class="row">
    <div class="form-group col-50"><label>Aluguel (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Energia (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Sal√°rios (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Internet (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-33"><label>Outros Custos (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Comerciais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Combust√≠vel (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Sal√°rios Equipe Comercial (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
  <h4>Despesas Operacionais</h4>
  <div class="row">
    <div class="form-group col-50"><label>Despesa 1 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
    <div class="form-group col-50"><label>Despesa 2 (R$):</label><input type="text" class="currency" placeholder="R$"></div>
  </div>
<!-- TAXA DESCONTO -->
  <h3 style="color:#00bcd4; margin-top: 40px;">Taxas de Avalia√ß√£o Financeira</h3>
<div class="row">
  <div class="form-group col-33">
    <label>Infla√ß√£o Esperada (%):</label>
    <input type="text" id="taxa_inflacao" class="percent" placeholder="%">
  </div>
  <div class="form-group col-33">
    <label>Custo de Oportunidade (%):</label>
    <input type="text" id="taxa_oportunidade" class="percent" placeholder="%">
  </div>
  <div class="form-group col-33">
    <label>Retorno Esperado (%):</label>
    <input type="text" id="taxa_esperada" class="percent" placeholder="%">
  </div>
</div>


  
  <!-- PLANO COMERCIAL -->
  <h3 style="color:#00bcd4;">5. Plano Comercial</h3>
  <label>P√∫blico-Alvo:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Diferenciais do Produto:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  <label>Poss√≠veis Concorrentes:</label><textarea rows="2" style="width:100%; resize: none; overflow-y: hidden;" oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'"></textarea>
  
  <label>Taxa de Crescimento Mensal (%):</label><input type="text" class="percent" placeholder="%">
</div>
<script>
let produtos = [];
</script>
<script>
function abrirModalProduto() {
  document.getElementById("modalProduto").style.display = 'block';
}
function fecharModalProduto() {
  document.getElementById("modalProduto").style.display = 'none';
  document.getElementById("novoProdutoNome").value = '';
  document.getElementById("novoCustoMonetario").value = '';
  document.getElementById("novoCustoPercentual").value = '';
  document.getElementById("novoPrecoVenda").value = '';
}
function salvarProduto() {
  const nome = document.getElementById("novoProdutoNome").value;
  const custoR = document.getElementById("novoCustoMonetario").value;
  const custoP = document.getElementById("novoCustoPercentual").value;
  const precoVenda = document.getElementById("novoPrecoVenda").value;

  if (nome && precoVenda) {
    produtos.push({ nome, custoR, custoP, precoVenda });
    atualizarTabelaProdutos();
    fecharModalProduto();
   
  } else {
    alert("Preencha pelo menos o nome do produto e o pre√ßo de venda.");
  }
}

function atualizarTabelaProdutos() {
  const tbody = document.querySelector("#tabelaProdutos tbody");
  const volumeDiv = document.getElementById("volumeProdutos"); // Caso use essa parte
  const custoProdField = document.getElementById("auto_custo_prod"); // Campo autom√°tico de custos com produ√ß√£o

  tbody.innerHTML = "";
  if (volumeDiv) volumeDiv.innerHTML = "";

  let somaCustosDiretos = 0;
  let somaPrecosVenda = 0;

  produtos.forEach((p, index) => {
    // Adiciona √† tabela
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.nome}</td>
      <td>${p.custoR}</td>
      <td>${p.custoP}</td>
      <td>${p.precoVenda}</td>
      <td><button type="button" onclick="removerProduto(${index})">Excluir</button></td>
    `;
    tbody.appendChild(row);

    // Campo de volume por produto (caso deseje exibir)
    if (volumeDiv) {
      volumeDiv.innerHTML += `
        <div class="row" style="margin-bottom: 10px; align-items: center;">
          <div class="col-50"><label>${p.nome}</label></div>
          <div class="col-50">
            <input type="number" class="volumeProdutoInput" data-index="${index}" min="0" style="width: 100%; padding: 6px;" />
          </div>
        </div>
      `;
    }

    // C√°lculo acumulado dos custos e pre√ßos
    const custo = moedaParaNumero(p.custoR);
    const preco = moedaParaNumero(p.precoVenda);
    somaCustosDiretos += custo;
    somaPrecosVenda += preco;
  });

  // C√°lculo final do campo autom√°tico de custo de produ√ß√£o (%)
  if (custoProdField) {
    const custoProducaoPercentual = somaPrecosVenda > 0 ? (somaCustosDiretos / somaPrecosVenda) * 100 : 0;
    custoProdField.value = custoProducaoPercentual.toFixed(1).replace('.', ',') + '%';
  }
  // ‚úÖ Exibir custo de produ√ß√£o por produto na se√ß√£o de Custos Vari√°veis
let blocoIndividual = document.getElementById("custos_individuais_area");
if (blocoIndividual) {
  blocoIndividual.innerHTML = `
      <h4 style="color: #fff;">Custos de Produ√ß√£o Individuais (%)</h4>
  `;

  produtos.forEach((p) => {
    const custo = parseFloat(p.custoR.replace(/\./g, '').replace(',', '.')) || 0;
    const preco = parseFloat(p.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;
    const percentual = preco > 0 ? (custo / preco) * 100 : 0;

    blocoIndividual.innerHTML += `
      <div style="margin-bottom:4px;">
        <strong style="color:#fff;">${p.nome}</strong>: ${percentual.toFixed(1).replace('.', ',')}%
      </div>
    `;
  });
}
}
function obterCustosVariaveisEtapa02() {
  const parsePercentual = (id) => {
    return parseFloat(
      (document.getElementById(id)?.value || "0")
        .replace('%', '')
        .replace(",", ".")
        .trim()
    ) || 0;
  };

  const impostoPerc = parsePercentual("inputImpostoPercentualEtapa02");
  const comissaoPerc = parsePercentual("inputComissaoPercentualEtapa02");
  const cartaoPerc = parsePercentual("inputCartaoPercentualEtapa02");
  const outrosPerc = parsePercentual("inputOutrosPercentualEtapa02");

  return { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc };
}


function removerProduto(index) {
  produtos.splice(index, 1);
  atualizarTabelaProdutos();
}
function abrirModalPreco() {
  document.getElementById("modalPreco").style.display = 'block';
}
function fecharModalPreco() {
  document.getElementById("modalPreco").style.display = 'none';
}
function calcularPrecoVenda() {
  const custo = parseFloat(document.getElementById("preco_custo_calc").value.replace(',', '.')) || 0;
  const margem = parseFloat(document.getElementById("margem_lucro_calc").value.replace(',', '.')) || 0;
  const precoCalculado = custo * (1 + margem / 100);
  document.getElementById("novoPrecoVenda").value = precoCalculado.toFixed(2).replace('.', ',');
  fecharModalPreco();
}
</script>

<!-- ETAPA 03 ‚Äì Receita e Proje√ß√£o de Lucro AJUSTADA -->
<div class="step" id="step3">
  <h2>Etapa 03 ‚Äì Receita e Proje√ß√£o de Lucro</h2>

  <!-- Receita Esperada com Matriz Mensal -->
  <h3 style="color:#00bcd4;">Receita Esperada</h3>
  <div class="form-group" style="max-width: 200px;">
    <label for="mes_selecionado">M√™s de Receita Bruta:</label>
    <select id="mes_selecionado" onchange="calcularReceitaTotal()" style="width: 100%; padding: 8px;">
      <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
      <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
      <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
      <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
    </select>
  </div>

  <div id="tabelaReceitaProdutos"></div>

  <div class="row">
    <div class="form-group col-50">
      <label>Receita Bruta Mensal (R$):</label>
      <input type="text" id="receita_mensal" class="currency" readonly>
    </div>
    <div class="form-group col-50">
      <label>Receita Anual Estimada (R$):</label>
      <input type="text" id="receita_anual" class="currency" readonly>
    </div>
  </div>

  <!-- Receita por Cen√°rios -->
  <h3 style="color:#00bcd4;">Receita por Cen√°rios</h3>
  <div id="tabelaCenariosProdutos"></div>

  <!-- Proje√ß√£o de Custo -->
  <h3 style="color:#00bcd4;">Proje√ß√£o de Custos</h3>
  <div class="row">
    <div class="form-group col-50">
      <label>Custos Fixos (R$):</label>
      <input type="text" id="custos_fixos_total" class="currency" readonly>
    </div>
      <div class="form-group col-50">
      <label>Investimento Inicial (R$):</label>
      <input type="text" id="investimento_inicial" class="currency" readonly>
    </div>
 <!-- Custos Vari√°veis - Detalhamento individual -->
      <div class="row" id="custos_variaveis_exibidos"></div>
   <div id="custos_variaveis_valores_rs" class="row" style="margin-top:20px;">
     <h3 style="color:#00bcd4; width:100%;">Custos Vari√°veis Convertidos (R$)</h3>
    </div>
  </div>
</div>
<script>
function atualizarReceitaProdutos() {
  const container = document.getElementById("tabelaReceitaProdutos");
  container.innerHTML = "";

  const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
  let tabela = "<div style='overflow-x:auto;'><table style='min-width:900px;text-align:center;color:#fff;margin-bottom:20px;border-collapse:collapse;width:100%;'>";
  tabela += "<thead><tr><th>Produto</th><th>Pre√ßo</th>";

  meses.forEach(m => tabela += `<th>${m}</th>`);
  tabela += "<th>Total Unidades</th></tr></thead><tbody>";

  produtos.forEach((p, i) => {
    tabela += `<tr><td>${p.nome}</td><td>${p.precoVenda}</td>`;
    for (let m = 0; m < 12; m++) {
      tabela += `<td><input type="number" min="0" class="vendaMes" data-index="${i}" data-mes="${m}" style="width:45px;"></td>`;
    }
    tabela += `<td><span class="totalQtdAno" data-index="${i}">0</span></td></tr>`;
  });

  tabela += "</tbody></table></div>";
  container.innerHTML = tabela;

  document.querySelectorAll(".vendaMes").forEach(input => {
    input.addEventListener("input", calcularReceitaTotal);
  });
}
function calcularCustosVariaveisEmReais() {
  const container = document.getElementById("custos_variaveis_valores_rs");
  if (!container) return;

  container.innerHTML = '<h3 style="color:#00bcd4; width:100%;">Custos Vari√°veis Convertidos (R$)</h3>';
  if (produtos.length === 0) return;

  // Captura os inputs corretamente pela posi√ß√£o dos labels
  const campos = {
    "Produ√ß√£o (%)": document.getElementById("auto_custo_prod"),
    "Impostos (%)": null,
    "Comiss√£o de Vendas (%)": null,
    "Tarifas de Cart√£o (%)": null,
    "Outros Valores (%):": null,
  };

  document.querySelectorAll("#step2 .form-group").forEach(group => {
  const label = group.querySelector("label")?.textContent.trim();
  const input = group.querySelector("input");

  if (label && input) {
    console.log("üîé label:", label); // debug
  }

  if (!label || !input) return;

  if (label.includes("Impostos")) campos["Impostos (%):"] = input;
  else if (label.includes("Comiss√£o")) campos["Comiss√£o de Vendas (%):"] = input;
  else if (label.includes("Tarifas")) campos["Tarifas de Cart√£o (%):"] = input;
  else if (label.includes("Outros Valores")) campos["Outros Valores (%):"] = input;
});
let custoVariavelProdutoDetalhado = {};
produtos.forEach(p => {
  custoVariavelProdutoDetalhado[p.nome] = {
    outrosRS: 0,
    impostosRS: 0,
    comissaoRS: 0,
    cartaoRS: 0
  };
});
  // C√°lculo dos valores em R$
  const totalPorTipo = {};
  for (const tipo in campos) {
    const input = campos[tipo];
    if (!input) continue;

    let valorBruto = input.value
  .replace('%', '')
  .replace(/\s/g, '')
  .replace(',', '.');
  
let percentual = parseFloat(valorBruto) || 0;

    let total = 0;
    produtos.forEach(p => {
  const preco = parseFloat(p.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;
  const valorProduto = preco * (percentual / 100);
  total += valorProduto;

  // Salva o valor espec√≠fico por tipo para esse produto
  if (tipo.includes("Outros")) custoVariavelProdutoDetalhado[p.nome].outrosRS = valorProduto;
  if (tipo.includes("Impostos")) custoVariavelProdutoDetalhado[p.nome].impostosRS = valorProduto;
  if (tipo.includes("Comiss√£o")) custoVariavelProdutoDetalhado[p.nome].comissaoRS = valorProduto;
  if (tipo.includes("Cart√£o")) custoVariavelProdutoDetalhado[p.nome].cartaoRS = valorProduto;
});

totalPorTipo[tipo] = total;
  }

  for (const tipo in totalPorTipo) {
  const labelFormatado = tipo.replace(/\(%\)/g, "(R$)").replace("(%):", "(R$)");
  const div = document.createElement("div");
  div.className = "form-group";
  div.style.width = "30%";
  div.innerHTML = `
    <label>${labelFormatado}</label>
    <input type="text" class="currency" value="R$ ${totalPorTipo[tipo].toFixed(2).replace('.', ',')}" readonly>
  `;
  container.appendChild(div);
}
  // Soma total
let totalGeral = Object.values(totalPorTipo).reduce((acc, val) => acc + val, 0);

// Adiciona campo do total
const totalDiv = document.createElement("div");
totalDiv.className = "form-group";
totalDiv.style.width = "30%";
totalDiv.innerHTML = `
  <label><strong>Custos Vari√°vel (R$):</strong></label>
  <input type="text" class="currency" value="R$ ${totalGeral.toFixed(2).replace('.', ',')}" readonly id="custo_variavel_total_rs">
`;
container.appendChild(totalDiv);
}
function calcularReceitaTotal() {
  let receitaMensal = 0;
  let receitaAnual = 0;
  const mesSelecionado = parseInt(document.getElementById("mes_selecionado").value);

  produtos.forEach((p, i) => {
    const preco = parseFloat(p.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;
    let totalProduto = 0;
    let totalQtd = 0;

    for (let m = 0; m < 12; m++) {
      const input = document.querySelector(`.vendaMes[data-index='${i}'][data-mes='${m}']`);
      const qtd = parseInt(input?.value || 0);
      if (m === mesSelecionado) receitaMensal += qtd * preco;
      totalProduto += qtd * preco;
      totalQtd += qtd;
    }

    receitaAnual += totalProduto;
    const spanQtd = document.querySelector(`.totalQtdAno[data-index='${i}']`);
    if (spanQtd) {
      spanQtd.textContent = totalQtd;
    }
  });

  document.getElementById("receita_mensal").value = receitaMensal.toLocaleString("pt-BR", {minimumFractionDigits: 2});
  document.getElementById("receita_anual").value = receitaAnual.toLocaleString("pt-BR", {minimumFractionDigits: 2});
}

function atualizarCenariosProdutos() {
  const container = document.getElementById("tabelaCenariosProdutos");
  container.innerHTML = "";

  produtos.forEach((produto, i) => {
    const preco = parseFloat(produto.precoVenda.replace(/\./g, '').replace(',', '.')) || 0;

    container.innerHTML += `
      <div class="row" style="margin-bottom: 15px;">
        <div class="form-group col-33">
          <label>${produto.nome} ‚Äì Unidades Pessimista:</label>
          <input type="number" class="pessimista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})">
          <input type="text" id="val_pess_${i}" readonly class="currency" placeholder="R$">
        </div>
        <div class="form-group col-33">
          <label>${produto.nome} ‚Äì Unidades Realista:</label>
          <input type="number" class="realista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})">
          <input type="text" id="val_real_${i}" readonly class="currency" placeholder="R$">
        </div>
        <div class="form-group col-33">
          <label>${produto.nome} ‚Äì Unidades Otimista:</label>
          <input type="number" class="otimista" data-index="${i}" min="0" oninput="atualizarValoresCenario(${i}, ${preco})">
          <input type="text" id="val_otim_${i}" readonly class="currency" placeholder="R$">
        </div>
      </div>`;
  });
}

function atualizarValoresCenario(i, preco) {
  const pess = parseInt(document.querySelector(`.pessimista[data-index='${i}']`)?.value || 0);
  const real = parseInt(document.querySelector(`.realista[data-index='${i}']`)?.value || 0);
  const otim = parseInt(document.querySelector(`.otimista[data-index='${i}']`)?.value || 0);

  document.getElementById(`val_pess_${i}`).value = (pess * preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  document.getElementById(`val_real_${i}`).value = (real * preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
  document.getElementById(`val_otim_${i}`).value = (otim * preco).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}
function atualizarCustosFixosEVariaveis() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;

  // ‚úÖ CUSTOS FIXOS ‚Äì Soma pelos nomes
  let custosFixos = 0;
  const camposCustosFixos = [
    "Aluguel (R$):", "Energia (R$):", "Sal√°rios (R$):",
    "Internet (R$):", "Outros Custos (R$):",
    "Combust√≠vel (R$):", "Sal√°rios Equipe Comercial (R$):",
    "Despesa 1 (R$):", "Despesa 2 (R$):"
  ];

  document.querySelectorAll("#step2 label").forEach(label => {
    const texto = label.textContent.trim();
    if (camposCustosFixos.includes(texto)) {
      const input = label.closest(".form-group")?.querySelector("input");
      if (input && input.value) {
        custosFixos += moedaParaNumero(input.value);
      }
    }
  });

  // ‚úÖ INVESTIMENTO INICIAL ‚Äì Soma pelos nomes
  let investimento = 0;
  const camposInvestimento = [
    "Cria√ß√£o de Marca e Registro (R$):",
    "Abertura de Empresa e Licen√ßas (R$):",
    "Consultorias (R$):",
    "Estoque Inicial (R$):",
    "Equipamentos (R$):",
    "Imobilizados (R$):",
    "Capital de Giro (R$):",
    "Outros Investimentos (R$):"
  ];

  document.querySelectorAll("#step2 label").forEach(label => {
    const texto = label.textContent.trim();
    if (camposInvestimento.includes(texto)) {
      const input = label.closest(".form-group")?.querySelector("input");
      if (input && input.value) {
        investimento += moedaParaNumero(input.value);
      }
    }
  });

  // ‚úÖ REPLICA√á√ÉO dos campos de % dos Custos Vari√°veis (inclusive auto_custo_prod)
const containerCV = document.getElementById("custos_variaveis_exibidos");
if (containerCV) containerCV.innerHTML = "";

document.querySelectorAll("#step2 input.percent, #auto_custo_prod").forEach(input => {
  let label = input.closest(".form-group")?.querySelector("label")?.textContent.trim() || "";

if (label === "Custos com Produ√ß√£o (%):") label = "Produ√ß√£o (%)";
if (label === "Comiss√£o de Vendas (%):") label = "Comiss√£o Venda (%)";
if (label === "Tarifas de Cart√£o (%):") label = "Tarifas Cart√£o (%)";
  if (label) {
    const div = document.createElement("div");
    div.className = "form-group";
    div.style.width = "17%";
    div.style.marginRight = "1%";
    div.innerHTML = `
      <label>${label}</label>
      <input type="text" class="percent" value="${input.value}" readonly>
    `;
    containerCV.appendChild(div);
  }
});
  // ‚úÖ Atualiza valores da etapa 03
  document.getElementById("custos_fixos_total").value = custosFixos.toLocaleString("pt-BR", {minimumFractionDigits: 2});
  document.getElementById("investimento_inicial").value = investimento.toLocaleString("pt-BR", {minimumFractionDigits: 2});
}

// üü¢ Atualizar ao digitar ou mudar valores
["input", "change"].forEach(evt =>
  document.addEventListener(evt, () => {
    setTimeout(() => {
      calcularReceitaTotal();
      atualizarCustosFixosEVariaveis();
    }, 50);
  })
);

</script>

<!-- ETAPA 04 ‚Äì M√≥dulo 2 ‚Äì An√°lise Financeira -->
<div class="step" id="step4">
  <h2>Etapa 04 ‚Äì An√°lise Financeira</h2>

 <!-- Margem de Contribui√ß√£o Unit√°ria (6.1) -->
<h4 style="color:#00bcd4; margin-top: 30px;">6.1 Margem de Contribui√ß√£o Unit√°ria</h4>

<!-- Margem por Produto -->
<div style="color:white; margin-top: 10px;">
  <strong>Margem Unit√°ria por Produto:</strong>
  <div id="margem-unitaria-produto" style="font-weight:bold; color:#ffffff; margin: 4px 0;">
    <!-- JS ir√° inserir aqui os produtos -->
  </div>
</div>

<!-- Margem Total -->
<div style="color:white; margin-top: 15px;">
  <strong>Margem Unit√°ria Total:</strong>
  <p id="margem-unitaria-total" style="font-weight:bold; color:#ffffff; margin: 4px 0;">R$ 0,00</p>
</div>

<!-- Margem Total R$ -->
<div style="color:white; margin-top: 15px;">
  <strong>Margem Ano:</strong>
  <p id="margem-ano" style="font-weight:bold; color:#ffffff; margin: 4px 0;">R$ 0,00</p>
</div>


  <!-- Margem de Contribui√ß√£o Total (6.2) por m√™s em forma de matriz -->
<h3 style="color:#00bcd4;">6.2 Margem de Contribui√ß√£o Total (Mensal)</h3>
<div style="overflow-x: auto; padding-bottom: 10px;">
  <table style="min-width: 800px; width: max-content; text-align: center; color: #fff; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="padding: 8px 12px;">Produto</th>
        <th style="padding: 8px 12px;">Jan</th><th style="padding: 8px 12px;">Fev</th><th style="padding: 8px 12px;">Mar</th>
        <th style="padding: 8px 12px;">Abr</th><th style="padding: 8px 12px;">Mai</th><th style="padding: 8px 12px;">Jun</th>
        <th style="padding: 8px 12px;">Jul</th><th style="padding: 8px 12px;">Ago</th><th style="padding: 8px 12px;">Set</th>
        <th style="padding: 8px 12px;">Out</th><th style="padding: 8px 12px;">Nov</th><th style="padding: 8px 12px;">Dez</th>
      </tr>
    </thead>
    <tbody id="margem_matriz"></tbody>
  </table>
</div>
  <!-- Ponto de Equil√≠brio -->
  <h3 style="color:#00bcd4;">7. Ponto de Equil√≠brio</h3>
  
<h4 style="color:white; margin-top: 30px;">7.3 Ponto de Equil√≠brio por Produto</h4>
<div id="peq_individual" style="color:white; margin-top: 10px;">
  <!-- Conte√∫do ser√° inserido via JS -->
</div>
 
  <!-- ROI -->
  <h3 style="color:#00bcd4;">8. Indicadores Financeiros</h3>
  <div id="calculoIndicadores" style="color:white; margin-top: 10px;"></div>
  </div>

<script>
  
function atualizarMargemUnit√°riaPorProduto() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const container = document.getElementById("margem-unitaria-produto");
  if (!container) return;

  // Limpa a visualiza√ß√£o anterior
  container.innerHTML = "";

  // Pega os percentuais da Etapa 02
  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  // Loop por produto
  produtos.forEach(p => {
    const precoVendaproduto = moedaParaNumero(p.precoVenda);
    const custoDiretoproduto = moedaParaNumero(p.custoR);

    // Custos vari√°veis calculados individualmente para este produto
    const impostoReais = precoVendaproduto * (impostoPerc / 100);
    const comissaoReais = precoVendaproduto * (comissaoPerc / 100);
    const cartaoReais = precoVendaproduto * (cartaoPerc / 100);
    const outrosReais = precoVendaproduto * (outrosPerc / 100);

    // Margem unit√°ria desse produto
    const margemUnit√°ria = precoVendaproduto - (custoDiretoproduto + impostoReais + comissaoReais + cartaoReais + outrosReais);
console.log("Produtos cadastrados:", produtos);
    // Adiciona √† tela
     container.innerHTML += `
      <div><strong>${p.nome}:</strong> R$ ${margemUnit√°ria.toFixed(2).replace('.', ',')}</div>
    `;

  });
}

function atualizarMargemUnit√°riaTotal() {
  let somaCustosDiretos = 0;
  let somaPrecoVenda = 0;

  // Soma os valores totais de custo direto e pre√ßo de venda
  produtos.forEach(p => {
  const precoVendaproduto = moedaParaNumero(p.precoVenda);
  const custoDiretoproduto = moedaParaNumero(p.custoR);
  somaCustosDiretos += custoDiretoproduto;
  somaPrecoVenda += precoVendaproduto;
});

  // Pega os percentuais definidos na Etapa 02
  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  // Aplica os percentuais sobre o total de pre√ßo de venda
  const impostoReais = somaPrecoVenda * (impostoPerc / 100);
  const comissaoReais = somaPrecoVenda * (comissaoPerc / 100);
  const cartaoReais = somaPrecoVenda * (cartaoPerc / 100);
  const outrosReais = somaPrecoVenda * (outrosPerc / 100);

  // Margem total considerando todos os custos
  const margemTotal = somaPrecoVenda - (somaCustosDiretos + impostoReais + comissaoReais + cartaoReais + outrosReais);

  // Atualiza o valor na tela
  const campo = document.getElementById("margem-unitaria-total");
  if (campo) campo.innerText = "R$ " + margemTotal.toFixed(2).replace('.', ',');

}
function atualizarMargemMensalPorProduto() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const numeroParaMoeda = num => num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  const numeroParaMoedaSemRS = num =>
    num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');

  const container = document.getElementById("margem_matriz");
  if (!container) return;
  container.innerHTML = "";

  const totaisPorMes = Array(12).fill(0);
  const inputs = document.querySelectorAll(".vendaMes");
  inputs.forEach(input => {
    const mes = parseInt(input.getAttribute("data-mes"));
    const quantidade = parseInt(input.value || "0");
    totaisPorMes[mes] += quantidade;
  });

  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  let margemAnoTotal = 0;
  let receitaAnoTotal = 0;

  produtos.forEach((p, i) => {
    const precoVenda = moedaParaNumero(p.precoVenda);
    const custoDireto = moedaParaNumero(p.custoR);

    const impostoReais = precoVenda * (impostoPerc / 100);
    const comissaoReais = precoVenda * (comissaoPerc / 100);
    const cartaoReais = precoVenda * (cartaoPerc / 100);
    const outrosReais = precoVenda * (outrosPerc / 100);

    const custoVariavelUnitario = custoDireto + impostoReais + comissaoReais + cartaoReais + outrosReais;

    let linha = `<tr><td><strong>${p.nome}</strong></td>`;
    
    for (let mes = 0; mes < 12; mes++) {
      const input = document.querySelector(`.vendaMes[data-index="${i}"][data-mes="${mes}"]`);
      const quantidadeMes = parseInt(input?.value || 0);

      const receitaMes = precoVenda * quantidadeMes;
      const custoMes = custoVariavelUnitario * quantidadeMes;
      const margemMes = receitaMes - custoMes;

      receitaAnoTotal += receitaMes;
      margemAnoTotal += margemMes;

      linha += `<td style="padding: 8px 12px;">${numeroParaMoeda(margemMes)}</td>`;
    }

    linha += `</tr>`;
    container.innerHTML += linha;
  });

  document.getElementById("margem-ano").innerText = numeroParaMoeda(margemAnoTotal);

  return {
    receitaAno: receitaAnoTotal,
    margemAno: margemAnoTotal,
    custoVariavelUnitario: 0 // este dado n√£o √© mais √∫nico, pois √© calculado por produto
  };
}
function atualizarPontoEquilibrio() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const numeroParaMoeda = num => num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  // üìå 1. Captura os valores principais
  const custoFixo = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");
  const receitaAnual = moedaParaNumero(document.getElementById("receita_anual")?.value || "0");
  const margemAno = moedaParaNumero(document.getElementById("margem-ano")?.innerText || "0");

  // üìå 2. Total de unidades vendidas no ano
  let totalUnidades = 0;
  document.querySelectorAll(".vendaMes").forEach(input => {
    const qtd = parseInt(input.value || "0");
    totalUnidades += qtd;
  });

  // üìå 3. Margem percentual (sobre receita) e margem unit√°ria m√©dia
  const margemPercentual = receitaAnual > 0 ? (margemAno / receitaAnual) : 0;
  const margemUnitariaMedia = totalUnidades > 0 ? (margemAno / totalUnidades) : 0;

  // üìå 4. C√°lculo do ponto de equil√≠brio
  const receitaNecessaria = margemPercentual > 0 ? (custoFixo / margemPercentual) : 0;
  const quantidadeNecessaria = margemUnitariaMedia > 0 ? (custoFixo / margemUnitariaMedia) : 0;

   // üîç C√°lculo do Ponto de Equil√≠brio por Produto
  const containerPEQ = document.getElementById("peq_individual");
  if (!containerPEQ) return;

  containerPEQ.innerHTML = "";
  let totalPEPonderado = 0;
  let pesoTotal = 0;

  produtos.forEach((p) => {
    const preco = moedaParaNumero(p.precoVenda);
    const custo = moedaParaNumero(p.custoR);

    const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

    const impostos = preco * (impostoPerc / 100);
    const comissao = preco * (comissaoPerc / 100);
    const cartao = preco * (cartaoPerc / 100);
    const outros = preco * (outrosPerc / 100);

    const margemUnit = preco - (custo + impostos + comissao + cartao + outros);
    const peqIndividual = margemUnit > 0 ? custoFixo / margemUnit : 0;

    totalPEPonderado += peqIndividual * margemUnit;
    pesoTotal += margemUnit;

    containerPEQ.innerHTML += `
      <div style="margin-bottom: 6px;">
        <strong>${p.nome}</strong>: ${Math.ceil(peqIndividual)} und (Margem: R$ ${margemUnit.toFixed(2).replace('.', ',')})
      </div>
    `;
  });

  if (pesoTotal > 0) {
    const mediaPonderada = totalPEPonderado / pesoTotal;
    containerPEQ.innerHTML += `
      <div style="margin-top:10px;"><strong style="color:#fff;">M√©dia Ponderada do Ponto de Equil√≠brio:</strong> ${Math.ceil(mediaPonderada)} unidades</div>
    `;
  }
  atualizarReceitaEquilibrioPorProduto();

}
function atualizarReceitaEquilibrioPorProduto() {
  const container = document.getElementById("peq_individual");
  if (!container) return;

  const custoFixo = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");

  container.innerHTML += `<h4 style="color:#fff; margin-top: 25px;">7.4 Receita no Ponto de Equil√≠brio (por Produto)</h4>`;

  let somaPrecoMargem = 0;
  let somaPEPonderado = 0;
  let pesoTotal = 0;

  produtos.forEach((p) => {
    const preco = moedaParaNumero(p.precoVenda);
    const custo = moedaParaNumero(p.custoR);

    const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

    const impostos = preco * (impostoPerc / 100);
    const comissao = preco * (comissaoPerc / 100);
    const cartao = preco * (cartaoPerc / 100);
    const outros = preco * (outrosPerc / 100);

    const margemUnit = preco - (custo + impostos + comissao + cartao + outros);
    const peqIndividual = margemUnit > 0 ? custoFixo / margemUnit : 0;
    const receitaPE = preco * peqIndividual;

    somaPrecoMargem += preco * margemUnit;              // (P √ó M)
    somaPEPonderado += peqIndividual * margemUnit;      // (PE √ó M)
    pesoTotal += margemUnit;                            // M

    container.innerHTML += `
      <div style="margin-bottom: 5px; font-size: 15px;">
  <strong>${p.nome}</strong> ‚Äì Receita no PE: R$ ${receitaPE.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}
</div>
    `;
  });

 if (pesoTotal > 0) {
    const precoMedioPonderado = somaPrecoMargem / pesoTotal;
    const peMedioPonderado = somaPEPonderado / pesoTotal;
    const receitaPonderada = precoMedioPonderado * peMedioPonderado;
    container.innerHTML += `
     <div style="margin-top:10px;">
  <strong style="color:#fff;">Receita no Ponto de Equil√≠brio (M√©dia Ponderada):</strong> R$ ${receitaPonderada.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}
</div>
    `;
  }
}
function calcularIndicadoresFinanceiros() {
  const container = document.getElementById("calculoIndicadores");
  if (!container) return;

  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
  const numeroParaMoeda = num => num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  const investimentoInicial = moedaParaNumero(document.getElementById("investimento_inicial")?.value || "0");
  const custosFixosMensal = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");

  const inflacao = moedaParaNumero(document.getElementById("taxa_inflacao")?.value || "0") / 100;
  const oportunidade = moedaParaNumero(document.getElementById("taxa_oportunidade")?.value || "0") / 100;
  const retorno = moedaParaNumero(document.getElementById("taxa_esperada")?.value || "0") / 100;

  const taxaAnual = (1 + inflacao) * (1 + oportunidade) * (1 + retorno) - 1;
  const taxaMensal = Math.pow(1 + taxaAnual, 1 / 12) - 1;

  const { impostoPerc, comissaoPerc, cartaoPerc, outrosPerc } = obterCustosVariaveisEtapa02();

  let lucroTotal = 0;
  let receitaTotal = 0;
  let totalMargemContribuicao = 0;

  produtos.forEach((produto, index) => {
    const precoVenda = moedaParaNumero(produto.precoVenda);
    const custoDireto = moedaParaNumero(produto.custoR);

    let totalVendida = 0;
    for (let m = 0; m < 12; m++) {
      const input = document.querySelector(`.vendaMes[data-index='${index}'][data-mes='${m}']`);
      if (input) totalVendida += parseInt(input.value || 0);
    }

    const impostos = precoVenda * (impostoPerc / 100);
    const comissao = precoVenda * (comissaoPerc / 100);
    const cartao = precoVenda * (cartaoPerc / 100);
    const outros = precoVenda * (outrosPerc / 100);

    const margemUnit = precoVenda - (custoDireto + impostos + comissao + cartao + outros);

    receitaTotal += precoVenda * totalVendida;
    lucroTotal += margemUnit * totalVendida;
    totalMargemContribuicao += margemUnit * totalVendida;
  });

  const lucroMensal = lucroTotal / 12;
  const receitaMensal = receitaTotal / 12;

  const roi = investimentoInicial > 0 ? lucroTotal / investimentoInicial : 0;
  const paybackSimples = lucroMensal > 0 ? investimentoInicial / lucroMensal : 0;

  let vpl = -investimentoInicial;
  let vpAcumulado = 0;
  let paybackDescontado = 12;

  for (let t = 1; t <= 12; t++) {
    const fluxo = lucroMensal / Math.pow(1 + taxaMensal, t);
    vpl += fluxo;
    vpAcumulado += fluxo;
    if (vpAcumulado >= investimentoInicial && paybackDescontado === 12) {
      paybackDescontado = t;
    }
  }

  function calcularTIR(fluxos, guess = 0.1) {
    let tir = guess;
    for (let i = 0; i < 100; i++) {
      let f = 0, df = 0;
      for (let t = 0; t < fluxos.length; t++) {
        f += fluxos[t] / Math.pow(1 + tir, t);
        df += -t * fluxos[t] / Math.pow(1 + tir, t + 1);
      }
      const tirNova = tir - f / df;
      if (Math.abs(tirNova - tir) < 1e-6) break;
      tir = tirNova;
    }
    return tir;
  }

  const fluxoCompleto = [-investimentoInicial];
  for (let i = 0; i < 12; i++) fluxoCompleto.push(lucroMensal);

  const tirMensal = calcularTIR(fluxoCompleto);
  const tirAnual = Math.pow(1 + tirMensal, 12) - 1;

  const margemSeguranca = receitaTotal > 0 ? 1 - ((custosFixosMensal * 12) / receitaTotal) : 0;
  const il = investimentoInicial > 0 ? lucroTotal / investimentoInicial : 0;

  if (investimentoInicial > 0) {
    container.innerHTML = `
      <div style="margin-top: 20px; font-size: 15px;">
        <div><strong>ROI:</strong> ${(roi * 100).toFixed(2)}%</div>
        <div><strong>Payback Simples:</strong> ${paybackSimples.toFixed(2)} meses</div>
        <div><strong>Payback Descontado:</strong> ${paybackDescontado} meses</div>
        <div><strong>VPL:</strong> ${numeroParaMoeda(vpl)}</div>
        <div><strong>TIR:</strong> ${(tirAnual * 100).toFixed(2)}%</div>
        <div><strong>Margem de Seguran√ßa:</strong> ${(margemSeguranca * 100).toFixed(2)}%</div>
        <div><strong>√çndice de Lucratividade (IL):</strong> ${il.toFixed(2)}</div>
      </div>
    `;
  }
}


</script>


 <!-- Etapa 5 -->
  <div class="step" id="step5">
  <h2>An√°lise Final</h2>
  <table>
    <thead>
      <tr><th>Item</th><th>Status (Sim/N√£o)</th></tr>
    </thead>
    <tbody>
      <tr><td>Receita cobre os custos fixos?</td><td id="check_receita"></td></tr>
      <tr><td>Projeto tem ROI acima de 20%?</td><td id="check_roi"></td></tr>
      <tr><td>Payback abaixo de 12 meses?</td><td id="check_payback"></td></tr>
      <tr><td>Fluxo de caixa positivo nos 6 primeiros meses?</td><td id="check_fluxo"></td></tr>
    </tbody>
  </table>
  <div class="form-group col-100">
    <label for="avaliacao_final">Avalia√ß√£o de Viabilidade Econ√¥mica:</label>
    <select id="avaliacao_final">
      <option value="">Selecione...</option>
      <option>Vi√°vel com Alta Rentabilidade</option>
      <option>Vi√°vel com Ajustes</option>
      <option>Pouco Vi√°vel no Momento</option>
      <option>N√£o Recomendado</option>
    </select>
  </div>

  <div class="form-group col-100" style="margin-top: 20px; text-align: center;">
    <button type="button" onclick="gerarPDFPersonalizado()" style="background-color:#00bcd4; color:#fff; border:none; padding:10px 20px; border-radius:6px; font-size:16px; cursor:pointer;">
      üìÑ Gerar Relat√≥rio em PDF
    </button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function carregarImagemBase64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
  
}
// 1. Atualiza visual e dados do checklist
function atualizarChecklistAnalise() {
  const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;

  const receitaMensal = moedaParaNumero(document.getElementById("receita_mensal")?.value || "0");
  const receitaAnual = moedaParaNumero(document.getElementById("receita_anual")?.value || "0");
  const custosFixosMensal = moedaParaNumero(document.getElementById("custos_fixos_total")?.value || "0");
  const investimentoInicial = moedaParaNumero(document.getElementById("investimento_inicial")?.value || "0");
  const lucroMensal = receitaMensal - custosFixosMensal;

const roi = parseFloat(document.getElementById("ROI")?.value.replace('%','').replace(',', '.') || "0");
const payback = parseFloat(document.getElementById("paybackSimples")?.value.replace(',', '.') || "0");
const tir = parseFloat(document.getElementById("tirAnual")?.value.replace('%','').replace(',', '.') || "0");
const margemSeguranca = parseFloat(document.getElementById("margemSeguranca")?.value.replace('%','').replace(',', '.') || "0");

  document.getElementById("check_receita").textContent = receitaMensal >= custosFixosMensal ? "Sim" : "N√£o";
  document.getElementById("check_roi").textContent = roi >= 20 ? "Sim" : "N√£o";
  document.getElementById("check_payback").textContent = payback > 0 && payback <= 12 ? "Sim" : "N√£o";
  document.getElementById("check_fluxo").textContent = lucroMensal > 0 ? "Sim" : "N√£o";
  document.getElementById("check_tir").textContent = tir >= 20 ? "Sim" : "N√£o";
  document.getElementById("check_margem").textContent = margemSeguranca >= 20 ? "Sim" : "N√£o";
 
}
 document.addEventListener("input", atualizarChecklistAnalise);
// 2. Atualiza visual da Etapa 05 (substituir no HTML)
// <tr><td>TIR acima de 20%?</td><td id="check_tir"></td></tr>
// <tr><td>Margem de Seguran√ßa acima de 20%?</td><td id="check_margem"></td></tr>

// 3. PDF SUPER COMPLETO
async function gerarPDFPersonalizado() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const imgBase64 = await carregarImagemBase64('./img/layout_canva.png');
  const margem = 15;

  doc.addImage(imgBase64, 'PNG', 0, 0, 210, 297);

  let y = 30;
  doc.setFontSize(18);
  doc.setTextColor(1, 10, 40);
  doc.setFont('helvetica', 'bold');
  doc.text('Relat√≥rio de Viabilidade Econ√¥mica', 15, y);
  y += 10;

  doc.setFontSize(14);
  doc.setTextColor(0);
  doc.setFont('helvetica', 'bold');
  doc.text(`Projeto: ${document.getElementById('nome').value}`, 15, y);
  y += 8;

  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('Dados Gerais:', 15, y);
  y += 6;

  doc.setFont('helvetica', 'normal');
  const dados = [
    ['Nome do Projeto', 'nome'],
    ['Estado', 'estado'],
    ['Tipo de Atividade', 'tipo'],
    ['Cidade/Estado', 'cidade'],
    ['Estrutura', 'estrutura'],
    ['Regime Tribut√°rio', 'regime'],
    ['Situa√ß√£o Atual', 'situacao'],
    ['Respons√°vel', 'responsavel'],
    ['E-mail', 'email'],
    ['Telefone', 'telefone']
  ];
  dados.forEach(([label, id]) => {
    doc.text(`${label}: ${document.getElementById(id).value}`, 15, y);
    y += 6;
  });

  y += 4;
  doc.setFont('helvetica', 'bold');
  doc.text('Indicadores Financeiros:', 15, y);
  y += 6;
  doc.setFont('helvetica', 'normal');

  const indicadores = [
  ['Receita Mensal', 'receita_mensal'],
  ['Receita Anual', 'receita_anual'],
  ['Custos Fixos Totais', 'custos_fixos_total'],
  ['Investimento Inicial', 'investimento_inicial'],
    ];


  indicadores.forEach(([label, id]) => {
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
    doc.text(`${label}: ${document.getElementById(id).value}`, 15, y);
    y += 6;
  });

  y += 6;
  doc.setFont('helvetica', 'bold');
  doc.text('Checklist de Viabilidade:', 15, y);
  y += 6;
  doc.setFont('helvetica', 'normal');

const roi = parseFloat(document.getElementById("roi")?.value.replace('%', '').replace(',', '.') || "0");
const paybackSimples = parseFloat(document.getElementById("paybackSimples")?.value.replace(',', '.') || "0");
const paybackDesc = parseFloat(document.getElementById("paybackDescontado")?.value.replace(',', '.') || "0");
const tirAnual = parseFloat(document.getElementById("tirAnual")?.value.replace('%', '').replace(',', '.') || "0");
const margemSeguranca = parseFloat(document.getElementById("margemSeguranca")?.value.replace('%', '').replace(',', '.') || "0");
const il = parseFloat(document.getElementById("il")?.value.replace('%', '').replace(',', '.') || "0");
const vpl = parseFloat(document.getElementById("vpl")?.value.replace(/\./g, '').replace(',', '.') || "0");
const margemContribuicaoTotal = parseFloat(document.getElementById("totalMargemContribuicao")?.innerText.replace("R$", "").replace(/\./g, "").replace(",", ".") || "0");

const indicadoresCalculados = [
  ['ROI', `${(roi * 100).toFixed(2)}%`],
  ['Payback Simples', `${paybackSimples.toFixed(1)} meses`],
  ['TIR', `${(tirAnual * 100).toFixed(2)}%`],
  ['VPL', `R$ ${vpl.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`],
  ['Margem de Seguran√ßa', `${margemSeguranca.toFixed(2)}%`],
  ['√çndice de Lucratividade (IL)', `${il.toFixed(2)}%`]
];

indicadoresCalculados.forEach(([label, valor]) => {
  if (y > 280) {
    doc.addPage();
    y = 10;
  }
  doc.text(`${label}: ${valor}`, 15, y);
  y += 6;
});

  const checklist = [
    ['Receita cobre os custos fixos?', 'check_receita'],
    ['Projeto tem ROI acima de 20%?', 'check_roi'],
    ['Payback abaixo de 12 meses?', 'check_payback'],
    ['Fluxo de caixa positivo nos 6 primeiros meses?', 'check_fluxo']
  ];
  checklist.forEach(([label, id]) => {
    doc.text(`${label}: ${document.getElementById(id).textContent}`, 15, y);
    y += 6;
  });

  y += 6;
  doc.setFont('helvetica', 'bold');
  doc.text(`Avalia√ß√£o Final: ${document.getElementById('avaliacao_final').value}`, 15, y);
  
  const novaPagina = () => {
    doc.addPage();
    y = 20;
  };

  const escreveLinha = (titulo, valor) => {
    doc.setFont('helvetica', 'bold');
    doc.text(`${titulo}:`, margem, y);
    doc.setFont('helvetica', 'normal');
    doc.text(valor || '-', margem + 60, y);
    y += 8;
  };

  // P√°gina 01 - Dados Gerais
  doc.setFontSize(18);
doc.setFont('helvetica', 'bold');
doc.text('Dados da Empresa', margem, y);
y += 8;
  escreveLinha('Projeto', document.getElementById('nome').value);
  escreveLinha('Respons√°vel', document.getElementById('responsavel').value);
  escreveLinha('E-mail', document.getElementById('email').value);
  escreveLinha('Telefone', document.getElementById('telefone').value);
  escreveLinha('Tipo', document.getElementById('tipo').value);
  escreveLinha('Estado', document.getElementById('estado').value);
  escreveLinha('Cidade', document.getElementById('cidade').value);
  novaPagina();

  // P√°gina 02 - Produtos e Custos
  doc.setFontSize(18);
  doc.text('2. Produtos, Custos e Taxas', margem, y);
  y += 10;
  produtos.forEach(p => {
    escreveLinha(`Produto`, p.nome);
    escreveLinha(`Custo`, p.custoR);
    escreveLinha(`Pre√ßo Venda`, p.precoVenda);
    y += 5;
  });
  escreveLinha('Custos Fixos Mensais', document.getElementById('custos_fixos_total').value);
  escreveLinha('Investimento Inicial', document.getElementById('investimento_inicial').value);
  novaPagina();

  // P√°gina 03 - Receita Anual + Totais
  doc.setFontSize(18);
  doc.text('3. Receita e Totais', margem, y);
  y += 10;
  escreveLinha('Receita Mensal', document.getElementById('receita_mensal').value);
  escreveLinha('Receita Anual', document.getElementById('receita_anual').value);
  escreveLinha('Custos Vari√°veis Total (R$)', document.getElementById('custo_variavel_total_rs')?.value);
  novaPagina();

  // P√°gina 04 - Indicadores
  doc.setFontSize(18);
  doc.text('4. Indicadores Financeiros', margem, y);
  y += 10;
  doc.setFontSize(12);
  doc.text(document.getElementById("calculoIndicadores")?.innerText || 'Indicadores n√£o calculados.', margem, y);
  y += 60;

  
  doc.setFontSize(11);
  doc.text('5. Interpreta√ß√£o dos Indicadores', margem, y);
  y += 10;

  const textoResumo = [];
  const condicaoRuim = roi < 0.2 || payback > 12 || tir < 0.2 || margemSeg < 0.2 || il < 1;

  if (!condicaoRuim) {
    textoResumo.push(
     `Com base nos dados informados, o projeto apresenta um Retorno sobre Investimento (ROI) de ${(roi * 100).toFixed(2)}%,`,
    `o que indica que, ao final do per√≠odo analisado, o capital investido retornaria com um lucro de apenas ${(roi * 100).toFixed(2)}% sobre o valor aportado.`,
    `Esse retorno est√° abaixo do esperado para projetos de perfil semelhante, o que pode comprometer sua atratividade frente a outras op√ß√µes de investimento.`,

    ``,
    `O Payback Simples estimado √© de ${paybackSimples.toFixed(2)} meses, representando o tempo necess√°rio para recuperar integralmente o capital investido.`,
    `Esse prazo √© relativamente elevado, o que aumenta a exposi√ß√£o ao risco e pode afetar a tomada de decis√£o por parte de investidores.`,
    `J√° o Payback Descontado, que considera o valor do dinheiro no tempo, foi calculado em ${paybackDesc.toFixed(2)} meses,`,
    `refor√ßando a necessidade de ajustes no modelo para acelerar a recupera√ß√£o do investimento.`,

    ``,
    `A Taxa Interna de Retorno (TIR) anual foi de ${(tirAnual * 100).toFixed(2)}%, abaixo do patamar m√≠nimo normalmente exigido por investidores para projetos com riscos operacionais e financeiros similares.`,
    `Esse resultado indica uma rentabilidade limitada e sugere que, da forma atual, o projeto pode n√£o ser a melhor op√ß√£o de aloca√ß√£o de capital.`,

    ``,
    `A Margem de Contribui√ß√£o, que expressa o quanto sobra do pre√ßo de venda ap√≥s os custos vari√°veis, ficou em R$ ${margemContribuicaoTotal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")}.`,
    `Esse valor ainda √© positivo, por√©m pode n√£o ser suficiente para cobrir os custos fixos de maneira confort√°vel, afetando a gera√ß√£o de lucro operacional.`,

    ``,
    `A Margem de Seguran√ßa, calculada em ${(margemSeguranca * 100).toFixed(2)}%, est√° abaixo do ideal, indicando que qualquer oscila√ß√£o negativa nas vendas`,
    `pode levar rapidamente o projeto ao ponto de equil√≠brio ou at√© mesmo ao preju√≠zo, exigindo aten√ß√£o redobrada na execu√ß√£o comercial.`,

    ``,
    `O √çndice de Lucratividade (IL), de ${il.toFixed(2)}, significa que a cada R$ 1,00 investido, o retorno l√≠quido estimado √© de apenas R$ ${il.toFixed(2)}.`,
    `Esse indicador sugere que o capital empregado poderia ter maior rendimento se direcionado a outras iniciativas mais eficientes financeiramente.`
    );
  } else {
    textoResumo.push(
     `Com base nos dados informados, o projeto apresenta um Retorno sobre Investimento (ROI) de ${(roi * 100).toFixed(2)}%,`,
    `o que significa que, ao final do per√≠odo analisado, espera-se que o capital investido retorne com um lucro de ${(roi * 100).toFixed(2)}% sobre o valor inicialmente aportado.`,
    `Esse √≠ndice √© um forte indicativo de atratividade, especialmente quando comparado a outras op√ß√µes do mercado com riscos semelhantes.`,

    ``,
    `O Payback Simples estimado √© de ${paybackSimples.toFixed(2)} meses, representando o tempo necess√°rio para que todo o investimento inicial`,
    `seja recuperado a partir dos lucros gerados. Trata-se de um prazo competitivo, que contribui positivamente para a percep√ß√£o de risco e retorno.`,
    `O Payback Descontado, que considera o valor do dinheiro no tempo, foi calculado em ${paybackDesc.toFixed(2)} meses,`,
    `demonstrando que o projeto ainda assim se mant√©m rent√°vel mesmo sob condi√ß√µes financeiras mais exigentes.`,

    ``,
    `A Taxa Interna de Retorno (TIR) anual atingiu ${(tirAnual * 100).toFixed(2)}%, superando amplamente as expectativas m√≠nimas de retorno de muitos investidores`,
    `e sinalizando que o projeto possui uma excelente capacidade de gera√ß√£o de valor financeiro ao longo do tempo.`,

    ``,
    `Outro ponto relevante √© a Margem de Contribui√ß√£o, que representa a diferen√ßa entre o pre√ßo de venda e os custos vari√°veis unit√°rios.`,
    `Com uma margem de contribui√ß√£o total de R$ ${margemContribuicaoTotal.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".")},`,
    `o projeto demonstra capacidade de cobrir seus custos fixos e ainda gerar resultado operacional.`,

    ``,
    `A Margem de Seguran√ßa, atualmente em ${(margemSeguranca * 100).toFixed(2)}%, mostra que o projeto possui uma folga em rela√ß√£o √† sua receita projetada.`,
    `Mesmo que ocorra uma queda no volume de vendas, existe margem suficiente para que o ponto de equil√≠brio n√£o seja atingido de imediato.`,

    ``,
    `Por fim, o √çndice de Lucratividade (IL) calculado em ${il.toFixed(2)} indica que, para cada R$ 1,00 investido,`,
    `o projeto tende a gerar R$ ${il.toFixed(2)} de retorno l√≠quido. Esse indicador refor√ßa a efici√™ncia do capital investido e permite compara√ß√µes diretas`,
    `com outras oportunidades no portf√≥lio empresarial.`
    );
  }

  textoResumo.forEach(paragrafo => {
    if (y > 270) {
      novaPagina();
      doc.setFontSize(11);
    }
    doc.text(paragrafo, margem, y);
    y += 6;
  });


  doc.save('Relatorio_Viabilidade_Economica.pdf');
}



</script>
 

  <div class="buttons" id="navigationButtons"></div>
  </form> <!-- Fechamento correto do formul√°rio -->
</div> 
  <script>
    function renderButtons(currentStep) {
      const container = document.getElementById('navigationButtons');
      container.innerHTML = '';

      const limpar = document.createElement('button');
      limpar.textContent = 'Limpar';
      limpar.type = 'button';
      limpar.onclick = limparCamposEtapa;
      container.appendChild(limpar);

      if (currentStep > 0) {
        const voltar = document.createElement('button');
        voltar.textContent = 'Voltar';
        voltar.type = 'button';
        voltar.onclick = prevStep;
        container.appendChild(voltar);
      }

      if (currentStep < document.querySelectorAll('.step').length - 1) {
        const proximo = document.createElement('button');
        proximo.textContent = 'Pr√≥ximo';
        proximo.type = 'button';
        proximo.onclick = nextStep;
        container.appendChild(proximo);
      }
    }

   function nextStep() {
  const steps = document.querySelectorAll(".step");

  for (let i = 0; i < steps.length; i++) {
    if (steps[i].classList.contains("active")) {

      // Valida√ß√£o apenas da Etapa 1 em diante
      if (i !== 0) {
        const requiredInputs = steps[i].querySelectorAll("input[required], select[required]");
        for (let j = 0; j < requiredInputs.length; j++) {
          if (!requiredInputs[j].value) {
            alert("Por favor, preencha todos os campos obrigat√≥rios antes de continuar.");
            return;
          }
        }
      }

      // Remove a etapa atual
      steps[i].classList.remove("active");

      // Ativa a pr√≥xima etapa
      if (steps[i + 1]) {
        steps[i + 1].classList.add("active");
        renderButtons(i + 1);

        // ‚úÖ Etapa 03 ‚Äì Executa os c√°lculos dos produtos
        if (steps[i + 1].id === 'step3') {
          atualizarReceitaProdutos();
          atualizarCenariosProdutos();
          calcularCustosVariaveisEmReais();
          atualizarCustosFixosEVariaveis();
          
        }

        if (steps[i + 1].id === 'step4') {
  if (produtos && produtos.length > 0) {
    setTimeout(() => {
      atualizarMargemUnit√°riaTotal();
      atualizarMargemUnit√°riaPorProduto();
      atualizarMargemMensalPorProduto();
      atualizarPontoEquilibrio(); 
      calcularIndicadoresFinanceiros(); // j√° chama atualizarReceitaEquilibrioPorProduto() internamente
    }, 100); // Pequeno delay para garantir DOM renderizado
  } else {
    console.warn("Lista de produtos est√° vazia ao entrar na Etapa 04.");
  }
}
      }
      break;
    }
  }
}
    function prevStep() {
      const steps = document.querySelectorAll(".step");
      for (let i = 0; i < steps.length; i++) {
        if (steps[i].classList.contains("active")) {
          steps[i].classList.remove("active");
          if (i - 1 >= 0) {
            steps[i - 1].classList.add("active");
            renderButtons(i - 1);
          }
          break;
        }
      }
    }

    function limparCamposEtapa() {
      const etapaAtual = document.querySelector('.step.active');
      const inputs = etapaAtual.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="tel"], textarea, select');

      inputs.forEach(input => {
        if (input.tagName.toLowerCase() === 'select') {
          input.selectedIndex = 0;
        } else {
          input.value = '';
        }
      });
    }

    window.onload = () => {
      renderButtons(0);
  // Bloqueia letras em campos num√©ricos
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function () {
      this.value = this.value.replace(/[^0-9]/g, '');
    });
  });
};
    
    document.addEventListener("input", function(e) {
      if (e.target.classList.contains("currency")) {
        let value = e.target.value.replace(/\D/g, "");
        value = (parseInt(value, 10) / 100).toFixed(2);
        e.target.value = value.replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      }

      // Etapa 3 c√°lculo autom√°tico
      const moedaParaNumero = str => parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
      const numeroParaMoeda = num => "R$ " + num
  .toFixed(2)
  .replace('.', ',')
  .replace(/\B(?=(\d{3})+(?!\d))/g, ".");

      const preco = moedaParaNumero(document.getElementById('preco_unitario').value);
      const qtd = parseInt(document.getElementById('quantidade_mensal').value) || 0;
      const receitaMensal = preco * qtd;
      document.getElementById('receita_mensal').value = numeroParaMoeda(receitaMensal);
      document.getElementById('receita_anual').value = numeroParaMoeda(receitaMensal * 12);

      let fixos = 0, variaveis = 0;
      document.querySelectorAll('#camposEspecificos h3').forEach(h3 => {
  const categoria = h3.textContent.trim().toLowerCase();
  let soma = 0;

  let elementoAtual = h3.nextElementSibling;
  while (elementoAtual && elementoAtual.tagName !== 'H3') {
    const input = elementoAtual.querySelector('input');
    if (input) soma += moedaParaNumero(input.value);
    elementoAtual = elementoAtual.nextElementSibling;
  }

  if (categoria.includes('fixos')) fixos += soma;
  if (categoria.includes('vari√°veis')) variaveis += soma;
});




      
    });
     

    function numeroParaMoeda(num) {
      return num.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
  
  </script>
<script>
function moedaParaNumero(str) {
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }
// M√°scara para moeda (R$)
document.querySelectorAll('input.currency[placeholder="R$"]').forEach(input => {
  input.addEventListener('input', () => {
    let val = input.value.replace(/\D/g, '');
    val = (parseInt(val) / 100).toFixed(2) + '';
    val = val.replace('.', ',');
    val = val.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    input.value = 'R$ ' + val;
  });
});
// Atualiza o c√°lculo dos custos vari√°veis em R$ sempre que um input da etapa 2 for alterado
document.querySelectorAll("#step2 input").forEach(input => {
  input.addEventListener("input", () => {
    calcularCustosVariaveisEmReais();
  });
});
// Corrige comportamento da m√°scara de percentual (%)
document.querySelectorAll('input.percent').forEach(input => {
  input.addEventListener('input', () => {
    let raw = input.value.replace(/\D/g, '');
    if (raw === '') {
      input.value = '';
      return;
    }

    let valor;

    if (raw.length <= 2) {
      valor = (parseInt(raw) / 10).toFixed(1).replace('.', ',');
    } else {
      valor = (parseInt(raw) / 100).toFixed(2).replace('.', ',');
        }
    input.value = valor;
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === "Backspace") {
      let val = input.value.replace(/\D/g, '');
      val = val.slice(0, -1);
      if (val === '') {
        input.value = '';
        e.preventDefault();
      }
    }
  });

  input.addEventListener('blur', () => {
    if (!input.value.includes('%') && input.value !== '') {
      input.value += '%';
    }
  });
});

</script>
<script>
  ["input", "change"].forEach(evt =>
    document.addEventListener(evt, () => {
      setTimeout(() => {
        atualizarCustosFixosEVariaveis
        atualizarMargemUnit√°riaTotal();
        atualizarMargemUnit√°riaPorProduto();
        obterCustosVariaveisEtapa02();
        atualizarMargemMensalPorProduto();
        atualizarPontoEquilibrio();

      }, 100);
    })
  );
</script>
</body>
</html>
